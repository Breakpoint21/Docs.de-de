---
uid: aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
title: Owin-OAuth 2.0-Autorisierungsserver | Microsoft Docs
author: hongyes
description: "Dieses Lernprogramm führt Sie zum Implementieren von einem OAuth 2.0-Autorisierungsserver mithilfe von OAuth OWIN-Middleware. Dies ist ein erweitertes Lernprogramm, nur Outlin..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 03/20/2014
ms.topic: article
ms.assetid: 20acee16-c70c-41e9-b38f-92bfcf9a4c1c
ms.technology: 
ms.prod: .net-framework
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
msc.type: authoredcontent
ms.openlocfilehash: 8842f57df84d841df77b34e9645dbf4909f82d85
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 11/10/2017
---
<a name="owin-oauth-20-authorization-server"></a><span data-ttu-id="6dba5-104">Owin-OAuth 2.0-Autorisierungsserver</span><span class="sxs-lookup"><span data-stu-id="6dba5-104">OWIN OAuth 2.0 Authorization Server</span></span>
====================
<span data-ttu-id="6dba5-105">durch [Hongye Sun](https://github.com/hongyes), [Praburaj Thiagarajan](https://github.com/Praburaj), [Rick Anderson](https://github.com/Rick-Anderson)</span><span class="sxs-lookup"><span data-stu-id="6dba5-105">by [Hongye Sun](https://github.com/hongyes), [Praburaj Thiagarajan](https://github.com/Praburaj), [Rick Anderson](https://github.com/Rick-Anderson)</span></span>

> <span data-ttu-id="6dba5-106">Dieses Lernprogramm führt Sie zum Implementieren von einem OAuth 2.0-Autorisierungsserver mithilfe von OAuth OWIN-Middleware.</span><span class="sxs-lookup"><span data-stu-id="6dba5-106">This tutorial will guide you on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span> <span data-ttu-id="6dba5-107">Dies ist eine erweiterte Lernprogramm, in dem nur die Schritte zum Erstellen einer owin-OAuth 2.0 Authorization-Server werden erläutert.</span><span class="sxs-lookup"><span data-stu-id="6dba5-107">This is an advanced tutorial that only outlines the steps to create an OWIN OAuth 2.0 Authorization Server.</span></span> <span data-ttu-id="6dba5-108">Dies ist kein Schritt-für-Schritt-Tutorial.</span><span class="sxs-lookup"><span data-stu-id="6dba5-108">This is not a step by step tutorial.</span></span> <span data-ttu-id="6dba5-109">[Herunterladen den Beispielcode](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span><span class="sxs-lookup"><span data-stu-id="6dba5-109">[Download the sample code](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span></span>
> 
> > [!NOTE]
> > <span data-ttu-id="6dba5-110">Dieser Umriss sollte nicht vorgesehen, zum Erstellen einer sicheren Produktions-app verwendet werden soll.</span><span class="sxs-lookup"><span data-stu-id="6dba5-110">This outline should not be intended to be used for creating a secure production app.</span></span> <span data-ttu-id="6dba5-111">Dieses Lernprogramm richtet sich nur einen Umriss zum Implementieren von einem OAuth 2.0-Autorisierungsserver mithilfe von OAuth OWIN-Middleware bereitgestellt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-111">This tutorial is intended to provide only an outline on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span>
> 
> 
> ## <a name="software-versions"></a><span data-ttu-id="6dba5-112">Versionen der Software</span><span class="sxs-lookup"><span data-stu-id="6dba5-112">Software versions</span></span>
> 
> | <span data-ttu-id="6dba5-113">**In diesem Lernprogramm gezeigt**</span><span class="sxs-lookup"><span data-stu-id="6dba5-113">**Shown in the tutorial**</span></span> | <span data-ttu-id="6dba5-114">**Funktioniert auch mit**</span><span class="sxs-lookup"><span data-stu-id="6dba5-114">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="6dba5-115">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="6dba5-115">Windows 8.1</span></span> | <span data-ttu-id="6dba5-116">Windows 8, Windows 7</span><span class="sxs-lookup"><span data-stu-id="6dba5-116">Windows 8, Windows 7</span></span> |
> | [<span data-ttu-id="6dba5-117">Visual Studio 2013</span><span class="sxs-lookup"><span data-stu-id="6dba5-117">Visual Studio 2013</span></span>](https://www.microsoft.com/visualstudio/eng/2013-downloads) | <span data-ttu-id="6dba5-118">[Visual Studio 2013 Express für Desktop](https://www.microsoft.com/visualstudio/eng/2013-downloads#d-2013-express).</span><span class="sxs-lookup"><span data-stu-id="6dba5-118">[Visual Studio 2013 Express for Desktop](https://www.microsoft.com/visualstudio/eng/2013-downloads#d-2013-express).</span></span> <span data-ttu-id="6dba5-119">Visual Studio 2012 mit dem aktuellen Update sollte funktionieren, aber im Lernprogramm wurde nicht mit getestet, und einige Menüs und Dialogfelder unterscheiden sich.</span><span class="sxs-lookup"><span data-stu-id="6dba5-119">Visual Studio 2012 with the latest update should work, but the tutorial has not been tested with it, and some menu selections and dialog boxes are different.</span></span> |
> | <span data-ttu-id="6dba5-120">.NET 4.5</span><span class="sxs-lookup"><span data-stu-id="6dba5-120">.NET 4.5</span></span> |  |
> 
> ## <a name="questions-and-comments"></a><span data-ttu-id="6dba5-121">Fragen und Kommentare</span><span class="sxs-lookup"><span data-stu-id="6dba5-121">Questions and Comments</span></span>
> 
> <span data-ttu-id="6dba5-122">Wenn Sie Fragen, die nicht direkt mit dem Lernprogramm verknüpft sind haben, können Sie sie unter post [Katana-Projekt auf GitHub](https://github.com/aspnet/AspNetKatana/).</span><span class="sxs-lookup"><span data-stu-id="6dba5-122">If you have questions that are not directly related to the tutorial, you can post them at [Katana Project on GitHub](https://github.com/aspnet/AspNetKatana/).</span></span> <span data-ttu-id="6dba5-123">Fragen und Kommentare in Bezug auf das Lernprogramm selbst finden Sie Abschnitt "Kommentare" am unteren Rand der Seite.</span><span class="sxs-lookup"><span data-stu-id="6dba5-123">For questions and comments regarding the tutorial itself, see the comments section at the bottom of the page.</span></span>


<span data-ttu-id="6dba5-124">Die [OAuth 2.0-Framework](http://tools.ietf.org/html/rfc6749) ermöglicht eine Drittanbieter-app zum eingeschränkten Zugriff auf einen HTTP-Dienst abrufen.</span><span class="sxs-lookup"><span data-stu-id="6dba5-124">The [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) enables a third-party app to obtain limited access to an HTTP service.</span></span> <span data-ttu-id="6dba5-125">Anstatt Anmeldeinformationen des ressourcenbesitzers, auf eine geschützte Ressource zuzugreifen, erhält der Client ein Zugriffstoken (Dies ist eine Zeichenfolge, die einen bestimmten Bereich, Lebensdauer und anderen Attributen Zugriff angibt).</span><span class="sxs-lookup"><span data-stu-id="6dba5-125">Instead of using the resource owner's credentials to access a protected resource, the client obtains an access token (which is a string denoting a specific scope, lifetime, and other access attributes).</span></span> <span data-ttu-id="6dba5-126">Zugriffstoken werden für Drittanbieter-Clients von einem autorisierungsserver mit Genehmigung des ressourcenbesitzers ausgegeben.</span><span class="sxs-lookup"><span data-stu-id="6dba5-126">Access tokens are issued to third-party clients by an authorization server with the approval of the resource owner.</span></span>

<span data-ttu-id="6dba5-127">Dieses Lernprogramm umfasst folgende Themen:</span><span class="sxs-lookup"><span data-stu-id="6dba5-127">This tutorial will cover:</span></span>

- <span data-ttu-id="6dba5-128">Vorgehensweise: Erstellen von einem autorisierungsserver zur Unterstützung von vier Autorisierung erteilungstyp, und Aktualisieren von Token:</span><span class="sxs-lookup"><span data-stu-id="6dba5-128">How to create an authorization server to support four authorization grant types and refresh tokens:</span></span>
    - <span data-ttu-id="6dba5-129">Authorization Code grant</span><span class="sxs-lookup"><span data-stu-id="6dba5-129">Authorization code grant</span></span>
    - <span data-ttu-id="6dba5-130">Implizite Gewährung</span><span class="sxs-lookup"><span data-stu-id="6dba5-130">Implicit Grant</span></span>
    - <span data-ttu-id="6dba5-131">Das Kennwort des Ressourcenbesitzers Clientanmeldeinformationen</span><span class="sxs-lookup"><span data-stu-id="6dba5-131">Resource Owner Password Credentials Grant</span></span>
    - <span data-ttu-id="6dba5-132">Erteilen von Clientanmeldeinformationen</span><span class="sxs-lookup"><span data-stu-id="6dba5-132">Client Credentials Grant</span></span>
- <span data-ttu-id="6dba5-133">Erstellt einen Ressourcenserver durch ein Zugriffstoken geschützt ist.</span><span class="sxs-lookup"><span data-stu-id="6dba5-133">Creating a resource server which is protected by an access token.</span></span>
- <span data-ttu-id="6dba5-134">Erstellen von OAuth 2.0-Clients.</span><span class="sxs-lookup"><span data-stu-id="6dba5-134">Creating OAuth 2.0 clients.</span></span>

<a id="prerequisites"></a>
## <a name="prerequisites"></a><span data-ttu-id="6dba5-135">Erforderliche Komponenten</span><span class="sxs-lookup"><span data-stu-id="6dba5-135">Prerequisites</span></span>

- <span data-ttu-id="6dba5-136">[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-editions) oder das kostenlose [Visual Studio Express 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-express), gemäß **Softwareversionen** am oberen Rand der Seite.</span><span class="sxs-lookup"><span data-stu-id="6dba5-136">[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-editions) or the free [Visual Studio Express 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-express), as indicated in **Software Versions** at the top of the page.</span></span>
- <span data-ttu-id="6dba5-137">Vertrautheit mit OWIN.</span><span class="sxs-lookup"><span data-stu-id="6dba5-137">Familiarity with OWIN.</span></span> <span data-ttu-id="6dba5-138">Finden Sie unter [Einstieg in das Projekt Katana](https://msdn.microsoft.com/en-us/magazine/dn451439.aspx) und [Neuheiten bei OWIN und Katana](index.md).</span><span class="sxs-lookup"><span data-stu-id="6dba5-138">See [Getting Started with the Katana Project](https://msdn.microsoft.com/en-us/magazine/dn451439.aspx) and [What's new in OWIN and Katana](index.md).</span></span>
- <span data-ttu-id="6dba5-139">Vertrautheit mit [OAuth](http://tools.ietf.org/html/rfc6749) Terminologie, einschließlich [Rollen](http://tools.ietf.org/html/rfc6749#section-1.1), [Protokoll Flow](http://tools.ietf.org/html/rfc6749#section-1.2), und [Autorisierungserteilung](http://tools.ietf.org/html/rfc6749#section-1.3).</span><span class="sxs-lookup"><span data-stu-id="6dba5-139">Familiarity with [OAuth](http://tools.ietf.org/html/rfc6749) terminology, including [Roles](http://tools.ietf.org/html/rfc6749#section-1.1), [Protocol Flow](http://tools.ietf.org/html/rfc6749#section-1.2), and [Authorization Grant](http://tools.ietf.org/html/rfc6749#section-1.3).</span></span> <span data-ttu-id="6dba5-140">[OAuth 2.0-Einführung](http://tools.ietf.org/html/rfc6749#section-1) bietet eine gute Einführung.</span><span class="sxs-lookup"><span data-stu-id="6dba5-140">[OAuth 2.0 introduction](http://tools.ietf.org/html/rfc6749#section-1) provides a good introduction.</span></span>

## <a name="create-an-authorization-server"></a><span data-ttu-id="6dba5-141">Einen Autorisierungsserver erstellen</span><span class="sxs-lookup"><span data-stu-id="6dba5-141">Create an Authorization Server</span></span>

<span data-ttu-id="6dba5-142">In diesem Lernprogramm werden wir grob, wie Sie skizzieren [OWIN](https://msdn.microsoft.com/en-us/magazine/dn451439.aspx) und ASP.NET MVC einen autorisierungsserver erstellen.</span><span class="sxs-lookup"><span data-stu-id="6dba5-142">In this tutorial, we will roughly sketch out how to use [OWIN](https://msdn.microsoft.com/en-us/magazine/dn451439.aspx) and ASP.NET MVC to create an authorization server.</span></span> <span data-ttu-id="6dba5-143">Wir hoffen, Sie bald einen Download für das vollständige Beispiel bereitstellen, wie in diesem Lernprogramm nicht jeder Schritt enthalten ist.</span><span class="sxs-lookup"><span data-stu-id="6dba5-143">We hope to soon provide a download for the completed sample, as this tutorial does not include each step.</span></span> <span data-ttu-id="6dba5-144">Erstellen Sie zunächst eine leeres Web-app mit dem Namen *AuthorizationServer* und installieren Sie die folgenden Pakete:</span><span class="sxs-lookup"><span data-stu-id="6dba5-144">First, create an empty web app named *AuthorizationServer* and install the following packages:</span></span>

- <span data-ttu-id="6dba5-145">Microsoft.AspNet.Mvc</span><span class="sxs-lookup"><span data-stu-id="6dba5-145">Microsoft.AspNet.Mvc</span></span>
- <span data-ttu-id="6dba5-146">"Microsoft.owin.Host.systemweb"</span><span class="sxs-lookup"><span data-stu-id="6dba5-146">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="6dba5-147">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="6dba5-147">Microsoft.Owin.Security.OAuth</span></span>
- <span data-ttu-id="6dba5-148">Microsoft.Owin.Security.Cookies</span><span class="sxs-lookup"><span data-stu-id="6dba5-148">Microsoft.Owin.Security.Cookies</span></span>
- <span data-ttu-id="6dba5-149">"Microsoft.owin.Security.Google" (oder einer beliebigen anderen sozialen Anmeldung zu verpacken, z. B. "Microsoft.owin.Security.Facebook")</span><span class="sxs-lookup"><span data-stu-id="6dba5-149">Microsoft.Owin.Security.Google (Or any other social login package such as Microsoft.Owin.Security.Facebook)</span></span>

<span data-ttu-id="6dba5-150">Hinzufügen einer [OWIN Startklasse](owin-startup-class-detection.md) unter dem Stammordner des Projekts mit dem Namen *Start*.</span><span class="sxs-lookup"><span data-stu-id="6dba5-150">Add an [OWIN Startup class](owin-startup-class-detection.md) under the project root folder named *Startup*.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample1.cs?highlight=8)]

<span data-ttu-id="6dba5-151">Erstellen einer *App\_starten* Ordner.</span><span class="sxs-lookup"><span data-stu-id="6dba5-151">Create an *App\_Start* folder.</span></span> <span data-ttu-id="6dba5-152">Wählen Sie die *App\_starten* Ordner und verwenden Sie Umschalt + Alt + A, Hinzufügen der heruntergeladene Version der *AuthorizationServer\App\_Start\Startup.Auth.cs* Datei.</span><span class="sxs-lookup"><span data-stu-id="6dba5-152">Select the *App\_Start* folder and use Shift+Alt+A to add the downloaded version of the *AuthorizationServer\App\_Start\Startup.Auth.cs* file.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample2.cs)]

<span data-ttu-id="6dba5-153">Der obige Code ermöglicht die Anwendung/externe Anmeldung Cookies und Google-Authentifizierung, die vom autorisierungsserver selbst verwendet werden, um Konten zu verwalten.</span><span class="sxs-lookup"><span data-stu-id="6dba5-153">The code above enables application/external sign in cookies and Google authentication, which are used by authorization server itself to manage accounts.</span></span>

<span data-ttu-id="6dba5-154">Die `UseOAuthAuthorizationServer` Erweiterungsmethode ist beim Einrichten des autorisierungsservers.</span><span class="sxs-lookup"><span data-stu-id="6dba5-154">The `UseOAuthAuthorizationServer` extension method is to setup the authorization server.</span></span> <span data-ttu-id="6dba5-155">Die Setupoptionen sind:</span><span class="sxs-lookup"><span data-stu-id="6dba5-155">The setup options are:</span></span>

- <span data-ttu-id="6dba5-156">`AuthorizeEndpointPath`: Der Pfad der Anforderung, in denen Clientanwendungen User-Agent umgeleitet wird, um die Benutzer erhalten, stimmen ein Token oder die Code ausgeben.</span><span class="sxs-lookup"><span data-stu-id="6dba5-156">`AuthorizeEndpointPath`: The request path where client applications will redirect the user-agent in order to obtain the users consent to issue a token or code.</span></span> <span data-ttu-id="6dba5-157">Er muss beginnen mit einem führenden Schrägstrich, z. B. "`/Authorize`".</span><span class="sxs-lookup"><span data-stu-id="6dba5-157">It must begin with a leading slash, for example, "`/Authorize`".</span></span>
- <span data-ttu-id="6dba5-158">`TokenEndpointPath`: Die Anforderung Pfad Clientanwendungen kommunizieren direkt um das Zugriffstoken zu erhalten.</span><span class="sxs-lookup"><span data-stu-id="6dba5-158">`TokenEndpointPath`: The request path client applications directly communicate to obtain the access token.</span></span> <span data-ttu-id="6dba5-159">Er muss mit einem führenden Schrägstrich, z. B. "/ Token" beginnen.</span><span class="sxs-lookup"><span data-stu-id="6dba5-159">It must begin with a leading slash, like "/Token".</span></span> <span data-ttu-id="6dba5-160">Wenn der Client ausgestellt wird eine [Client\_geheimen](http://tools.ietf.org/html/rfc6749#appendix-A.2), muss Sie an diesen Endpunkt bereitgestellt werden.</span><span class="sxs-lookup"><span data-stu-id="6dba5-160">If the client is issued a [client\_secret](http://tools.ietf.org/html/rfc6749#appendix-A.2), it must be provided to this endpoint.</span></span>
- <span data-ttu-id="6dba5-161">`ApplicationCanDisplayErrors`: Legen Sie auf `true` möchte, dass die Webanwendung auf eine benutzerdefinierte Fehlerseite für den Client-Überprüfungsfehler generieren `/Authorize` Endpunkt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-161">`ApplicationCanDisplayErrors`: Set to `true` if the web application wants to generate a custom error page for the client validation errors on `/Authorize` endpoint.</span></span> <span data-ttu-id="6dba5-162">Dies ist nur erforderlich, für Fälle, in dem der Browser wird nicht umgeleitet, an die Clientanwendung, z. B. sichern, wenn die `client_id` oder `redirect_uri` sind falsch.</span><span class="sxs-lookup"><span data-stu-id="6dba5-162">This is only needed for cases where the browser is not redirected back to the client application, for example, when the `client_id` or `redirect_uri` are incorrect.</span></span> <span data-ttu-id="6dba5-163">Die `/Authorize` Endpunkt rechnen, finden in der "Oauth. Fehler","Oauth. ErrorDescription"und"Oauth. Der OWIN-Umgebung werden Eigenschaften ErrorUri"hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-163">The `/Authorize` endpoint should expect to see the "oauth.Error", "oauth.ErrorDescription", and "oauth.ErrorUri" properties are added to the OWIN environment.</span></span> 

    > [!NOTE]
    > <span data-ttu-id="6dba5-164">Wenn nicht "true", der autorisierungsserver eine Standardfehlerseite mit den Details der Fehlermeldung zurückgegeben wird.</span><span class="sxs-lookup"><span data-stu-id="6dba5-164">If not true, the authorization server will return a default error page with the error details.</span></span>
- <span data-ttu-id="6dba5-165">`AllowInsecureHttp`: True zu ermöglichen, Autorisierungs- und tokenanforderungen für HTTP-URI-Adressen eingehen und eingehende `redirect_uri` autorisieren Anforderungsparameter HTTP-URI-Adressen haben.</span><span class="sxs-lookup"><span data-stu-id="6dba5-165">`AllowInsecureHttp`: True to allow authorize and token requests to arrive on HTTP URI addresses, and to allow incoming `redirect_uri` authorize request parameters to have HTTP URI addresses.</span></span> 

    > [!WARNING]
    > <span data-ttu-id="6dba5-166">Sicherheit – ist dies für die Entwicklung nur.</span><span class="sxs-lookup"><span data-stu-id="6dba5-166">Security - This is for development only.</span></span>
- <span data-ttu-id="6dba5-167">`Provider`: Das Objekt von der Anwendung zum Verarbeiten von Ereignissen, die von der autorisierungsservermiddleware ausgelöst bereitgestellt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-167">`Provider`: The object provided by the application to process events raised by the Authorization Server middleware.</span></span> <span data-ttu-id="6dba5-168">Die Anwendung kann die Schnittstelle vollständig implementieren, oder es möglicherweise erstellen Sie eine Instanz des `OAuthAuthorizationServerProvider` , und weisen Sie Delegaten erforderlich für die OAuth-Arbeitsabläufe, die dieser Server unterstützt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-168">The application may implement the interface fully, or it may create an instance of `OAuthAuthorizationServerProvider` and assign delegates necessary for the OAuth flows this server supports.</span></span>
- <span data-ttu-id="6dba5-169">`AuthorizationCodeProvider`: Erstellt einen Single-Use-Autorisierungscode an die Clientanwendung zurückgegeben.</span><span class="sxs-lookup"><span data-stu-id="6dba5-169">`AuthorizationCodeProvider`: Produces a single-use authorization code to return to the client application.</span></span> <span data-ttu-id="6dba5-170">Sichern Sie die Anwendung für die OAuth-Server **müssen** Geben Sie eine Instanz für `AuthorizationCodeProvider` , in dem das Token erzeugt, indem die `OnCreate/OnCreateAsync` Ereignis als gültig interpretiert wird für nur einen Aufruf von `OnReceive/OnReceiveAsync`.</span><span class="sxs-lookup"><span data-stu-id="6dba5-170">For the OAuth server to be secure the application **MUST** provide an instance for `AuthorizationCodeProvider` where the token produced by the `OnCreate/OnCreateAsync` event is considered valid for only one call to `OnReceive/OnReceiveAsync`.</span></span>
- <span data-ttu-id="6dba5-171">`RefreshTokenProvider`: Erstellt ein Aktualisierungstoken, das verwendet werden kann, um ein neues Zugriffstoken bei Bedarf zu erzeugen.</span><span class="sxs-lookup"><span data-stu-id="6dba5-171">`RefreshTokenProvider`: Produces a refresh token which may be used to produce a new access token when needed.</span></span> <span data-ttu-id="6dba5-172">Wenn nicht angegeben der autorisierungsserver keine Aktualisierungstoken aus zurückliefert der `/Token` Endpunkt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-172">If not provided the authorization server will not return refresh tokens from the `/Token` endpoint.</span></span>

## <a name="account-management"></a><span data-ttu-id="6dba5-173">Kontenverwaltung</span><span class="sxs-lookup"><span data-stu-id="6dba5-173">Account Management</span></span>

<span data-ttu-id="6dba5-174">OAuth darauf nicht, wo und wie Sie Ihre Benutzerinformationen für das Konto verwalten.</span><span class="sxs-lookup"><span data-stu-id="6dba5-174">OAuth doesn't care where or how you manage your user account information.</span></span> <span data-ttu-id="6dba5-175">Es wurde [ASP.NET Identity](../../../identity/index.md) die dafür verantwortlich ist.</span><span class="sxs-lookup"><span data-stu-id="6dba5-175">It's [ASP.NET Identity](../../../identity/index.md) which is responsible for it.</span></span> <span data-ttu-id="6dba5-176">In diesem Lernprogramm wird das Konto Management Code vereinfachen und achten Sie darauf, dass sich der Benutzer anmelden kann mithilfe der OWIN-Cookie-Middleware.</span><span class="sxs-lookup"><span data-stu-id="6dba5-176">In this tutorial, we will simplify the account management code and just make sure that user can login using OWIN cookie middleware.</span></span> <span data-ttu-id="6dba5-177">Hier ist die vereinfachte Beispielcode für die `AccountController`:</span><span class="sxs-lookup"><span data-stu-id="6dba5-177">Here is the simplified sample code for the `AccountController`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample3.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample4.cs?highlight=1)]

<span data-ttu-id="6dba5-178">`ValidateClientRedirectUri`wird verwendet, um den Client mit der registrierte umleitungs-URL zu überprüfen.</span><span class="sxs-lookup"><span data-stu-id="6dba5-178">`ValidateClientRedirectUri` is used to validate the client with its registered redirect URL.</span></span> <span data-ttu-id="6dba5-179">`ValidateClientAuthentication`überprüft die grundlegende Schema Header und Formulartext, um die Anmeldeinformationen des Clients abzurufen.</span><span class="sxs-lookup"><span data-stu-id="6dba5-179">`ValidateClientAuthentication` checks the basic scheme header and form body to get the client's credentials.</span></span>

<span data-ttu-id="6dba5-180">Die Anmeldeseite wird unten gezeigt:</span><span class="sxs-lookup"><span data-stu-id="6dba5-180">The login page is shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image1.png)

<span data-ttu-id="6dba5-181">Überprüfen Sie der IETF-OAuth-2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) jetzt Abschnitt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-181">Review the IETF's OAuth 2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) section now.</span></span> 

<span data-ttu-id="6dba5-182">**Anbieter** ist (in der folgenden Tabelle) [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/en-us/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx). Anbieter, der vom Typ `OAuthAuthorizationServerProvider`, die alle OAuth-Server-Ereignisse enthält.</span><span class="sxs-lookup"><span data-stu-id="6dba5-182">**Provider** (in the table below) is [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/en-us/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx).Provider, which is of type `OAuthAuthorizationServerProvider`, which contains all OAuth server events.</span></span> 

| <span data-ttu-id="6dba5-183">Die einzelnen Schritte im Abschnitt "Authorization Code Grant"</span><span class="sxs-lookup"><span data-stu-id="6dba5-183">Flow steps from Authorization Code Grant section</span></span> | <span data-ttu-id="6dba5-184">Beispiel zum Herunterladen führt diese Schritte mit:</span><span class="sxs-lookup"><span data-stu-id="6dba5-184">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="6dba5-185">(A) der Client initiiert den Fluss durch Umleiten des ressourcenbesitzers Benutzer-Agent an den autorisierungsendpunkt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-185">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="6dba5-186">Der Client enthält die Client-ID, angeforderten Bereich lokalen Zustand und eine umleitungs-URI, an die der autorisierungsserver den Benutzer-Agent senden soll, zurückgesendet, sobald der Zugriff gewährt (oder verweigert).</span><span class="sxs-lookup"><span data-stu-id="6dba5-186">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="6dba5-187">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="6dba5-187">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="6dba5-188">(B) der autorisierungsserver authentifiziert den Besitzer der Ressource (über den Benutzer-Agent) und legt fest, ob der Besitzer der Ressource gewährt oder die Anforderung des Clients den Zugriff verweigert.</span><span class="sxs-lookup"><span data-stu-id="6dba5-188">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="6dba5-189">**&lt;Wenn Benutzer den Zugriff gewährt&gt;**  Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="6dba5-189">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="6dba5-190">(C) vorausgesetzt, der Besitzer der Ressource wird Zugriff gewährt, der autorisierungsserver leitet den Benutzer-Agent zurück an den Client mithilfe der umleitungs-URI bereitgestellt früheren (in der Anforderung oder während der Clientregistrierung).</span><span class="sxs-lookup"><span data-stu-id="6dba5-190">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="6dba5-191">...</span><span class="sxs-lookup"><span data-stu-id="6dba5-191">...</span></span> |  |
|  |  |
| <span data-ttu-id="6dba5-192">(D) der Client fordert ein Zugriffstoken aus der autorisierungsserver-token-Endpunkt, dazu den Autorisierungscode, der im vorherigen Schritt empfangen.</span><span class="sxs-lookup"><span data-stu-id="6dba5-192">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="6dba5-193">Wenn die Anforderung ausführen, wird der Client mit der autorisierungsserver authentifiziert.</span><span class="sxs-lookup"><span data-stu-id="6dba5-193">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="6dba5-194">Der Client schließt die Umleitung URI verwendet wird, um den Autorisierungscode für die Überprüfung zu erhalten.</span><span class="sxs-lookup"><span data-stu-id="6dba5-194">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> | <span data-ttu-id="6dba5-195">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="6dba5-195">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |

<span data-ttu-id="6dba5-196">Eine beispielimplementierung für `AuthorizationCodeProvider.CreateAsync` und `ReceiveAsync` zum Steuern der Erstellung und Überprüfung der Autorisierungscode werden unten gezeigt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-196">A sample implementation for `AuthorizationCodeProvider.CreateAsync` and `ReceiveAsync` to control the creation and validation of authorization code is shown below.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample5.cs)]

<span data-ttu-id="6dba5-197">Der obige Code verwendet ein in-Memory-Gleichzeitiges Wörterbuch zum Speichern von Code und Identität Ticket und Wiederherstellen der Identität nach dem Empfang des Codes.</span><span class="sxs-lookup"><span data-stu-id="6dba5-197">The code above uses an in-memory concurrent dictionary to store the code and identity ticket and restore the identity after receiving the code.</span></span> <span data-ttu-id="6dba5-198">In einer realen Anwendung würde es von einem persistenten Datenspeicher ersetzt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-198">In a real application, it would be replaced by a persistent data store.</span></span> <span data-ttu-id="6dba5-199">Der autorisierungsendpunkt ist für den Besitzer der Ressource gewähren von Zugriff an den Client.</span><span class="sxs-lookup"><span data-stu-id="6dba5-199">The authorization endpoint is for the resource owner to grant access to the client.</span></span> <span data-ttu-id="6dba5-200">In der Regel benötigt eine Benutzeroberfläche, damit der Benutzer auf eine Schaltfläche klicken, und bestätigen die Gewährung.</span><span class="sxs-lookup"><span data-stu-id="6dba5-200">Usually, it needs a user interface to allow the user to click a button and confirm the grant.</span></span> <span data-ttu-id="6dba5-201">OAuth OWIN-Middleware kann Anwendungscode autorisierungsendpunkt behandelt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-201">OWIN OAuth middleware allows application code to handle the authorization endpoint.</span></span> <span data-ttu-id="6dba5-202">In unserem Beispiel-app verwenden wir einen MVC-Controller aufgerufen `OAuthController` verarbeiten.</span><span class="sxs-lookup"><span data-stu-id="6dba5-202">In our sample app, we use an MVC controller called `OAuthController` to handle it.</span></span> <span data-ttu-id="6dba5-203">So sieht die beispielimplementierung aus:</span><span class="sxs-lookup"><span data-stu-id="6dba5-203">Here is the sample implementation:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample6.cs?highlight=15)]

<span data-ttu-id="6dba5-204">Die `Authorize` Aktion wird zuerst überprüft, ob der Benutzer mit dem autorisierungsserver angemeldet hat.</span><span class="sxs-lookup"><span data-stu-id="6dba5-204">The `Authorize` action will first check if the user has logged in to the authorization server.</span></span> <span data-ttu-id="6dba5-205">Wenn dies nicht der Fall, die authentifizierungsmiddleware Herausforderungen den Aufrufer die Authentifizierung mit das Cookie "Application" und zur Anmeldeseite umgeleitet.</span><span class="sxs-lookup"><span data-stu-id="6dba5-205">If not, the authentication middleware challenges the caller to authenticate using the "Application" cookie and redirects to the login page.</span></span> <span data-ttu-id="6dba5-206">(Siehe obigen hervorgehobene Code). Wenn Benutzer angemeldet hat, wird die Sicht autorisieren gerendert, wie unten dargestellt:</span><span class="sxs-lookup"><span data-stu-id="6dba5-206">(See highlighted code above.) If user has logged in, it will render the Authorize view, as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image2.png)

<span data-ttu-id="6dba5-207">Wenn die **Grant** Schaltfläche aktiviert ist, die `Authorize` Aktion wird ein neues "Träger" Identität und melden Sie sich mit der sie erstellt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-207">If the **Grant** button is selected, the `Authorize` action will create a new "Bearer" identity and sign in with it.</span></span> <span data-ttu-id="6dba5-208">Der autorisierungsserver, um ein trägertoken, das Generieren und senden es an den Client mit JSON-Nutzlast löst.</span><span class="sxs-lookup"><span data-stu-id="6dba5-208">It will trigger the authorization server to generate a bearer token and send it back to the client with JSON payload.</span></span> 

### <a name="implicit-grant"></a><span data-ttu-id="6dba5-209">Implizite Gewährung</span><span class="sxs-lookup"><span data-stu-id="6dba5-209">Implicit Grant</span></span>

<span data-ttu-id="6dba5-210">Finden Sie in der IETF-OAuth-2 [implizite Gewährung](http://tools.ietf.org/html/rfc6749#section-4.2) jetzt Abschnitt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-210">Refer to the IETF's OAuth 2 [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) section now.</span></span>

 <span data-ttu-id="6dba5-211">Die [implizite Gewährung](http://tools.ietf.org/html/rfc6749#section-4.2) Fluss in Abbildung 4 dargestellt, ist der Fluss und Zuordnen von denen die OWIN-OAuth Middleware folgt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-211">The [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) flow shown in Figure 4 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>  

| <span data-ttu-id="6dba5-212">Die einzelnen Schritte im Abschnitt "implizite Gewährung"</span><span class="sxs-lookup"><span data-stu-id="6dba5-212">Flow steps from Implicit Grant section</span></span> | <span data-ttu-id="6dba5-213">Beispiel zum Herunterladen führt diese Schritte mit:</span><span class="sxs-lookup"><span data-stu-id="6dba5-213">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="6dba5-214">(A) der Client initiiert den Fluss durch Umleiten des ressourcenbesitzers Benutzer-Agent an den autorisierungsendpunkt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-214">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="6dba5-215">Der Client enthält die Client-ID, angeforderten Bereich lokalen Zustand und eine umleitungs-URI, an die der autorisierungsserver den Benutzer-Agent senden soll, zurückgesendet, sobald der Zugriff gewährt (oder verweigert).</span><span class="sxs-lookup"><span data-stu-id="6dba5-215">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="6dba5-216">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="6dba5-216">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="6dba5-217">(B) der autorisierungsserver authentifiziert den Besitzer der Ressource (über den Benutzer-Agent) und legt fest, ob der Besitzer der Ressource gewährt oder die Anforderung des Clients den Zugriff verweigert.</span><span class="sxs-lookup"><span data-stu-id="6dba5-217">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="6dba5-218">**&lt;Wenn Benutzer den Zugriff gewährt&gt;**  Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="6dba5-218">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="6dba5-219">(C) vorausgesetzt, der Besitzer der Ressource wird Zugriff gewährt, der autorisierungsserver leitet den Benutzer-Agent zurück an den Client mithilfe der umleitungs-URI bereitgestellt früheren (in der Anforderung oder während der Clientregistrierung).</span><span class="sxs-lookup"><span data-stu-id="6dba5-219">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="6dba5-220">...</span><span class="sxs-lookup"><span data-stu-id="6dba5-220">...</span></span> |  |
|  |  |
| <span data-ttu-id="6dba5-221">(D) der Client fordert ein Zugriffstoken aus der autorisierungsserver-token-Endpunkt, dazu den Autorisierungscode, der im vorherigen Schritt empfangen.</span><span class="sxs-lookup"><span data-stu-id="6dba5-221">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="6dba5-222">Wenn die Anforderung ausführen, wird der Client mit der autorisierungsserver authentifiziert.</span><span class="sxs-lookup"><span data-stu-id="6dba5-222">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="6dba5-223">Der Client schließt die Umleitung URI verwendet wird, um den Autorisierungscode für die Überprüfung zu erhalten.</span><span class="sxs-lookup"><span data-stu-id="6dba5-223">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> |  |

<span data-ttu-id="6dba5-224">Da wir bereits autorisierungsendpunkt implementiert (`OAuthController.Authorize` Aktion) nach Authorization Code GRANT-Anweisung, es impliziten Datenfluss ebenfalls automatisch aktiviert.</span><span class="sxs-lookup"><span data-stu-id="6dba5-224">Since we already implemented the authorization endpoint (`OAuthController.Authorize` action) for authorization code grant, it automatically enables implicit flow as well.</span></span> <span data-ttu-id="6dba5-225">Hinweis: `Provider.ValidateClientRedirectUri` wird verwendet, um die Client-ID mit der umleitungs-URL, zu überprüfen, bei denen die implizite Grant-Datenfluss schützt vor dem Senden des Zugriffs-Token genutzt, um böswillige Clients ([Man-in-the-Middle-Angriff](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span><span class="sxs-lookup"><span data-stu-id="6dba5-225">Note: `Provider.ValidateClientRedirectUri` is used to validate the client ID with its redirection URL, which protects the implicit grant flow from sending the access token to malicious clients ([Man-in-the-middle attack](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span></span>

### <a name="resource-owner-password-credentials-grant"></a><span data-ttu-id="6dba5-226">Das Kennwort des Ressourcenbesitzers Clientanmeldeinformationen</span><span class="sxs-lookup"><span data-stu-id="6dba5-226">Resource Owner Password Credentials Grant</span></span>

<span data-ttu-id="6dba5-227">Finden Sie in der IETF-OAuth-2 [Kennwort Anmeldeinformationen Ressourcenbesitzererteilung](http://tools.ietf.org/html/rfc6749#section-4.3) jetzt Abschnitt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-227">Refer to the IETF's OAuth 2 [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) section now.</span></span>

 <span data-ttu-id="6dba5-228">Die [Kennwort Anmeldeinformationen Ressourcenbesitzererteilung](http://tools.ietf.org/html/rfc6749#section-4.3) Fluss in Abbildung 5 dargestellten ist der Fluss und Zuordnen von denen die OWIN-OAuth Middleware folgt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-228">The [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) flow shown in Figure 5 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>  

| <span data-ttu-id="6dba5-229">Die einzelnen Schritte im Abschnitt "Kennwort Anmeldeinformationen Ressourcenbesitzererteilung"</span><span class="sxs-lookup"><span data-stu-id="6dba5-229">Flow steps from Resource Owner Password Credentials Grant section</span></span> | <span data-ttu-id="6dba5-230">Beispiel zum Herunterladen führt diese Schritte mit:</span><span class="sxs-lookup"><span data-stu-id="6dba5-230">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="6dba5-231">(A) der Besitzer der Ressource stellt dem Client mit dem Benutzernamen und Kennwort an.</span><span class="sxs-lookup"><span data-stu-id="6dba5-231">(A) The resource owner provides the client with its username and password.</span></span> |  |
|  |  |
| <span data-ttu-id="6dba5-232">(B) der Client fordert ein Zugriffstoken aus der autorisierungsserver-token-Endpunkt, indem Sie die Anmeldeinformationen des ressourcenbesitzers erhaltene einschließen.</span><span class="sxs-lookup"><span data-stu-id="6dba5-232">(B) The client requests an access token from the authorization server's token endpoint by including the credentials received from the resource owner.</span></span> <span data-ttu-id="6dba5-233">Wenn die Anforderung ausführen, wird der Client mit der autorisierungsserver authentifiziert.</span><span class="sxs-lookup"><span data-stu-id="6dba5-233">When making the request, the client authenticates with the authorization server.</span></span> | <span data-ttu-id="6dba5-234">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="6dba5-234">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="6dba5-235">(C) der autorisierungsserver authentifiziert den Client und die Ressource Besitzer Anmeldeinformationen überprüft und wenn gültig ist, gibt ein Zugriffstoken.</span><span class="sxs-lookup"><span data-stu-id="6dba5-235">(C) The authorization server authenticates the client and validates the resource owner credentials, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="6dba5-236">Hier wird die beispielimplementierung für `Provider.GrantResourceOwnerCredentials`:</span><span class="sxs-lookup"><span data-stu-id="6dba5-236">Here is the sample implementation for `Provider.GrantResourceOwnerCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample7.cs)]

> [!NOTE]
> <span data-ttu-id="6dba5-237">Der obige Code soll in diesem Abschnitt des Lernprogramms erläutert und sollte nicht verwendet werden, in der sicheren oder Produktion apps.</span><span class="sxs-lookup"><span data-stu-id="6dba5-237">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="6dba5-238">Er überprüft nicht die Besitzer ressourcenanmeldeinformationen.</span><span class="sxs-lookup"><span data-stu-id="6dba5-238">It does not check the resource owners credentials.</span></span> <span data-ttu-id="6dba5-239">Es wird vorausgesetzt, alle Anmeldeinformationen gültig ist und eine neue Identität für sie erstellt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-239">It assumes every credential is valid and creates a new identity for it.</span></span> <span data-ttu-id="6dba5-240">Die neue Identität wird zum Generieren von Zugriffstoken und Aktualisierungstoken verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="6dba5-240">The new identity will be used to generate the access token and refresh token.</span></span> <span data-ttu-id="6dba5-241">Ersetzen Sie den Code, Ihren eigenen sicheres Konto Management-Code.</span><span class="sxs-lookup"><span data-stu-id="6dba5-241">Please replace the code with your own secure account management code.</span></span>


### <a name="client-credentials-grant"></a><span data-ttu-id="6dba5-242">Erteilen von Clientanmeldeinformationen</span><span class="sxs-lookup"><span data-stu-id="6dba5-242">Client Credentials Grant</span></span>

<span data-ttu-id="6dba5-243">Finden Sie in der IETF-OAuth-2 [Erteilungsfluss](http://tools.ietf.org/html/rfc6749#section-4.4) jetzt Abschnitt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-243">Refer to the IETF's OAuth 2 [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) section now.</span></span>

 <span data-ttu-id="6dba5-244">Die [Erteilungsfluss](http://tools.ietf.org/html/rfc6749#section-4.4) in Abbildung 6 dargestellten Ablauf ist der Fluss und Zuordnen von denen die OWIN-OAuth Middleware folgt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-244">The [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) flow shown in Figure 6 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>  

| <span data-ttu-id="6dba5-245">Die einzelnen Schritte im Abschnitt "Erteilungsfluss"</span><span class="sxs-lookup"><span data-stu-id="6dba5-245">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="6dba5-246">Beispiel zum Herunterladen führt diese Schritte mit:</span><span class="sxs-lookup"><span data-stu-id="6dba5-246">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="6dba5-247">(A) der Client mit der autorisierungsserver authentifiziert und fordert ein Zugriffstoken vom token-Endpunkt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-247">(A) The client authenticates with the authorization server and requests an access token from the token endpoint.</span></span> | <span data-ttu-id="6dba5-248">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="6dba5-248">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="6dba5-249">(B) der autorisierungsserver authentifiziert den Client, und wenn gültig ist, gibt ein Zugriffstoken.</span><span class="sxs-lookup"><span data-stu-id="6dba5-249">(B) The authorization server authenticates the client, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="6dba5-250">Hier wird die beispielimplementierung für `Provider.GrantClientCredentials`:</span><span class="sxs-lookup"><span data-stu-id="6dba5-250">Here is the sample implementation for `Provider.GrantClientCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample8.cs)]

> [!NOTE]
> <span data-ttu-id="6dba5-251">Der obige Code soll in diesem Abschnitt des Lernprogramms erläutert und sollte nicht verwendet werden, in der sicheren oder Produktion apps.</span><span class="sxs-lookup"><span data-stu-id="6dba5-251">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="6dba5-252">Ersetzen Sie den Code, Ihren eigenen sichere Client Management-Code.</span><span class="sxs-lookup"><span data-stu-id="6dba5-252">Please replace the code with your own secure client management code.</span></span>


### <a name="refresh-token"></a><span data-ttu-id="6dba5-253">Aktualisierungstoken</span><span class="sxs-lookup"><span data-stu-id="6dba5-253">Refresh Token</span></span>

<span data-ttu-id="6dba5-254">Finden Sie in der IETF-OAuth-2 [Aktualisierungstoken](http://tools.ietf.org/html/rfc6749#section-1.5) jetzt Abschnitt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-254">Refer to the IETF's OAuth 2 [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) section now.</span></span>

 <span data-ttu-id="6dba5-255">Die [Aktualisierungstoken](http://tools.ietf.org/html/rfc6749#section-1.5) in Abbildung 2 veranschaulichte Datenfluss finden Sie den Ablauf und Zuordnen von denen die OWIN-OAuth Middleware folgt.</span><span class="sxs-lookup"><span data-stu-id="6dba5-255">The [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) flow shown in Figure 2 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>  

| <span data-ttu-id="6dba5-256">Die einzelnen Schritte im Abschnitt "Erteilungsfluss"</span><span class="sxs-lookup"><span data-stu-id="6dba5-256">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="6dba5-257">Beispiel zum Herunterladen führt diese Schritte mit:</span><span class="sxs-lookup"><span data-stu-id="6dba5-257">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="6dba5-258">(G) der Client fordert ein neues Zugriffstoken von Authentifizierung mit dem autorisierungsserver und das Aktualisierungstoken darstellen.</span><span class="sxs-lookup"><span data-stu-id="6dba5-258">(G) The client requests a new access token by authenticating with the authorization server and presenting the refresh token.</span></span> <span data-ttu-id="6dba5-259">Die clientauthentifizierungsanforderungen basieren auf dem Client und auf die Autorisierungsrichtlinien für den Server.</span><span class="sxs-lookup"><span data-stu-id="6dba5-259">The client authentication requirements are based on the client type and on the authorization server policies.</span></span> | <span data-ttu-id="6dba5-260">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="6dba5-260">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="6dba5-261">(H) der autorisierungsserver authentifiziert den Client und das Aktualisierungstoken, das überprüft, und wenn gültig ist, gibt ein neues Zugriffstoken (und optional einen neuen Aktualisierungstoken).</span><span class="sxs-lookup"><span data-stu-id="6dba5-261">(H) The authorization server authenticates the client and validates the refresh token, and if valid, issues a new access token (and, optionally, a new refresh token).</span></span> |  |

<span data-ttu-id="6dba5-262">Hier wird die beispielimplementierung für `Provider.GrantRefreshToken`:</span><span class="sxs-lookup"><span data-stu-id="6dba5-262">Here is the sample implementation for `Provider.GrantRefreshToken`:</span></span> 

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample9.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample10.cs)]

## <a name="create-a-resource-server-which-is-protected-by-access-token"></a><span data-ttu-id="6dba5-263">Erstellen Sie einen Ressourcenserver das mit Zugriffstoken geschützt wird</span><span class="sxs-lookup"><span data-stu-id="6dba5-263">Create a Resource Server which is protected by Access Token</span></span>

<span data-ttu-id="6dba5-264">Erstellen Sie ein leeres Web-app-Projekt, und folgende Pakete im Projekt installieren:</span><span class="sxs-lookup"><span data-stu-id="6dba5-264">Create an empty web app project and install following packages in the project:</span></span>

- <span data-ttu-id="6dba5-265">Microsoft.AspNet.WebApi.Owin</span><span class="sxs-lookup"><span data-stu-id="6dba5-265">Microsoft.AspNet.WebApi.Owin</span></span>
- <span data-ttu-id="6dba5-266">"Microsoft.owin.Host.systemweb"</span><span class="sxs-lookup"><span data-stu-id="6dba5-266">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="6dba5-267">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="6dba5-267">Microsoft.Owin.Security.OAuth</span></span>

<span data-ttu-id="6dba5-268">Erstellen Sie eine Startklasse, und Konfigurieren von Authentifizierung und Web-API.</span><span class="sxs-lookup"><span data-stu-id="6dba5-268">Create a startup class and configure authentication and Web API.</span></span> <span data-ttu-id="6dba5-269">Finden Sie unter *AuthorizationServer\ResourceServer\Startup.cs* im Downloadbeispiel.</span><span class="sxs-lookup"><span data-stu-id="6dba5-269">See *AuthorizationServer\ResourceServer\Startup.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample11.cs)]

<span data-ttu-id="6dba5-270">Finden Sie unter *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* im Downloadbeispiel.</span><span class="sxs-lookup"><span data-stu-id="6dba5-270">See *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample12.cs)]

<span data-ttu-id="6dba5-271">Finden Sie unter *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* im Downloadbeispiel.</span><span class="sxs-lookup"><span data-stu-id="6dba5-271">See *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample13.cs)]

- <span data-ttu-id="6dba5-272">`UseCors`Methode können CORS für alle Domänen.</span><span class="sxs-lookup"><span data-stu-id="6dba5-272">`UseCors` method allows CORS for all domains.</span></span>
- <span data-ttu-id="6dba5-273">`UseOAuthBearerAuthentication`Methode ermöglicht OAuth token trägerauthentifizierungsmiddleware empfangen und trägertoken, das aus dem Autorisierungsheader in der Anforderung überprüft wird.</span><span class="sxs-lookup"><span data-stu-id="6dba5-273">`UseOAuthBearerAuthentication` method enables OAuth bearer token authentication middleware which will receive and validate bearer token from authorization header in the request.</span></span>
- <span data-ttu-id="6dba5-274">`Config.SuppressDefaultHostAuthenticaiton`Unterdrückt die standardmäßige authentifizierten Prinzipal aus der app zu hosten, daher alle Anforderungen anonyme nach dem Aufruf.</span><span class="sxs-lookup"><span data-stu-id="6dba5-274">`Config.SuppressDefaultHostAuthenticaiton` suppresses default host authenticated principal from the app, therefore all requests will be anonymous after this call.</span></span>
- <span data-ttu-id="6dba5-275">`HostAuthenticationFilter`aktiviert die Authentifizierung nur für den angegebenen Authentifizierungstyp.</span><span class="sxs-lookup"><span data-stu-id="6dba5-275">`HostAuthenticationFilter` enables authentication just for the specified authentication type.</span></span> <span data-ttu-id="6dba5-276">In diesem Fall ist es Träger-Authentifizierungstyp.</span><span class="sxs-lookup"><span data-stu-id="6dba5-276">In this case, it's bearer authentication type.</span></span>

<span data-ttu-id="6dba5-277">Um die authentifizierte Identität zu veranschaulichen, erstellen wir eine ApiController zum Ausgeben von Ansprüchen des aktuellen Benutzers.</span><span class="sxs-lookup"><span data-stu-id="6dba5-277">In order to demonstrate the authenticated identity, we create an ApiController to output current user's claims.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample14.cs)]

<span data-ttu-id="6dba5-278">Wenn dem autorisierungsserver und der Ressourcenserver nicht auf demselben Computer sind, verwendet die OAuth-Middleware die anderen Computerschlüssel zum Verschlüsseln und Entschlüsseln von Bearer-Zugriffstoken.</span><span class="sxs-lookup"><span data-stu-id="6dba5-278">If the authorization server and the resource server are not on the same computer, the OAuth middleware will use the different machine keys to encrypt and decrypt bearer access token.</span></span> <span data-ttu-id="6dba5-279">Damit den gleichen privaten Schlüssel zwischen beide Projekte gemeinsam verwendet werden, fügen dem `machinekey` festlegen, die in beiden *"Web.config"* Dateien.</span><span class="sxs-lookup"><span data-stu-id="6dba5-279">In order to share the same private key between both projects, we add the same `machinekey` setting in both *web.config* files.</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample15.xml?highlight=8-10)]

## <a name="create-oauth-20-clients"></a><span data-ttu-id="6dba5-280">Erstellen von OAuth 2.0-Clients</span><span class="sxs-lookup"><span data-stu-id="6dba5-280">Create OAuth 2.0 Clients</span></span>

 <span data-ttu-id="6dba5-281">Wir verwenden die [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet-Paket an den Clientcode zu vereinfachen.</span><span class="sxs-lookup"><span data-stu-id="6dba5-281">We use the [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet package to simplify the client code.</span></span>

### <a name="authorization-code-grant-client"></a><span data-ttu-id="6dba5-282">Authorization Code Grant-Client</span><span class="sxs-lookup"><span data-stu-id="6dba5-282">Authorization Code Grant Client</span></span>

 <span data-ttu-id="6dba5-283">Dieser Client ist eine MVC-Anwendung.</span><span class="sxs-lookup"><span data-stu-id="6dba5-283">This client is an MVC application.</span></span> <span data-ttu-id="6dba5-284">Löst eine Authorization Code Grant-Datenfluss, um den Zugriff von Back-End-token zu erhalten.</span><span class="sxs-lookup"><span data-stu-id="6dba5-284">It will trigger an authorization code grant flow to get the access token from backend.</span></span> <span data-ttu-id="6dba5-285">Es wurde eine einzelne Seite, wie unten dargestellt:</span><span class="sxs-lookup"><span data-stu-id="6dba5-285">It has a single page as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image3.png)

- <span data-ttu-id="6dba5-286">Die **autorisieren** Schaltfläche Browser weitergeleitet wird, der autorisierungsserver, um den Besitzer der Ressource gewähren von Zugriff auf diesen Client zu benachrichtigen.</span><span class="sxs-lookup"><span data-stu-id="6dba5-286">The **Authorize** button will redirect browser to the authorization server to notify the resource owner to grant access to this client.</span></span>
- <span data-ttu-id="6dba5-287">Die **aktualisieren** Schaltfläche erhalten ein neues Zugriffstoken und Aktualisierungstoken, das die derzeitige Aktualisierung mit token.</span><span class="sxs-lookup"><span data-stu-id="6dba5-287">The **Refresh** button will get a new access token and refresh token using the current refresh token.</span></span>
- <span data-ttu-id="6dba5-288">Die **Zugriff geschützte Ressource API** Schaltfläche der Ressourcenserver zum Abrufen von Daten von Ansprüchen des aktuellen Benutzers, und zeigen sie auf der Seite aufgerufen wird.</span><span class="sxs-lookup"><span data-stu-id="6dba5-288">The **Access Protected Resource API** button will call the resource server to get current user's claims data and show them on the page.</span></span>

<span data-ttu-id="6dba5-289">Hier wird der Beispielcode die `HomeController` des Clients.</span><span class="sxs-lookup"><span data-stu-id="6dba5-289">Here is the sample code of the `HomeController` of the client.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample16.cs)]

<span data-ttu-id="6dba5-290">`DotNetOpenAuth`erfordert SSL standardmäßig an.</span><span class="sxs-lookup"><span data-stu-id="6dba5-290">`DotNetOpenAuth` requires SSL by default.</span></span> <span data-ttu-id="6dba5-291">Da der Demo HTTP verwendet wird, müssen Sie fügen folgende Einstellung in der Datei "App.config":</span><span class="sxs-lookup"><span data-stu-id="6dba5-291">Since our demo is using HTTP, you need to add following setting in the config file:</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample17.xml?highlight=4-6)]

> [!WARNING]
> <span data-ttu-id="6dba5-292">Sicherheit – nie deaktivieren SSL in einer Produktions-app.</span><span class="sxs-lookup"><span data-stu-id="6dba5-292">Security - Never disable SSL in a production app.</span></span> <span data-ttu-id="6dba5-293">Ihre Anmeldeinformationen werden jetzt in Klartext über das Netz gesendet wird.</span><span class="sxs-lookup"><span data-stu-id="6dba5-293">Your login credentials are now being sent in clear-text across the wire.</span></span> <span data-ttu-id="6dba5-294">Der obige Code ist nur für lokale Beispiel zu debuggen und das Durchsuchen.</span><span class="sxs-lookup"><span data-stu-id="6dba5-294">The code above is just for local sample debugging and exploration.</span></span>


### <a name="implicit-grant-client"></a><span data-ttu-id="6dba5-295">Implizite Grant-Client</span><span class="sxs-lookup"><span data-stu-id="6dba5-295">Implicit Grant Client</span></span>

<span data-ttu-id="6dba5-296">Dieser Client wird JavaScript zu verwenden:</span><span class="sxs-lookup"><span data-stu-id="6dba5-296">This client is using JavaScript to:</span></span>

1. <span data-ttu-id="6dba5-297">Öffnen Sie ein neues Fenster, und leiten Sie an den autorisierungsendpunkt des Autorisierungsservers.</span><span class="sxs-lookup"><span data-stu-id="6dba5-297">Open a new window and redirect to the authorize endpoint of the Authorization Server.</span></span>
2. <span data-ttu-id="6dba5-298">Abrufen des Zugriffstokens aus URL-Fragmente, wenn er wieder leitet.</span><span class="sxs-lookup"><span data-stu-id="6dba5-298">Get the access token from URL fragments when it redirects back.</span></span>

<span data-ttu-id="6dba5-299">Die folgende Abbildung veranschaulicht diesen Prozess:</span><span class="sxs-lookup"><span data-stu-id="6dba5-299">The following image shows this process:</span></span>

![](owin-oauth-20-authorization-server/_static/image4.png)

<span data-ttu-id="6dba5-300">Der Client sollte haben zwei Seiten: eine für die Startseite und das andere für den Rückruf. Hier ist die JavaScript-Code finden Sie im Beispiel die *Index.cshtml* Datei:</span><span class="sxs-lookup"><span data-stu-id="6dba5-300">The client should have two pages: one for home page and the other for callback.Here is the sample JavaScript code found in the *Index.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample18.cshtml)]

<span data-ttu-id="6dba5-301">Hier wird die Verarbeitung von Code im Rückruf *SignIn.cshtml* Datei:</span><span class="sxs-lookup"><span data-stu-id="6dba5-301">Here is the callback handling code in *SignIn.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample19.cshtml)]

> [!NOTE]
> <span data-ttu-id="6dba5-302">Eine bewährte Methode ist der JavaScript-Code in einer externen Datei verschoben, und nicht mit dem Razor-Markup einbetten.</span><span class="sxs-lookup"><span data-stu-id="6dba5-302">A best practice is to move the JavaScript to an external file and not embed it with the Razor markup.</span></span> <span data-ttu-id="6dba5-303">Um dieses Beispiel einfach zu halten, haben sie kombiniert.</span><span class="sxs-lookup"><span data-stu-id="6dba5-303">To keep this sample simple, they have been combined.</span></span>


### <a name="resource-owner-password-credentials-grant-client"></a><span data-ttu-id="6dba5-304">Das Kennwort des Ressourcenbesitzers Anmeldeinformationen Grant-Client</span><span class="sxs-lookup"><span data-stu-id="6dba5-304">Resource Owner Password Credentials Grant Client</span></span>

<span data-ttu-id="6dba5-305">Es verwendet eine Konsolen-app, um diesen Client demo.</span><span class="sxs-lookup"><span data-stu-id="6dba5-305">We uses a console app to demo this client.</span></span> <span data-ttu-id="6dba5-306">Hier ist der Code ein:</span><span class="sxs-lookup"><span data-stu-id="6dba5-306">Here is the code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample20.cs)]

### <a name="client-credentials-grant-client"></a><span data-ttu-id="6dba5-307">Clientanmeldeinformationen Grant-Client</span><span class="sxs-lookup"><span data-stu-id="6dba5-307">Client Credentials Grant Client</span></span>

<span data-ttu-id="6dba5-308">Die Kennwort-Anmeldeinformationen-Ressourcenbesitzererteilung, hier ähnelt Konsole app-Code:</span><span class="sxs-lookup"><span data-stu-id="6dba5-308">Similar to the Resource Owner Password Credentials Grant, here is console app code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample21.cs)]

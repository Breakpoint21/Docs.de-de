---
title: Testen von Controllerlogik in ASP.NET Core
author: ardalis
description: Informationen zum Testen von Controllerlogik in ASP.NET Core mit Moq und xUnit
ms.author: riande
ms.date: 10/14/2016
uid: mvc/controllers/testing
ms.openlocfilehash: d0b2a25d00187c088671be147844aa892f824c6e
ms.sourcegitcommit: 64c2ca86fff445944b155635918126165ee0f8aa
ms.translationtype: HT
ms.contentlocale: de-DE
ms.lasthandoff: 08/18/2018
ms.locfileid: "41751552"
---
# <a name="test-controller-logic-in-aspnet-core"></a><span data-ttu-id="47f8b-103">Testen von Controllerlogik in ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="47f8b-103">Test controller logic in ASP.NET Core</span></span>

<span data-ttu-id="47f8b-104">Von [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="47f8b-104">By [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="47f8b-105">Controller sind ein zentraler Bestandteil jeder ASP.NET Core MVC-Anwendung.</span><span class="sxs-lookup"><span data-stu-id="47f8b-105">Controllers are a central part of any ASP.NET Core MVC application.</span></span> <span data-ttu-id="47f8b-106">Daher sollten Sie auch darauf vertrauen können, dass sie in Ihrer App wie beabsichtigt funktionieren.</span><span class="sxs-lookup"><span data-stu-id="47f8b-106">As such, you should have confidence they behave as intended for your app.</span></span> <span data-ttu-id="47f8b-107">Automatisierte Tests können Ihnen dieses Vertrauen vermitteln. Sie können zudem dabei helfen, Fehler aufzudecken, bevor diese die Produktion erreichen.</span><span class="sxs-lookup"><span data-stu-id="47f8b-107">Automated tests can provide you with this confidence and can detect errors before they reach production.</span></span> <span data-ttu-id="47f8b-108">Sie sollten auf keinen Fall unnötige Aufgaben innerhalb der Controller platzieren. Zudem sollten die Tests ausschließlich auf die Controlleraufgaben ausgerichtet sein.</span><span class="sxs-lookup"><span data-stu-id="47f8b-108">It's important to avoid placing unnecessary responsibilities within your controllers and ensure your tests focus only on controller responsibilities.</span></span>

<span data-ttu-id="47f8b-109">Controllerlogik sollte minimal und nicht auf Geschäftslogik oder Infrastruktur ausgerichtet sein (wie z.B. Datenzugriff).</span><span class="sxs-lookup"><span data-stu-id="47f8b-109">Controller logic should be minimal and not be focused on business logic or infrastructure concerns (for example, data access).</span></span> <span data-ttu-id="47f8b-110">Testen Sie die Controllerlogik, nicht das Framework.</span><span class="sxs-lookup"><span data-stu-id="47f8b-110">Test controller logic, not the framework.</span></span> <span data-ttu-id="47f8b-111">Testen Sie das *Verhalten* des Controllers bei gültigen oder ungültigen Eingaben.</span><span class="sxs-lookup"><span data-stu-id="47f8b-111">Test how the controller *behaves* based on valid or invalid inputs.</span></span> <span data-ttu-id="47f8b-112">Testen Sie die Antworten des Controllers auf der Grundlage des Ergebnisses des Geschäftsvorgangs, den er ausführt.</span><span class="sxs-lookup"><span data-stu-id="47f8b-112">Test controller responses based on the result of the business operation it performs.</span></span>

<span data-ttu-id="47f8b-113">Typische Aufgaben des Controllers:</span><span class="sxs-lookup"><span data-stu-id="47f8b-113">Typical controller responsibilities:</span></span>

* <span data-ttu-id="47f8b-114">Überprüfen von `ModelState.IsValid`</span><span class="sxs-lookup"><span data-stu-id="47f8b-114">Verify `ModelState.IsValid`.</span></span>
* <span data-ttu-id="47f8b-115">Zurückgeben einer Fehlerantwort, wenn `ModelState` ungültig ist</span><span class="sxs-lookup"><span data-stu-id="47f8b-115">Return an error response if `ModelState` is invalid.</span></span>
* <span data-ttu-id="47f8b-116">Abrufen einer Geschäftsentität aus dem Persistenzspeicher</span><span class="sxs-lookup"><span data-stu-id="47f8b-116">Retrieve a business entity from persistence.</span></span>
* <span data-ttu-id="47f8b-117">Ausführen einer Aktion für die Geschäftsentität</span><span class="sxs-lookup"><span data-stu-id="47f8b-117">Perform an action on the business entity.</span></span>
* <span data-ttu-id="47f8b-118">Speichern der Geschäftsentität im Persistenzspeicher</span><span class="sxs-lookup"><span data-stu-id="47f8b-118">Save the business entity to persistence.</span></span>
* <span data-ttu-id="47f8b-119">Zurückgeben eines entsprechenden `IActionResult`</span><span class="sxs-lookup"><span data-stu-id="47f8b-119">Return an appropriate `IActionResult`.</span></span>

<span data-ttu-id="47f8b-120">[Anzeigen oder Herunterladen von Beispielcode](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample) ([Vorgehensweise zum Herunterladen](xref:tutorials/index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="47f8b-120">[View or download sample code](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample) ([how to download](xref:tutorials/index#how-to-download-a-sample))</span></span>

## <a name="unit-tests-of-controller-logic"></a><span data-ttu-id="47f8b-121">Komponententests der Controllerlogik</span><span class="sxs-lookup"><span data-stu-id="47f8b-121">Unit tests of controller logic</span></span>

<span data-ttu-id="47f8b-122">[Komponententests](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) beinhalten das Testen einer App-Komponente isoliert von ihrer Infrastruktur und ihren Abhängigkeiten.</span><span class="sxs-lookup"><span data-stu-id="47f8b-122">[Unit tests](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) involve testing a part of an app in isolation from its infrastructure and dependencies.</span></span> <span data-ttu-id="47f8b-123">Bei einem Komponententest der Controllerlogik werden nur die Inhalte einer einzelnen Aktion getestet, nicht das Verhalten ihrer Abhängigkeiten oder des Frameworks selbst.</span><span class="sxs-lookup"><span data-stu-id="47f8b-123">When unit testing controller logic, only the contents of a single action is tested, not the behavior of its dependencies or of the framework itself.</span></span> <span data-ttu-id="47f8b-124">Konzentrieren Sie sich bei der Durchführung eines Komponententests für Ihre Controlleraktionen daher nur auf deren Verhalten.</span><span class="sxs-lookup"><span data-stu-id="47f8b-124">As you unit test your controller actions, make sure you focus only on its behavior.</span></span> <span data-ttu-id="47f8b-125">Bei einem Komponententest des Controllers werden z.B. [Filter](xref:mvc/controllers/filters), [Routing](xref:fundamentals/routing), [Modellbindung](xref:mvc/models/model-binding) o.Ä. vermieden.</span><span class="sxs-lookup"><span data-stu-id="47f8b-125">A controller unit test avoids things like [filters](xref:mvc/controllers/filters), [routing](xref:fundamentals/routing), or [model binding](xref:mvc/models/model-binding).</span></span> <span data-ttu-id="47f8b-126">Durch die Fokussierung auf nur einen Aspekt sind Komponententests in der Regel einfach zu schreiben und schnell in der Ausführung.</span><span class="sxs-lookup"><span data-stu-id="47f8b-126">By focusing on testing just one thing, unit tests are generally simple to write and quick to run.</span></span> <span data-ttu-id="47f8b-127">Gut geschriebene Komponententests können häufig ohne großen Mehraufwand ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="47f8b-127">A well-written set of unit tests can be run frequently without much overhead.</span></span> <span data-ttu-id="47f8b-128">Komponententests erkennen jedoch keine Probleme bei der Interaktion zwischen den Komponenten. Dazu dienen [Integrationstests](xref:test/integration-tests).</span><span class="sxs-lookup"><span data-stu-id="47f8b-128">However, unit tests don't detect issues in the interaction between components, which is the purpose of [integration tests](xref:test/integration-tests).</span></span>

<span data-ttu-id="47f8b-129">Wenn Sie benutzerdefinierte Filter und Routen schreiben, sollten Sie für diese isoliert einen Komponententest durchführen, der nicht Bestandteil eines Tests für eine bestimmte Controlleraktion ist.</span><span class="sxs-lookup"><span data-stu-id="47f8b-129">If you're writing custom filters and routes, you should unit test them in isolation, not as part of your tests on a particular controller action.</span></span>

> [!TIP]
> <span data-ttu-id="47f8b-130">[Erstellen und Ausführen von Komponententests mit Visual Studio](/visualstudio/test/unit-test-your-code).</span><span class="sxs-lookup"><span data-stu-id="47f8b-130">[Create and run unit tests with Visual Studio](/visualstudio/test/unit-test-your-code).</span></span>

<span data-ttu-id="47f8b-131">Überprüfen Sie den folgenden Controller, um Komponententests zu veranschaulichen.</span><span class="sxs-lookup"><span data-stu-id="47f8b-131">To demonstrate unit testing, review the following controller.</span></span> <span data-ttu-id="47f8b-132">Es wird eine Liste von Brainstormingsitzungen angezeigt. Außerdem können neue Brainstormingsitzungen mit einer POST-Anforderung erstellt werden:</span><span class="sxs-lookup"><span data-stu-id="47f8b-132">It displays a list of brainstorming sessions and allows new brainstorming sessions to be created with a POST:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/HomeController.cs?highlight=12,16,21,42,43)]

<span data-ttu-id="47f8b-133">Der Controller befolgt das [Prinzip der expliziten Abhängigkeiten](http://deviq.com/explicit-dependencies-principle/). Es wird Dependency Injection erwartet, wodurch dem Controller eine Instanz von `IBrainstormSessionRepository` bereitgestellt wird.</span><span class="sxs-lookup"><span data-stu-id="47f8b-133">The controller is following the [explicit dependencies principle](http://deviq.com/explicit-dependencies-principle/), expecting dependency injection to provide it with an instance of `IBrainstormSessionRepository`.</span></span> <span data-ttu-id="47f8b-134">Dadurch kann der Test relativ leicht mithilfe eines Pseudoobjektframeworks, wie z.B. [Moq](https://www.nuget.org/packages/Moq/), ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="47f8b-134">This makes it fairly easy to test using a mock object framework, like [Moq](https://www.nuget.org/packages/Moq/).</span></span> <span data-ttu-id="47f8b-135">Die `HTTP GET Index`-Methode verfügt weder über Schleifen noch über Verzweigungen und ruft nur eine Methode auf.</span><span class="sxs-lookup"><span data-stu-id="47f8b-135">The `HTTP GET Index` method has no looping or branching and only calls one method.</span></span> <span data-ttu-id="47f8b-136">Zum Testen der `Index`-Methode muss überprüft werden, ob ein `ViewResult` zurückgegeben wird, mit einem `ViewModel` aus der `List`-Methode des Repositorys.</span><span class="sxs-lookup"><span data-stu-id="47f8b-136">To test this `Index` method, we need to verify that a `ViewResult` is returned, with a `ViewModel` from the repository's `List` method.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=17-18&range=1-33,76-95)]

<span data-ttu-id="47f8b-137">Mit der `HomeController`-`HTTP POST Index`-Methode (siehe oben) sollte Folgendes überprüft werden:</span><span class="sxs-lookup"><span data-stu-id="47f8b-137">The `HomeController` `HTTP POST Index` method (shown above) should verify:</span></span>

* <span data-ttu-id="47f8b-138">Die Aktionsmethode gibt für `ViewResult` eine ungültige Anforderung zurück mit den entsprechenden Daten, wenn `ModelState.IsValid` `false` ist.</span><span class="sxs-lookup"><span data-stu-id="47f8b-138">The action method returns a Bad Request `ViewResult` with the appropriate data when `ModelState.IsValid` is `false`.</span></span>

* <span data-ttu-id="47f8b-139">Die `Add`-Methode im Repository wird aufgerufen, und ein `RedirectToActionResult` mit den korrekten Argumenten wird zurückgegeben, wenn `ModelState.IsValid` TRUE ist.</span><span class="sxs-lookup"><span data-stu-id="47f8b-139">The `Add` method on the repository is called and a `RedirectToActionResult` is returned with the correct arguments when `ModelState.IsValid` is true.</span></span>

<span data-ttu-id="47f8b-140">Ein ungültiger Modellstatus kann getestet werden, indem mithilfe von `AddModelError` wie im ersten Test unten gezeigt Fehler hinzugefügt werden.</span><span class="sxs-lookup"><span data-stu-id="47f8b-140">Invalid model state can be tested by adding errors using `AddModelError` as shown in the first test below.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=8,15-16,37-39&range=35-75)]

<span data-ttu-id="47f8b-141">Im ersten Test wird bestätigt, dass bei ungültigem `ModelState` das gleiche `ViewResult` zurückgegeben wird wie für eine `GET`-Anforderung.</span><span class="sxs-lookup"><span data-stu-id="47f8b-141">The first test confirms when `ModelState` isn't valid, the same `ViewResult` is returned as for a `GET` request.</span></span> <span data-ttu-id="47f8b-142">Beachten Sie, dass der Test für ein ungültiges Modell gar nicht erfolgreich durchgeführt werden soll.</span><span class="sxs-lookup"><span data-stu-id="47f8b-142">Note that the test doesn't attempt to pass in an invalid model.</span></span> <span data-ttu-id="47f8b-143">Da die Modellbindung nicht ausgeführt wird, wäre dies ohnehin nicht möglich (obwohl bei einem [Integrationstest](xref:test/integration-tests) eine Trainingsmodellbindung verwendet wird).</span><span class="sxs-lookup"><span data-stu-id="47f8b-143">That wouldn't work anyway since model binding isn't running (though an [integration test](xref:test/integration-tests) would use exercise model binding).</span></span> <span data-ttu-id="47f8b-144">In diesem Fall wird nicht die Modellbindung getestet.</span><span class="sxs-lookup"><span data-stu-id="47f8b-144">In this case, model binding isn't being tested.</span></span> <span data-ttu-id="47f8b-145">Bei diesen Komponententests wird nur das Verhalten des Codes in der Aktionsmethode getestet.</span><span class="sxs-lookup"><span data-stu-id="47f8b-145">These unit tests are only testing what the code in the action method does.</span></span>

<span data-ttu-id="47f8b-146">Im zweiten Test wird überprüft, ob bei gültigem `ModelState` eine neue `BrainstormSession` (über das Repository) hinzugefügt wird. Die Methode gibt ein `RedirectToActionResult` mit den erwarteten Eigenschaften zurück.</span><span class="sxs-lookup"><span data-stu-id="47f8b-146">The second test verifies that when `ModelState` is valid, a new `BrainstormSession` is added (via the repository), and the method returns a `RedirectToActionResult` with the expected properties.</span></span> <span data-ttu-id="47f8b-147">Simulierte Aufrufe, die nicht aufgerufen werden, werden normalerweise ignoriert. Durch Aufrufen von `Verifiable` am Ende des Einrichtungsaufrufs können sie im Test jedoch überprüft werden.</span><span class="sxs-lookup"><span data-stu-id="47f8b-147">Mocked calls that aren't called are normally ignored, but calling `Verifiable` at the end of the setup call allows it to be verified in the test.</span></span> <span data-ttu-id="47f8b-148">Dies erfolgt mit dem Aufruf `mockRepo.Verify`. Damit schlägt der Test fehl, wenn die erwartete Methode nicht aufgerufen wurde.</span><span class="sxs-lookup"><span data-stu-id="47f8b-148">This is done with the call to `mockRepo.Verify`, which will fail the test if the expected method wasn't called.</span></span>

> [!NOTE]
> <span data-ttu-id="47f8b-149">Mit der in diesem Beispiel verwendeten Moq-Bibliothek können überprüfbare (oder „strikte“) Pseudoobjekte mit nicht überprüfbaren Pseudoobjekten (auch „nicht-strikte“ Pseudoobjekte oder „Stubs“ genannt) ganz einfach kombiniert werden.</span><span class="sxs-lookup"><span data-stu-id="47f8b-149">The Moq library used in this sample makes it easy to mix verifiable, or "strict", mocks with non-verifiable mocks (also called "loose" mocks or stubs).</span></span> <span data-ttu-id="47f8b-150">Weitere Informationen finden Sie unter [Customizing Mock behavior with Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior) (Anpassen des Verhaltens von Pseudoobjekten mit Moq).</span><span class="sxs-lookup"><span data-stu-id="47f8b-150">Learn more about [customizing Mock behavior with Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span></span>

<span data-ttu-id="47f8b-151">Ein anderer Controller in der App zeigt Informationen zu einer bestimmten Brainstormingsitzung an.</span><span class="sxs-lookup"><span data-stu-id="47f8b-151">Another controller in the app displays information related to a particular brainstorming session.</span></span> <span data-ttu-id="47f8b-152">Er verfügt auch über Programmlogik für den Umgang mit ungültigen ID-Werten:</span><span class="sxs-lookup"><span data-stu-id="47f8b-152">It includes some logic to deal with invalid id values:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/SessionController.cs?highlight=19,20,21,22,25,26,27,28)]

<span data-ttu-id="47f8b-153">Die Controlleraktion verfügt über drei Fälle, die getestet werden können, und zwar einen für jede `return`-Anweisung:</span><span class="sxs-lookup"><span data-stu-id="47f8b-153">The controller action has three cases to test, one for each `return` statement:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/SessionControllerTests.cs?highlight=27,28,29,46,47,64,65,66,67,68)]

<span data-ttu-id="47f8b-154">Die App stellt Funktionen als Web-API bereit (eine Liste mit Ideen, die einer Brainstormingsitzung zugeordnet werden, sowie eine Methode zum Hinzufügen von neuen Ideen zu einer Sitzung):</span><span class="sxs-lookup"><span data-stu-id="47f8b-154">The app exposes functionality as a web API (a list of ideas associated with a brainstorming session and a method for adding new ideas to a session):</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Api/IdeasController.cs?highlight=21,22,27,30,31,32,33,34,35,36,41,42,46,52,65)]

<span data-ttu-id="47f8b-155">Die `ForSession`-Methode gibt eine Liste von `IdeaDTO`-Typen zurück.</span><span class="sxs-lookup"><span data-stu-id="47f8b-155">The `ForSession` method returns a list of `IdeaDTO` types.</span></span> <span data-ttu-id="47f8b-156">Geben Sie Ihre Geschäftsdomänenentitäten nicht direkt über API-Aufrufe zurück, da sie häufig mehr Daten enthalten, als die Client-API anfordert. Außerdem verknüpfen sie unnötigerweise das interne Domänenmodell Ihrer App mit der extern zur Verfügung gestellten API.</span><span class="sxs-lookup"><span data-stu-id="47f8b-156">Avoid returning your business domain entities directly via API calls, since frequently they include more data than the API client requires, and they unnecessarily couple your app's internal domain model with the API you expose externally.</span></span> <span data-ttu-id="47f8b-157">Die Zuordnung zwischen Domänenentitäten und den Typen, die Sie über das Netzwerk zurückgeben, kann manuell ausgeführt werden (wie hier gezeigt mithilfe von LINQ-`Select`) oder mithilfe einer Bibliothek wie etwa [AutoMapper](https://github.com/AutoMapper/AutoMapper).</span><span class="sxs-lookup"><span data-stu-id="47f8b-157">Mapping between domain entities and the types you will return over the wire can be done manually (using a LINQ `Select` as shown here) or using a library like [AutoMapper](https://github.com/AutoMapper/AutoMapper).</span></span>

<span data-ttu-id="47f8b-158">Die Komponententests für die API-Methoden `Create` und `ForSession`:</span><span class="sxs-lookup"><span data-stu-id="47f8b-158">The unit tests for the `Create` and `ForSession` API methods:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/ApiIdeasControllerTests.cs?highlight=18,23,29,33,38-39,43,50,58-59,68-70,76-78&range=1-83,121-135)]

<span data-ttu-id="47f8b-159">Fügen Sie wie bereits erwähnt dem Controller einen Modellfehler als Teil des Tests hinzu, um das Verhalten der Methode bei ungültigem `ModelState` zu testen.</span><span class="sxs-lookup"><span data-stu-id="47f8b-159">As stated previously, to test the behavior of the method when `ModelState` is invalid, add a model error to the controller as part of the test.</span></span> <span data-ttu-id="47f8b-160">Testen Sie in den Komponententests nicht die Modellvalidierung oder -bindung. Testen Sie nur das Verhalten Ihrer Aktionsmethode bei einem bestimmten `ModelState`-Wert.</span><span class="sxs-lookup"><span data-stu-id="47f8b-160">Don't try to test model validation or model binding in your unit tests - just test your action method's behavior when confronted with a particular `ModelState` value.</span></span>

<span data-ttu-id="47f8b-161">Der zweite Test hängt davon ab, ob das Repository NULL zurückgibt. Daher wird das Pseudorepository so konfiguriert, dass es NULL zurückgibt.</span><span class="sxs-lookup"><span data-stu-id="47f8b-161">The second test depends on the repository returning null, so the mock repository is configured to return null.</span></span> <span data-ttu-id="47f8b-162">Es ist nicht nötig, eine Testdatenbank (z.B. im Arbeitsspeicher) und eine Abfrage zu erstellen, die dieses Ergebnis zurückgibt. Dies können Sie auch wie bereits gezeigt in einer einzigen Anweisung erledigen.</span><span class="sxs-lookup"><span data-stu-id="47f8b-162">There's no need to create a test database (in memory or otherwise) and construct a query that will return this result - it can be done in a single statement as shown.</span></span>

<span data-ttu-id="47f8b-163">Im letzten Test wird überprüft, ob die `Update`-Methode des Repositorys aufgerufen wird.</span><span class="sxs-lookup"><span data-stu-id="47f8b-163">The last test verifies that the repository's `Update` method is called.</span></span> <span data-ttu-id="47f8b-164">Wie schon zuvor wird das Pseudoobjekt mit `Verifiable` aufgerufen. Anschließend wird die `Verify`-Methode des Pseudorepositorys aufgerufen, um zu bestätigen, dass die überprüfbare Methode ausgeführt wurde.</span><span class="sxs-lookup"><span data-stu-id="47f8b-164">As we did previously, the mock is called with `Verifiable` and then the mocked repository's `Verify` method is called to confirm the verifiable method was executed.</span></span> <span data-ttu-id="47f8b-165">Es gehört nicht zu den Aufgaben eines Komponententests sicherzustellen, dass die Daten von der `Update`-Methode gespeichert wurden. Dies kann mit einem Integrationstest durchgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="47f8b-165">It's not a unit test responsibility to ensure that the `Update` method saved the data; that can be done with an integration test.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="47f8b-166">Zusätzliche Ressourcen</span><span class="sxs-lookup"><span data-stu-id="47f8b-166">Additional resources</span></span>

* <xref:test/integration-tests>

---
title: Azure Key Vault-Konfigurationsanbieter
author: guardrex
description: Erfahren Sie, wie der Azure Key Vault-Konfigurationsanbieter verwenden Sie zum Konfigurieren einer Anwendung mithilfe von Name / Wert-Paaren, die zur Laufzeit geladen.
manager: wpickett
ms.author: riande
ms.date: 08/09/2017
ms.prod: asp.net-core
ms.topic: article
uid: security/key-vault-configuration
ms.openlocfilehash: 1a91a87fb90d4d4651e07f32415e4364c8e2d993
ms.sourcegitcommit: b83a5f731a9c02bdb1cc1e3f9a8bf273eb5b33e0
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 02/11/2018
---
# <a name="azure-key-vault-configuration-provider"></a><span data-ttu-id="8cbb3-103">Azure Key Vault-Konfigurationsanbieter</span><span class="sxs-lookup"><span data-stu-id="8cbb3-103">Azure Key Vault configuration provider</span></span>

<span data-ttu-id="8cbb3-104">Durch [Luke Latham](https://github.com/guardrex) und [Andrew Stanton-Versicherungsfachleuten](https://github.com/anurse)</span><span class="sxs-lookup"><span data-stu-id="8cbb3-104">By [Luke Latham](https://github.com/guardrex) and [Andrew Stanton-Nurse](https://github.com/anurse)</span></span>

# <a name="aspnet-core-2xtabaspnetcore2x"></a>[<span data-ttu-id="8cbb3-105">ASP.NET Core 2.x</span><span class="sxs-lookup"><span data-stu-id="8cbb3-105">ASP.NET Core 2.x</span></span>](#tab/aspnetcore2x)

<span data-ttu-id="8cbb3-106">Anzeigen oder Herunterladen von Beispielcode für 2.x:</span><span class="sxs-lookup"><span data-stu-id="8cbb3-106">View or download sample code for 2.x:</span></span>

* <span data-ttu-id="8cbb3-107">[Beispiel eines grundlegenden](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/2.x) ([zum Herunterladen von](xref:tutorials/index#how-to-download-a-sample))-geheimen Werte in eine app liest.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-107">[Basic sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/2.x) ([how to download](xref:tutorials/index#how-to-download-a-sample)) - Reads secret values into an app.</span></span>
* <span data-ttu-id="8cbb3-108">[Schlüsselname Präfix Beispiel](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/2.x) ([zum Herunterladen von](xref:tutorials/index#how-to-download-a-sample)) – Lesevorgänge geheimen Werte, die mit dem Schlüsselnamen-Präfix, das die Version einer App, die Ihnen ermöglicht darstellt, einen anderen Satz von geheimen Werten für jede app-Version zu laden.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-108">[Key name prefix sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/2.x) ([how to download](xref:tutorials/index#how-to-download-a-sample)) - Reads secret values using a key name prefix that represents the version of an app, which allows you to load a different set of secret values for each app version.</span></span>

# <a name="aspnet-core-1xtabaspnetcore1x"></a>[<span data-ttu-id="8cbb3-109">ASP.NET Core 1.x</span><span class="sxs-lookup"><span data-stu-id="8cbb3-109">ASP.NET Core 1.x</span></span>](#tab/aspnetcore1x)

<span data-ttu-id="8cbb3-110">Anzeigen oder Herunterladen von Beispielcode für 1.x:</span><span class="sxs-lookup"><span data-stu-id="8cbb3-110">View or download sample code for 1.x:</span></span>

* <span data-ttu-id="8cbb3-111">[Beispiel eines grundlegenden](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/1.x) ([zum Herunterladen von](xref:tutorials/index#how-to-download-a-sample))-geheimen Werte in eine app liest.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-111">[Basic sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/1.x) ([how to download](xref:tutorials/index#how-to-download-a-sample)) - Reads secret values into an app.</span></span>
* <span data-ttu-id="8cbb3-112">[Schlüsselname Präfix Beispiel](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/1.x) ([zum Herunterladen von](xref:tutorials/index#how-to-download-a-sample)) – Lesevorgänge geheimen Werte, die mit dem Schlüsselnamen-Präfix, das die Version einer App, die Ihnen ermöglicht darstellt, einen anderen Satz von geheimen Werten für jede app-Version zu laden.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-112">[Key name prefix sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/1.x) ([how to download](xref:tutorials/index#how-to-download-a-sample)) - Reads secret values using a key name prefix that represents the version of an app, which allows you to load a different set of secret values for each app version.</span></span> 

---

<span data-ttu-id="8cbb3-113">Dieses Dokument erläutert die Verwendung der [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) Konfigurationsanbieter Konfigurationswerte für die Anwendung aus Azure Key Vault geheime Schlüssel geladen.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-113">This document explains how to use the [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) configuration provider to load application configuration values from Azure Key Vault secrets.</span></span> <span data-ttu-id="8cbb3-114">Azure Key Vault ist ein cloudbasierter Dienst, mit dem Sie kryptografischer und geheimer Schlüssel apps und Dienste zu schützen.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-114">Azure Key Vault is a cloud-based service that helps you safeguard cryptographic keys and secrets used by apps and services.</span></span> <span data-ttu-id="8cbb3-115">Häufige Szenarien sind das Steuern des Zugriffs auf sensible Konfigurationsdaten und validiert Hardwaresicherheitsmodulen (HSM) Erfüllung der Anforderung für FIPS 140-2 Level 2 werden, wenn Konfigurationsdaten zu speichern.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-115">Common scenarios include controlling access to sensitive configuration data and meeting the requirement for FIPS 140-2 Level 2 validated Hardware Security Modules (HSM's) when storing configuration data.</span></span> <span data-ttu-id="8cbb3-116">Diese Funktion ist verfügbar für Anwendungen, die als ASP.NET Core 1.1 Ziel oder höher.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-116">This feature is available for applications that target ASP.NET Core 1.1 or higher.</span></span>

## <a name="package"></a><span data-ttu-id="8cbb3-117">Package</span><span class="sxs-lookup"><span data-stu-id="8cbb3-117">Package</span></span>
<span data-ttu-id="8cbb3-118">Um den Anbieter zu verwenden, fügen Sie einen Verweis auf die [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) Paket.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-118">To use the provider, add a reference to the [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) package.</span></span>

## <a name="application-configuration"></a><span data-ttu-id="8cbb3-119">Anwendungskonfiguration</span><span class="sxs-lookup"><span data-stu-id="8cbb3-119">Application configuration</span></span>
<span data-ttu-id="8cbb3-120">Untersuchen Sie den Anbieter mit der [Beispiel-apps](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span><span class="sxs-lookup"><span data-stu-id="8cbb3-120">You can explore the provider with the [sample apps](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span></span> <span data-ttu-id="8cbb3-121">Nachdem Sie einen schlüsseltresor herstellen und geheimen Schlüssel im Tresor erstellen, laden die Werte für den geheimen in ihre Konfigurationen die beispielapps sicher und in Webseiten anzuzeigen.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-121">Once you establish a key vault and create secrets in the vault, the sample apps securely load the secret values into their configurations and display them in webpages.</span></span>

<span data-ttu-id="8cbb3-122">Der Anbieter wurde die `ConfigurationBuilder` mit der `AddAzureKeyVault` Erweiterung.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-122">The provider is added to the `ConfigurationBuilder` with the `AddAzureKeyVault` extension.</span></span> <span data-ttu-id="8cbb3-123">In der Beispiel-apps, die Erweiterung verwendet drei Konfigurationswerte aus geladen der *appsettings.json* Datei.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-123">In the sample apps, the extension uses three configuration values loaded from the *appsettings.json* file.</span></span>

| <span data-ttu-id="8cbb3-124">App-Einstellung</span><span class="sxs-lookup"><span data-stu-id="8cbb3-124">App Setting</span></span>    | <span data-ttu-id="8cbb3-125">Beschreibung</span><span class="sxs-lookup"><span data-stu-id="8cbb3-125">Description</span></span>                    | <span data-ttu-id="8cbb3-126">Beispiel</span><span class="sxs-lookup"><span data-stu-id="8cbb3-126">Example</span></span>                                      |
| -------------- | ------------------------------ | -------------------------------------------- |
| `Vault`        | <span data-ttu-id="8cbb3-127">Azure Key Vault-name</span><span class="sxs-lookup"><span data-stu-id="8cbb3-127">Azure Key Vault name</span></span>           | <span data-ttu-id="8cbb3-128">contosovault</span><span class="sxs-lookup"><span data-stu-id="8cbb3-128">contosovault</span></span>                                 |
| `ClientId`     | <span data-ttu-id="8cbb3-129">Azure Active Directory-App-Id</span><span class="sxs-lookup"><span data-stu-id="8cbb3-129">Azure Active Directory App Id</span></span>  | <span data-ttu-id="8cbb3-130">627e911e-43cc-61d4-992e-12db9c81b413</span><span class="sxs-lookup"><span data-stu-id="8cbb3-130">627e911e-43cc-61d4-992e-12db9c81b413</span></span>         |
| `ClientSecret` | <span data-ttu-id="8cbb3-131">Azure Active Directory-Anwendungsschlüssel</span><span class="sxs-lookup"><span data-stu-id="8cbb3-131">Azure Active Directory App Key</span></span> | <span data-ttu-id="8cbb3-132">g58K3dtg59o1Pa+e59v2Tx829w6VxTB2yv9sv/101di=</span><span class="sxs-lookup"><span data-stu-id="8cbb3-132">g58K3dtg59o1Pa+e59v2Tx829w6VxTB2yv9sv/101di=</span></span> |

[!code-csharp[Program](key-vault-configuration/samples/basic-sample/2.x/Program.cs?name=snippet1&highlight=2,7-10)]

## <a name="creating-key-vault-secrets-and-loading-configuration-values-basic-sample"></a><span data-ttu-id="8cbb3-133">Schlüsseltresor geheime Schlüssel erstellen und das Laden von Konfigurationswerten (Basic-Beispiel)</span><span class="sxs-lookup"><span data-stu-id="8cbb3-133">Creating key vault secrets and loading configuration values (basic-sample)</span></span>
1. <span data-ttu-id="8cbb3-134">Erstellen eines schlüsseltresors und Einrichten von Azure Active Directory (Azure AD) für die Anwendung gemäß der Anleitung in [erste Schritte mit Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="8cbb3-134">Create a key vault and set up Azure Active Directory (Azure AD) for the application following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
  * <span data-ttu-id="8cbb3-135">Fügen Sie geheime Schlüssel mit dem schlüsseltresor die [AzureRM Key Vault-PowerShell-Modul](/powershell/module/azurerm.keyvault) verfügbar der [PowerShell-Katalog](https://www.powershellgallery.com/packages/AzureRM.KeyVault), die [REST-API von Azure Key Vault](/rest/api/keyvault/), oder die [Azure-Portal](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="8cbb3-135">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="8cbb3-136">Geheime Schlüssel werden erstellt, entweder als *manuell* oder *Zertifikat* geheime Schlüssel.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-136">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="8cbb3-137">*Zertifikat* geheime Schlüssel sind die Zertifikate für die Verwendung durch apps und Dienste, aber werden nicht unterstützt, indem Sie den Konfigurationsanbieter.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-137">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="8cbb3-138">Verwenden Sie die *manuell* Option zum Erstellen von Name / Wert-Paar geheime Schlüssel für die Verwendung mit den Konfigurationsanbieter.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-138">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
    * <span data-ttu-id="8cbb3-139">Einfache Kennwörter werden als Name / Wert-Paare erstellt.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-139">Simple secrets are created as name-value pairs.</span></span> <span data-ttu-id="8cbb3-140">Azure Key Vault geheime Namen sind nur alphanumerische Zeichen und Bindestriche enthalten.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-140">Azure Key Vault secret names are limited to alphanumeric characters and dashes.</span></span>
    * <span data-ttu-id="8cbb3-141">Verwenden Sie hierarchische Werte (Konfigurationsabschnitte) `--` (zwei Bindestriche) als Trennzeichen in der Stichprobe.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-141">Hierarchical values (configuration sections) use `--` (two dashes) as a separator in the sample.</span></span> <span data-ttu-id="8cbb3-142">Doppelpunkte, die normalerweise, zur Begrenzung von eines Abschnitts über einen Unterschlüssel in verwendet werden [ASP.NET kernkonfiguration](xref:fundamentals/configuration/index), für den geheimen Namen sind nicht zulässig.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-142">Colons, which are normally used to delimit a section from a subkey in [ASP.NET Core configuration](xref:fundamentals/configuration/index), aren't allowed in secret names.</span></span> <span data-ttu-id="8cbb3-143">Aus diesem Grund sind zwei Bindestriche verwendet und für einen Doppelpunkt ausgetauscht werden, wenn der geheime Schlüssel in der app-Konfiguration geladen werden.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-143">Therefore, two dashes are used and swapped for a colon when the secrets are loaded into the app's configuration.</span></span>
    * <span data-ttu-id="8cbb3-144">Erstellen Sie zwei *manuell* geheime Schlüssel mit den folgenden Name / Wert-Paaren.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-144">Create two *Manual* secrets with the following name-value pairs.</span></span> <span data-ttu-id="8cbb3-145">Der erste geheime Schlüssel ist ein einfacher Name und Wert und der zweiten geheimen Schlüssel erstellt einen geheimen Wert mit einem Abschnitt und der Unterschlüssel im Namen geheimen Schlüssels:</span><span class="sxs-lookup"><span data-stu-id="8cbb3-145">The first secret is a simple name and value, and the second secret creates a secret value with a section and subkey in the secret name:</span></span>
      * <span data-ttu-id="8cbb3-146">`SecretName`: `secret_value_1`</span><span class="sxs-lookup"><span data-stu-id="8cbb3-146">`SecretName`: `secret_value_1`</span></span>
      * <span data-ttu-id="8cbb3-147">`Section--SecretName`: `secret_value_2`</span><span class="sxs-lookup"><span data-stu-id="8cbb3-147">`Section--SecretName`: `secret_value_2`</span></span>
  * <span data-ttu-id="8cbb3-148">Registrieren der Beispiel-app bei Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-148">Register the sample app with Azure Active Directory.</span></span>
  * <span data-ttu-id="8cbb3-149">Autorisieren Sie die app auf den schlüsseltresor zugreifen.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-149">Authorize the app to access the key vault.</span></span> <span data-ttu-id="8cbb3-150">Bei Verwendung der `Set-AzureRmKeyVaultAccessPolicy` PowerShell-Cmdlet zum Autorisieren der app, Zugriff auf den schlüsseltresor, bieten `List` und `Get` Zugriff auf geheime Schlüssel mit `-PermissionsToSecrets list,get`.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-150">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToSecrets list,get`.</span></span>
2. <span data-ttu-id="8cbb3-151">Aktualisieren Sie der app *appsettings.json* Datei mit den Werten der `Vault`, `ClientId`, und `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-151">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="8cbb3-152">Führen Sie die Beispielapp, das erhält seine Konfigurationswerte aus `IConfigurationRoot` mit dem gleichen Namen wie den Namen des geheimen Schlüssels.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-152">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the secret name.</span></span>
  * <span data-ttu-id="8cbb3-153">Nicht-hierarchischen Werten: der Wert für `SecretName` abgerufen wird, mit `config["SecretName"]`.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-153">Non-hierarchical values: The value for `SecretName` is obtained with `config["SecretName"]`.</span></span>
  * <span data-ttu-id="8cbb3-154">Hierarchische Werte (Abschnitte): Verwendung `:` (Doppelpunkt)-Notation oder `GetSection` Erweiterungsmethode.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-154">Hierarchical values (sections): Use `:` (colon) notation or the `GetSection` extension method.</span></span> <span data-ttu-id="8cbb3-155">Verwenden Sie einen dieser Ansätze, um den Konfigurationswert zu erhalten:</span><span class="sxs-lookup"><span data-stu-id="8cbb3-155">Use either of these approaches to obtain the configuration value:</span></span>
    * `config["Section:SecretName"]`
    * `config.GetSection("Section")["SecretName"]`

<span data-ttu-id="8cbb3-156">Beim Ausführen der app zeigt eine Webseite für den geheimen geladenen Werte:</span><span class="sxs-lookup"><span data-stu-id="8cbb3-156">When you run the app, a webpage shows the loaded secret values:</span></span>

![Browserfenster, die mit geheimen Werte, die über den Azure Key Vault Konfigurationsanbieter geladen](key-vault-configuration/_static/sample1.png)

## <a name="creating-prefixed-key-vault-secrets-and-loading-configuration-values-key-name-prefix-sample"></a><span data-ttu-id="8cbb3-158">Mit Präfix schlüsseltresor. geheime Schlüssel erstellen und das Laden von Konfigurationswerten (Key-Name-Präfix-Beispiel)</span><span class="sxs-lookup"><span data-stu-id="8cbb3-158">Creating prefixed key vault secrets and loading configuration values (key-name-prefix-sample)</span></span>
<span data-ttu-id="8cbb3-159">`AddAzureKeyVault`bietet außerdem eine Überladung, die eine Implementierung der akzeptiert `IKeyVaultSecretManager`, womit Sie steuern, wie Key Vault-Schlüssel in Konfigurationsschlüssel konvertiert werden.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-159">`AddAzureKeyVault` also provides an overload that accepts an implementation of `IKeyVaultSecretManager`, which allows you to control how key vault secrets are converted into configuration keys.</span></span> <span data-ttu-id="8cbb3-160">Beispielsweise können Sie die Schnittstelle, um geheime Werte basierend auf einem Präfixwert, die, den Sie beim Starten der app bereitstellen, laden implementieren.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-160">For example, you can implement the interface to load secret values based on a prefix value you provide at app startup.</span></span> <span data-ttu-id="8cbb3-161">Dadurch können Sie z. B. um Geheimnisse anhand der Version der app geladen werden.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-161">This allows you, for example, to load secrets based on the version of the app.</span></span>

> [!WARNING]
> <span data-ttu-id="8cbb3-162">Verwenden Sie keine Präfixe auf schlüsseltresor geheime Schlüssel zum Ablegen geheime Schlüssel für mehrere apps im selben schlüsseltresor wird oder dass environmental geheime Schlüssel (z. B. *Entwicklung* im Vergleich zu *Produktion* geheime Schlüssel) in der gleichen Tresor.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-162">Don't use prefixes on key vault secrets to place secrets for multiple apps into the same key vault or to place environmental secrets (for example, *development* versus *production* secrets) into the same vault.</span></span> <span data-ttu-id="8cbb3-163">Es wird empfohlen, dass anderer apps und Entwicklung/produktionsumgebungen verwenden Sie separate Schlüssel Tresore zum Isolieren von app-Umgebungen für das höchste Maß an Sicherheit.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-163">We recommend that different apps and development/production environments use separate key vaults to isolate app environments for the highest level of security.</span></span>

<span data-ttu-id="8cbb3-164">Verwenden das zweite Beispiel-app, einen geheimen Schlüssel im schlüsseltresor für erstellen `5000-AppSecret` (Punkte sind nicht zulässig, in der für den geheimen schlüsseltresornamen), ein app-Geheimnis für app-Version 5.0.0.0 darstellt.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-164">Using the second sample app, you create a secret in the key vault for `5000-AppSecret` (periods aren't allowed in key vault secret names) representing an app secret for version 5.0.0.0 of your app.</span></span> <span data-ttu-id="8cbb3-165">Für eine andere Version, 5.1.0.0, erstellen Sie einen geheimen Schlüssel für `5100-AppSecret`.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-165">For another version, 5.1.0.0, you create a secret for `5100-AppSecret`.</span></span> <span data-ttu-id="8cbb3-166">Jede Version der app lädt einen eigenen geheimen Wert in seine Konfiguration als `AppSecret`, Ausblasegerät die Version, die den geheimen Schlüssel geladen.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-166">Each app version loads its own secret value into its configuration as `AppSecret`, stripping off the version as it loads the secret.</span></span> <span data-ttu-id="8cbb3-167">Das Beispiel für die Implementierung wird unten gezeigt:</span><span class="sxs-lookup"><span data-stu-id="8cbb3-167">The sample's implementation is shown below:</span></span>

[!code-csharp[Configuration builder](key-vault-configuration/samples/key-name-prefix-sample/2.x/Program.cs?name=snippet1&highlight=12)]

[!code-csharp[PrefixKeyVaultSecretManager](key-vault-configuration/samples/key-name-prefix-sample/2.x/Startup.cs?name=snippet1)]

<span data-ttu-id="8cbb3-168">Die `Load` Methode wird aufgerufen, von einem anbieteralgorithmus, der die geheimen Tresor auf diejenigen zu suchen, die das Präfix Version haben durchläuft.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-168">The `Load` method is called by a provider algorithm that iterates through the vault secrets to find the ones that have the version prefix.</span></span> <span data-ttu-id="8cbb3-169">Wenn ein Präfix Version gefunden wird, mit `Load`, verwendet der Algorithmus die `GetKey` Methode, um den Konfigurationsnamen der Namen des geheimen Schlüssels zurückzugeben.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-169">When a version prefix is found with `Load`, the algorithm uses the `GetKey` method to return the configuration name of the secret name.</span></span> <span data-ttu-id="8cbb3-170">Das Präfix "Version" aus den geheimen Namen entfernt, und gibt den Rest der Namen des geheimen Schlüssels für das Laden in das app-Konfiguration Name / Wert-Paaren.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-170">It strips off the version prefix from the secret's name and returns the rest of the secret name for loading into the app's configuration name-value pairs.</span></span>

<span data-ttu-id="8cbb3-171">Wenn Sie diesen Ansatz zu implementieren:</span><span class="sxs-lookup"><span data-stu-id="8cbb3-171">When you implement this approach:</span></span>

1. <span data-ttu-id="8cbb3-172">Die geheimen schlüsseltresor werden geladen.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-172">The key vault secrets are loaded.</span></span>
2. <span data-ttu-id="8cbb3-173">Die Zeichenfolge geheimen Schlüssel für `5000-AppSecret` abgeglichen wird.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-173">The string secret for `5000-AppSecret` is matched.</span></span>
3. <span data-ttu-id="8cbb3-174">Die Version `5000` (mit Bindestrich), aus dem Schlüsselnamen verlassen entfernt `AppSecret` , mit dem Wert für den geheimen in der app-Konfiguration zu laden.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-174">The version, `5000` (with the dash), is stripped off of the key name leaving `AppSecret` to load with the secret value into the app's configuration.</span></span>

> [!NOTE]
> <span data-ttu-id="8cbb3-175">Eigene bieten `KeyVaultClient` Implementierung `AddAzureKeyVault`.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-175">You can also provide your own `KeyVaultClient` implementation to `AddAzureKeyVault`.</span></span> <span data-ttu-id="8cbb3-176">Angeben eines benutzerdefinierten Clients, ermöglicht Ihnen, eine einzelne Instanz des Clients zwischen den Konfigurationsanbieter und anderer Teile Ihrer app zu verwenden.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-176">Supplying a custom client allows you to share a single instance of the client between the configuration provider and other parts of your app.</span></span>

1. <span data-ttu-id="8cbb3-177">Erstellen eines schlüsseltresors und Einrichten von Azure Active Directory (Azure AD) für die Anwendung gemäß der Anleitung in [erste Schritte mit Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="8cbb3-177">Create a key vault and set up Azure Active Directory (Azure AD) for the application following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
  * <span data-ttu-id="8cbb3-178">Fügen Sie geheime Schlüssel mit dem schlüsseltresor die [AzureRM Key Vault-PowerShell-Modul](/powershell/module/azurerm.keyvault) verfügbar der [PowerShell-Katalog](https://www.powershellgallery.com/packages/AzureRM.KeyVault), die [REST-API von Azure Key Vault](/rest/api/keyvault/), oder die [Azure-Portal](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="8cbb3-178">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="8cbb3-179">Geheime Schlüssel werden erstellt, entweder als *manuell* oder *Zertifikat* geheime Schlüssel.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-179">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="8cbb3-180">*Zertifikat* geheime Schlüssel sind die Zertifikate für die Verwendung durch apps und Dienste, aber werden nicht unterstützt, indem Sie den Konfigurationsanbieter.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-180">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="8cbb3-181">Verwenden Sie die *manuell* Option zum Erstellen von Name / Wert-Paar geheime Schlüssel für die Verwendung mit den Konfigurationsanbieter.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-181">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
    * <span data-ttu-id="8cbb3-182">Verwenden Sie hierarchische Werte (Konfigurationsabschnitte) `--` (zwei Bindestriche) als Trennzeichen.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-182">Hierarchical values (configuration sections) use `--` (two dashes) as a separator.</span></span>
    * <span data-ttu-id="8cbb3-183">Erstellen Sie zwei *manuell* geheime Schlüssel mit den folgenden Name / Wert-Paaren:</span><span class="sxs-lookup"><span data-stu-id="8cbb3-183">Create two *Manual* secrets with the following name-value pairs:</span></span>
      * <span data-ttu-id="8cbb3-184">`5000-AppSecret`: `5.0.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="8cbb3-184">`5000-AppSecret`: `5.0.0.0_secret_value`</span></span>
      * <span data-ttu-id="8cbb3-185">`5100-AppSecret`: `5.1.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="8cbb3-185">`5100-AppSecret`: `5.1.0.0_secret_value`</span></span>
  * <span data-ttu-id="8cbb3-186">Registrieren der Beispiel-app bei Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-186">Register the sample app with Azure Active Directory.</span></span>
  * <span data-ttu-id="8cbb3-187">Autorisieren Sie die app auf den schlüsseltresor zugreifen.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-187">Authorize the app to access the key vault.</span></span> <span data-ttu-id="8cbb3-188">Bei Verwendung der `Set-AzureRmKeyVaultAccessPolicy` PowerShell-Cmdlet zum Autorisieren der app, Zugriff auf den schlüsseltresor, bieten `List` und `Get` Zugriff auf geheime Schlüssel mit `-PermissionsToSecrets list,get`.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-188">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToSecrets list,get`.</span></span>
2. <span data-ttu-id="8cbb3-189">Aktualisieren Sie der app *appsettings.json* Datei mit den Werten der `Vault`, `ClientId`, und `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-189">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="8cbb3-190">Führen Sie die Beispielapp, das erhält seine Konfigurationswerte aus `IConfigurationRoot` mit dem gleichen Namen wie den Namen des mit Präfix geheimen Schlüssels.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-190">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the prefixed secret name.</span></span> <span data-ttu-id="8cbb3-191">In diesem Beispiel wird das Präfix der app-Version, die Sie zur Verfügung gestellt wird die `PrefixKeyVaultSecretManager` beim Hinzufügen von Azure Key Vault-Konfigurationsanbieter.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-191">In this sample, the prefix is the app's version, which you provided to the `PrefixKeyVaultSecretManager` when you added the Azure Key Vault configuration provider.</span></span> <span data-ttu-id="8cbb3-192">Der Wert für `AppSecret` abgerufen wird, mit `config["AppSecret"]`.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-192">The value for `AppSecret` is obtained with `config["AppSecret"]`.</span></span> <span data-ttu-id="8cbb3-193">Die Webseite, die von der app generiert wurde, zeigt den geladenen Wert:</span><span class="sxs-lookup"><span data-stu-id="8cbb3-193">The webpage generated by the app shows the loaded value:</span></span>

   ![Für den geheimen Werte über Azure Key Vault-Konfigurationsanbieter geladen werden, wenn die app-Version 5.0.0.0 ist Browserfenster](key-vault-configuration/_static/sample2-1.png)

4. <span data-ttu-id="8cbb3-195">Ändern Sie die Version der app-Assembly in der Projektdatei von `5.0.0.0` auf `5.1.0.0` und führen Sie die app erneut aus.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-195">Change the version of the app assembly in the project file from `5.0.0.0` to `5.1.0.0` and run the app again.</span></span> <span data-ttu-id="8cbb3-196">Dieses Mal die geheime zurückgegebene Wert ist `5.1.0.0_secret_value`.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-196">This time, the secret value returned is `5.1.0.0_secret_value`.</span></span> <span data-ttu-id="8cbb3-197">Die Webseite, die von der app generiert wurde, zeigt den geladenen Wert:</span><span class="sxs-lookup"><span data-stu-id="8cbb3-197">The webpage generated by the app shows the loaded value:</span></span>

   ![Browser-Fenster für den geheimen Werte über Azure Key Vault-Konfigurationsanbieter geladen werden, wenn die app-Version 5.1.0.0 ist](key-vault-configuration/_static/sample2-2.png)

## <a name="controlling-access-to-the-clientsecret"></a><span data-ttu-id="8cbb3-199">Steuern des Zugriffs auf die ClientSecret</span><span class="sxs-lookup"><span data-stu-id="8cbb3-199">Controlling access to the ClientSecret</span></span>
<span data-ttu-id="8cbb3-200">Verwenden der [Secret-Manager-Tool](xref:security/app-secrets) zum Verwalten der `ClientSecret` außerhalb der Quellstruktur Projekt.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-200">Use the [Secret Manager tool](xref:security/app-secrets) to maintain the `ClientSecret` outside of your project source tree.</span></span> <span data-ttu-id="8cbb3-201">Mit dem geheimen Schlüssel-Manager, die Sie ein bestimmtes Projekt geheime app-Schlüssel zuordnen und diese projektübergreifend freigeben.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-201">With Secret Manager, you associate app secrets with a specific project and share them across multiple projects.</span></span>

<span data-ttu-id="8cbb3-202">Beim Entwickeln von einer .NET Framework-Apps in einer Umgebung, die Zertifikate unterstützt, können Sie mit einem x. 509-Zertifikat in den Azure Key Vault authentifizieren.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-202">When developing a .NET Framework app in an environment that supports certificates, you can authenticate to Azure Key Vault with an X.509 certificate.</span></span> <span data-ttu-id="8cbb3-203">Private Schlüssel des x. 509-Zertifikats wird vom Betriebssystem verwaltet.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-203">The X.509 certificate's private key is managed by the OS.</span></span> <span data-ttu-id="8cbb3-204">Weitere Informationen finden Sie unter [authentifizieren mit einem Zertifikat anstatt eines geheimen Clientschlüssels](https://docs.microsoft.com/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span><span class="sxs-lookup"><span data-stu-id="8cbb3-204">For more information, see [Authenticate with a Certificate instead of a Client Secret](https://docs.microsoft.com/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span></span> <span data-ttu-id="8cbb3-205">Verwenden der `AddAzureKeyVault` Überladung, akzeptiert eine `X509Certificate2`.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-205">Use the `AddAzureKeyVault` overload that accepts an `X509Certificate2`.</span></span>

```csharp
var store = new X509Store(StoreLocation.CurrentUser);
store.Open(OpenFlags.ReadOnly);
var cert = store.Certificates.Find(X509FindType.FindByThumbprint, config["CertificateThumbprint"], false);

builder.AddAzureKeyVault(
    config["Vault"],
    config["ClientId"],
    cert.OfType<X509Certificate2>().Single(),
    new EnvironmentSecretManager(env.ApplicationName));
store.Close();

Configuration = builder.Build();
```

## <a name="reloading-secrets"></a><span data-ttu-id="8cbb3-206">Erneutes Laden der geheime Schlüssel</span><span class="sxs-lookup"><span data-stu-id="8cbb3-206">Reloading secrets</span></span>
<span data-ttu-id="8cbb3-207">Geheime Schlüssel werden zwischengespeichert, bis `IConfigurationRoot.Reload()` aufgerufen wird.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-207">Secrets are cached until `IConfigurationRoot.Reload()` is called.</span></span> <span data-ttu-id="8cbb3-208">Abgelaufen ist, wird deaktiviert, und die aktualisierte geheime Schlüssel im schlüsseltresor werden nicht eingehalten wird, von der Anwendung bis `Reload` ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-208">Expired, disabled, and updated secrets in the key vault are not respected by the application until `Reload` is executed.</span></span>

```csharp
Configuration.Reload();
```

## <a name="disabled-and-expired-secrets"></a><span data-ttu-id="8cbb3-209">Deaktiviert und abgelaufene Kennwörter</span><span class="sxs-lookup"><span data-stu-id="8cbb3-209">Disabled and expired secrets</span></span>
<span data-ttu-id="8cbb3-210">Deaktiviert und abgelaufene Kennwörter Auslösen einer `KeyVaultClientException`.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-210">Disabled and expired secrets throw a `KeyVaultClientException`.</span></span> <span data-ttu-id="8cbb3-211">Um zu verhindern, dass Ihre app auslösen, ersetzen Sie Ihre app oder aktualisieren Sie den geheimen deaktiviert/Ablauffrist.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-211">To prevent your app from throwing, replace your app or update the disabled/expired secret.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="8cbb3-212">Problembehandlung</span><span class="sxs-lookup"><span data-stu-id="8cbb3-212">Troubleshooting</span></span>
<span data-ttu-id="8cbb3-213">Wenn die Anwendung ein Fehler beim Laden der Konfiguration mithilfe des Anbieters auftritt, wird eine Fehlermeldung geschrieben, auf die [ASP.NET Protokollierung Infrastruktur](xref:fundamentals/logging/index).</span><span class="sxs-lookup"><span data-stu-id="8cbb3-213">When the application fails to load configuration using the provider, an error message is written to the [ASP.NET Logging infrastructure](xref:fundamentals/logging/index).</span></span> <span data-ttu-id="8cbb3-214">Die folgenden Bedingungen verhindert die Konfiguration geladen:</span><span class="sxs-lookup"><span data-stu-id="8cbb3-214">The following conditions will prevent configuration from loading:</span></span>
* <span data-ttu-id="8cbb3-215">Die app nicht korrekt in Azure Active Directory konfiguriert.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-215">The app isn't configured correctly in Azure Active Directory.</span></span>
* <span data-ttu-id="8cbb3-216">Der schlüsseltresor existiert nicht in Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-216">The key vault doesn't exist in Azure Key Vault.</span></span>
* <span data-ttu-id="8cbb3-217">Die app ist nicht autorisiert, auf den schlüsseltresor zugreifen.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-217">The app isn't authorized to access the key vault.</span></span>
* <span data-ttu-id="8cbb3-218">Die Zugriffsrichtlinie ist nicht enthalten `Get` und `List` Berechtigungen.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-218">The access policy doesn't include `Get` and `List` permissions.</span></span>
* <span data-ttu-id="8cbb3-219">Im schlüsseltresor ist die Konfigurationsdaten (Name / Wert-Paar) falsch benannt fehlt, deaktiviert oder abgelaufen.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-219">In the key vault, the configuration data (name-value pair) is incorrectly named, missing, disabled, or expired.</span></span>
* <span data-ttu-id="8cbb3-220">Die app hat den falschen schlüsseltresornamen (`Vault`), Azure AD-App-Id (`ClientId`), oder Azure AD-Schlüssel (`ClientSecret`).</span><span class="sxs-lookup"><span data-stu-id="8cbb3-220">The app has the wrong key vault name (`Vault`), Azure AD App Id (`ClientId`), or Azure AD Key (`ClientSecret`).</span></span>
* <span data-ttu-id="8cbb3-221">Der Azure AD-Schlüssel (`ClientSecret`) ist abgelaufen.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-221">The Azure AD Key (`ClientSecret`) is expired.</span></span>
* <span data-ttu-id="8cbb3-222">Der Konfigurationsschlüssel (Name) ist falsch, in der app für den Wert, den Sie laden möchten.</span><span class="sxs-lookup"><span data-stu-id="8cbb3-222">The configuration key (name) is incorrect in the app for the value you're trying to load.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="8cbb3-223">Zusätzliche Ressourcen</span><span class="sxs-lookup"><span data-stu-id="8cbb3-223">Additional resources</span></span>
* [<span data-ttu-id="8cbb3-224">Konfiguration</span><span class="sxs-lookup"><span data-stu-id="8cbb3-224">Configuration</span></span>](xref:fundamentals/configuration/index)
* [<span data-ttu-id="8cbb3-225">Microsoft Azure: Key Vault</span><span class="sxs-lookup"><span data-stu-id="8cbb3-225">Microsoft Azure: Key Vault</span></span>](https://azure.microsoft.com/services/key-vault/)
* [<span data-ttu-id="8cbb3-226">Microsoft Azure: Key Vault-Dokumentation</span><span class="sxs-lookup"><span data-stu-id="8cbb3-226">Microsoft Azure: Key Vault Documentation</span></span>](https://docs.microsoft.com/azure/key-vault/)
* [<span data-ttu-id="8cbb3-227">Zum Generieren und Übertragen von HSM-geschützten Schlüsseln für Azure Key Vault</span><span class="sxs-lookup"><span data-stu-id="8cbb3-227">How to generate and transfer HSM-protected keys for Azure Key Vault</span></span>](https://docs.microsoft.com/azure/key-vault/key-vault-hsm-protected-keys)
* [<span data-ttu-id="8cbb3-228">KeyVaultClient-Klasse</span><span class="sxs-lookup"><span data-stu-id="8cbb3-228">KeyVaultClient Class</span></span>](https://docs.microsoft.com/dotnet/api/microsoft.azure.keyvault.keyvaultclient)

---
uid: web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
title: Umbruch Datenbankänderungen innerhalb einer Transaktion (c#) | Microsoft Docs
author: rick-anderson
description: Dieses Lernprogramm ist die erste von vier, die prüft, aktualisieren, löschen und Einfügen von Batches von Daten. In diesem Lernprogramm lernen wir an, wie Datenbanktransaktionen zulassen...
ms.author: aspnetcontent
manager: wpickett
ms.date: 06/26/2007
ms.topic: article
ms.assetid: b45fede3-c53a-4ea1-824b-20200808dbae
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
msc.type: authoredcontent
ms.openlocfilehash: a3f8ec2de7b9259e4bb83f4346bde8abfd643fb4
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 04/06/2018
---
<a name="wrapping-database-modifications-within-a-transaction-c"></a><span data-ttu-id="baa1d-104">Umbruch Datenbankänderungen innerhalb einer Transaktion (c#)</span><span class="sxs-lookup"><span data-stu-id="baa1d-104">Wrapping Database Modifications within a Transaction (C#)</span></span>
====================
<span data-ttu-id="baa1d-105">durch [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="baa1d-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="baa1d-106">[Herunterladen von Code](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip) oder [PDF herunterladen](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="baa1d-106">[Download Code](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip) or [Download PDF](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span></span>

> <span data-ttu-id="baa1d-107">Dieses Lernprogramm ist die erste von vier, die prüft, aktualisieren, löschen und Einfügen von Batches von Daten.</span><span class="sxs-lookup"><span data-stu-id="baa1d-107">This tutorial is the first of four that looks at updating, deleting, and inserting batches of data.</span></span> <span data-ttu-id="baa1d-108">In diesem Lernprogramm lernen wir an, wie Datenbanktransaktionen ermöglichen es Batch Änderungen einer atomaren Operation durchgeführt wird, der sicherstellt, dass entweder alle Schritte erfolgreich sind oder alle Schritte fehlschlagen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-108">In this tutorial we learn how database transactions allow batch modifications to be carried out as an atomic operation, which ensures that either all steps succeed or all steps fail.</span></span>


## <a name="introduction"></a><span data-ttu-id="baa1d-109">Einführung</span><span class="sxs-lookup"><span data-stu-id="baa1d-109">Introduction</span></span>

<span data-ttu-id="baa1d-110">Wie wir gesehen haben, beginnend mit der [eine Übersicht der einfügen, aktualisieren und Löschen von Daten](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) Lernprogramm GridView bietet integrierte Unterstützung für auf Zeilenebene zu bearbeiten und löschen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-110">As we saw starting with the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) tutorial, the GridView provides built-in support for row-level editing and deleting.</span></span> <span data-ttu-id="baa1d-111">Mit wenigen Mausklicks ist es möglich, eine große Datenmenge Änderung Schnittstelle zu erstellen, ohne eine Codezeile schreiben zu müssen, so lange Sie Inhalt mit bearbeiten und Löschen von regelmäßig pro Zeile sind.</span><span class="sxs-lookup"><span data-stu-id="baa1d-111">With a few clicks of the mouse it is possible to create a rich data modification interface without writing a line of code, so long as you are content with editing and deleting on a per-row basis.</span></span> <span data-ttu-id="baa1d-112">Allerdings in bestimmten Szenarien ist dies nicht ausreichend, und wir Benutzern die Berechtigung zum Bearbeiten oder Löschen eines Batches von Datensätzen bereitstellen müssen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-112">However, in certain scenarios this is insufficient and we need to provide users with the ability to edit or delete a batch of records.</span></span>

<span data-ttu-id="baa1d-113">Beispielsweise verwenden die meisten webbasierte e-Mail-Clients ein Raster jede Nachricht aufgelistet, wobei jede Zeile ein Kontrollkästchen zusammen mit der e-Mail-s-Informationen (Betreff, Sender usw.) enthält.</span><span class="sxs-lookup"><span data-stu-id="baa1d-113">For example, most web-based email clients use a grid to list each message where each row includes a checkbox along with the email s information (subject, sender, and so forth).</span></span> <span data-ttu-id="baa1d-114">Diese Schnittstelle ermöglicht den Benutzer mehrere Nachrichten löschen, indem sie einchecken und dann auf eine Schaltfläche ausgewählten Nachrichten löschen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-114">This interface permits the user to delete multiple messages by checking them and then clicking a Delete Selected Messages button.</span></span> <span data-ttu-id="baa1d-115">Eine Schnittstelle für die Batchverarbeitung eignet sich in Situationen, in denen Benutzer häufig viele unterschiedliche Datensätze bearbeiten.</span><span class="sxs-lookup"><span data-stu-id="baa1d-115">A batch editing interface is ideal in situations where users commonly edit many different records.</span></span> <span data-ttu-id="baa1d-116">Anstatt auf den Benutzer dazu zwingen bearbeiten, deren Änderung vorzunehmen, und klicken Sie dann die Updates für jeden Datensatz, der geändert werden muss, eine Schnittstelle für die Batchverarbeitung rendert jeder Zeile mit dessen Bearbeitung-Oberfläche.</span><span class="sxs-lookup"><span data-stu-id="baa1d-116">Rather than forcing the user to click Edit, make their change, and then click Update for each record that needs to be modified, a batch editing interface renders each row with its editing interface.</span></span> <span data-ttu-id="baa1d-117">Der Benutzer kann den Satz von Zeilen, die geändert werden müssen, schnell zu ändern und speichern Sie diese Änderungen durch Klicken auf eine Schaltfläche Alle aktualisieren.</span><span class="sxs-lookup"><span data-stu-id="baa1d-117">The user can quickly modify the set of rows that need to be changed and then save these changes by clicking an Update All button.</span></span> <span data-ttu-id="baa1d-118">In diesen Lernprogrammen untersuchen wir zum Erstellen von Schnittstellen für das Einfügen, bearbeiten und Löschen von Batches von Daten.</span><span class="sxs-lookup"><span data-stu-id="baa1d-118">In this set of tutorials we'll examine how to create interfaces for inserting, editing, and deleting batches of data.</span></span>

<span data-ttu-id="baa1d-119">Beim Ausführen von Batchvorgängen es wichtig zu bestimmen, ob es möglich sein soll für einige der Vorgänge im Batch erfolgreich andere dagegen s fehl.</span><span class="sxs-lookup"><span data-stu-id="baa1d-119">When performing batch operations it s important to determine whether it should be possible for some of the operations in the batch to succeed while others fail.</span></span> <span data-ttu-id="baa1d-120">Betrachten Sie einen Batch, die Schnittstelle – was geschehen soll, wenn es sich bei der erste ausgewählte Datensatz erfolgreich gelöscht wurde, aber das zweite Argument ein Fehler auftritt, z. B. aufgrund einer Verletzung der foreign Key-Einschränkung löschen?</span><span class="sxs-lookup"><span data-stu-id="baa1d-120">Consider a batch deleting interface - what should happen if the first selected record is deleted successfully, but the second one fails, say, because of a foreign key constraint violation?</span></span> <span data-ttu-id="baa1d-121">Sollte der erste Datensatz s Löschvorgang rückgängig werden gemacht oder ist es für den ersten Datensatz gelöschten bleiben akzeptabel?</span><span class="sxs-lookup"><span data-stu-id="baa1d-121">Should the first record s delete be rolled back or is it acceptable for the first record to remain deleted?</span></span>

<span data-ttu-id="baa1d-122">Gegebenenfalls den Batchvorgang behandelt werden, als ein [atomaren Vorgang](http://en.wikipedia.org/wiki/Atomic_operation), einer, in denen entweder alle Schritte erfolgreich ausgeführt werden oder alle Schritte fehlschlagen, dann muss der Datenzugriffsebene erweitert werden, dass die Unterstützung für [Datenbank Transaktionen](http://en.wikipedia.org/wiki/Database_transaction).</span><span class="sxs-lookup"><span data-stu-id="baa1d-122">If you want the batch operation to be treated as an [atomic operation](http://en.wikipedia.org/wiki/Atomic_operation), one where either all of the steps succeed or all of the steps fail, then the Data Access Layer needs to be augmented to include support for [database transactions](http://en.wikipedia.org/wiki/Database_transaction).</span></span> <span data-ttu-id="baa1d-123">Datenbanktransaktionen garantieren Unteilbarkeit von Transaktionen für den Satz von `INSERT`, `UPDATE`, und `DELETE` Anweisungen des wirkungsfelds der Transaktion ausgeführt und sind eine Funktion, die von den meisten alle modernen Datenbanksystemen unterstützt.</span><span class="sxs-lookup"><span data-stu-id="baa1d-123">Database transactions guarantee atomicity for the set of `INSERT`, `UPDATE`, and `DELETE` statements executed under the umbrella of the transaction and are a feature supported by most all modern database systems.</span></span>

<span data-ttu-id="baa1d-124">In diesem Lernprogramm sehen wir uns die DAL Verwenden von Datenbanktransaktionen zu erweitern.</span><span class="sxs-lookup"><span data-stu-id="baa1d-124">In this tutorial we'll look at how to extend the DAL to use database transactions.</span></span> <span data-ttu-id="baa1d-125">Nachfolgende Lernprogrammen untersucht implementierende Webseiten für Batch einfügen, aktualisieren und Löschen von Schnittstellen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-125">Subsequent tutorials will examine implementing web pages for batch inserting, updating, and deleting interfaces.</span></span> <span data-ttu-id="baa1d-126">Lassen Sie s beginnen!</span><span class="sxs-lookup"><span data-stu-id="baa1d-126">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="baa1d-127">Beim Ändern von Daten in einer Batchtransaktion ist Unteilbarkeit nicht immer erforderlich.</span><span class="sxs-lookup"><span data-stu-id="baa1d-127">When modifying data in a batch transaction, atomicity is not always needed.</span></span> <span data-ttu-id="baa1d-128">In einigen Szenarien ist es möglicherweise zulässig, einige datenänderungen erfolgreich ausgeführt werden und andere Benutzer im selben Batch ein Fehler auftritt, z. B. wenn eine Reihe von e-Mail-Nachrichten über ein webbasiertes e-Mail-Client löschen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-128">In some scenarios, it may be acceptable to have some data modifications succeed and others in the same batch fail, such as when deleting a set of emails from a web-based email client.</span></span> <span data-ttu-id="baa1d-129">Wenn es s nicht genau eine Datenbank-Fehler durch das Löschen verarbeiten, es s wahrscheinlich akzeptabel, dass diese ohne Fehler verarbeiteten Datensätze gelöschten bleiben.</span><span class="sxs-lookup"><span data-stu-id="baa1d-129">If there s a database error midway through the deletion process, it s probably acceptable that those records processed without error remain deleted.</span></span> <span data-ttu-id="baa1d-130">In solchen Fällen muss die DAL nicht geändert werden, um Datenbanktransaktionen unterstützen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-130">In such cases, the DAL does not need to be modified to support database transactions.</span></span> <span data-ttu-id="baa1d-131">Es gibt andere Batch Vorgang Szenarien, jedoch, in denen Unteilbarkeit unabdingbar ist.</span><span class="sxs-lookup"><span data-stu-id="baa1d-131">There are other batch operation scenarios, however, where atomicity is vital.</span></span> <span data-ttu-id="baa1d-132">Wenn ein Kunde ihr Guthaben von einem Bankkonto auf einen anderen verschoben wird, müssen zwei Vorgänge ausgeführt werden: die Überweisung müssen das erste Konto abgezogen und anschließend das zweite hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="baa1d-132">When a customer moves her funds from one bank account to another, two operations must be performed: the funds must be deducted from the first account and then added to the second.</span></span> <span data-ttu-id="baa1d-133">Während die Bank nichts ausmacht kann, dass der erste Schritt erfolgreich ausgeführt werden, aber der zweite Schritt fehl, wäre die Kunden verständlicherweise verärgert.</span><span class="sxs-lookup"><span data-stu-id="baa1d-133">While the bank may not mind having the first step succeed but the second step fail, its customers would understandably be upset.</span></span> <span data-ttu-id="baa1d-134">Ich empfehlen Ihnen, dieses Lernprogramm zu absolvieren, und implementieren die Erweiterungen für die DAL Datenbanktransaktionen unterstützen, auch wenn Sie nicht beabsichtigen, auf die Verwendung dieser Batch einfügen, aktualisieren und Löschen von Schnittstellen, die in den folgenden drei Lernprogrammen erstellen müssen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-134">I encourage you to work through this tutorial and implement the enhancements to the DAL to support database transactions even if you do not plan on using them in the batch inserting, updating, and deleting interfaces we'll be building in the following three tutorials.</span></span>


## <a name="an-overview-of-transactions"></a><span data-ttu-id="baa1d-135">Eine Übersicht über Transaktionen</span><span class="sxs-lookup"><span data-stu-id="baa1d-135">An Overview of Transactions</span></span>

<span data-ttu-id="baa1d-136">Die meisten Datenbanken enthalten die Unterstützung für *Transaktionen*, ermöglichen die mehrerer Datenbankbefehle in eine einzelne logische Arbeitseinheit gruppiert werden.</span><span class="sxs-lookup"><span data-stu-id="baa1d-136">Most databases include support for *transactions*, which enable multiple database commands to be grouped into a single logical unit of work.</span></span> <span data-ttu-id="baa1d-137">Die Datenbankbefehle, die eine Transaktion bilden sind unbedingt atomarisch, d. h., dass entweder alle Befehle fehl schlagen, oder alle funktionieren.</span><span class="sxs-lookup"><span data-stu-id="baa1d-137">The database commands that comprise a transaction are guaranteed to be atomic, meaning that either all commands will fail or all will succeed.</span></span>

<span data-ttu-id="baa1d-138">Im Allgemeinen werden Transaktionen über SQL-Anweisungen, die mithilfe des folgenden Musters implementiert:</span><span class="sxs-lookup"><span data-stu-id="baa1d-138">In general, transactions are implemented through SQL statements using the following pattern:</span></span>

1. <span data-ttu-id="baa1d-139">Geben Sie an den Anfang einer Transaktion.</span><span class="sxs-lookup"><span data-stu-id="baa1d-139">Indicate the start of a transaction.</span></span>
2. <span data-ttu-id="baa1d-140">Führen Sie die SQL-Anweisungen, die die Transaktion zu bilden.</span><span class="sxs-lookup"><span data-stu-id="baa1d-140">Execute the SQL statements that comprise the transaction.</span></span>
3. <span data-ttu-id="baa1d-141">Wenn ein Fehler in einer der Anweisungen aus Schritt2, Rollback der Transaktion vorhanden ist.</span><span class="sxs-lookup"><span data-stu-id="baa1d-141">If there is an error in one of the statements from Step 2, rollback the transaction.</span></span>
4. <span data-ttu-id="baa1d-142">Wenn alle Anweisungen aus Schritt2 ohne Fehler abgeschlossen werden, ein commit der Transaktions.</span><span class="sxs-lookup"><span data-stu-id="baa1d-142">If all of the statements from Step 2 complete without error, commit the transaction.</span></span>

<span data-ttu-id="baa1d-143">Die SQL-Anweisungen, die zum Erstellen, einen Commit auszuführen, und Rollback die Transaktion kann manuell eingegeben werden, wenn SQL-Skripts schreiben, oder Erstellen von Prozeduren gespeicherten oder über programmgesteuerte bedeutet, dass mithilfe von ADO.NET oder die Klassen in der [ `System.Transactions` Namespace](https://msdn.microsoft.com/library/system.transactions.aspx).</span><span class="sxs-lookup"><span data-stu-id="baa1d-143">The SQL statements used to create, commit, and roll back the transaction can be entered manually when writing SQL scripts or creating stored procedures, or through programmatic means using either ADO.NET or the classes in the [`System.Transactions` namespace](https://msdn.microsoft.com/library/system.transactions.aspx).</span></span> <span data-ttu-id="baa1d-144">Verwalten von Transaktionen, die mithilfe von ADO.NET, in diesem Lernprogramm nur untersucht werden.</span><span class="sxs-lookup"><span data-stu-id="baa1d-144">In this tutorial we will only examine managing transactions using ADO.NET.</span></span> <span data-ttu-id="baa1d-145">In einem späteren Lernprogramm betrachten wir Verwendung von gespeicherten Prozeduren in der Datenzugriffsebene zu diesem Zeitpunkt die SQL-Anweisungen zum Erstellen, Rollback und Commit für Transaktionen untersucht werden.</span><span class="sxs-lookup"><span data-stu-id="baa1d-145">In a future tutorial we will look at how to use stored procedures in the Data Access Layer, at which time we'll explore the SQL statements for creating, rolling back, and committing transactions.</span></span> <span data-ttu-id="baa1d-146">Wenden Sie sich in der Zwischenzeit an [Verwalten von Transaktionen in gespeicherten Prozeduren von SQL Server](http://www.4guysfromrolla.com/webtech/080305-1.shtml) für Weitere Informationen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-146">In the meantime, consult [Managing Transactions in SQL Server Stored Procedures](http://www.4guysfromrolla.com/webtech/080305-1.shtml) for more information.</span></span>

> [!NOTE]
> <span data-ttu-id="baa1d-147">Die [ `TransactionScope` Klasse](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) in die `System.Transactions` Namespace ermöglicht es Entwicklern, programmgesteuert eine Reihe von Anweisungen innerhalb des Bereichs einer Transaktion umschließen und bietet Unterstützung für komplexe Transaktionen, die mehrere einschließen Quellen, z. B. zwei verschiedenen Datenbanken oder sogar heterogene Arten von Datenspeichern, wie z. B. Microsoft SQL Server-Datenbank, einer Oracle-Datenbank und einen Webdienst.</span><span class="sxs-lookup"><span data-stu-id="baa1d-147">The [`TransactionScope` class](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) in the `System.Transactions` namespace enables developers to programmatically wrap a series of statements within the scope of a transaction and includes support for complex transactions that involve multiple sources, such as two different databases or even heterogeneous types of data stores, such as a Microsoft SQL Server database, an Oracle database, and a Web service.</span></span> <span data-ttu-id="baa1d-148">Ich haben sich entschieden, zur Verwendung von ADO.NET Transaktionen für dieses Lernprogramm anstelle von der `TransactionScope` Klasse da ADO.NET finden Sie spezifischere für Datenbanktransaktionen und in vielen Fällen ist viel weniger ressourcenintensiv ist.</span><span class="sxs-lookup"><span data-stu-id="baa1d-148">I ve decided to use ADO.NET transactions for this tutorial instead of the `TransactionScope` class because ADO.NET is more specific for database transactions and, in many cases, is far less resource intensive.</span></span> <span data-ttu-id="baa1d-149">Darüber hinaus werden in bestimmten Szenarien die `TransactionScope` Klasse verwendet den Microsoft Distributed Transaction Coordinator (MSDTC).</span><span class="sxs-lookup"><span data-stu-id="baa1d-149">In addition, under certain scenarios the `TransactionScope` class uses the Microsoft Distributed Transaction Coordinator (MSDTC).</span></span> <span data-ttu-id="baa1d-150">Die Konfiguration, Implementierung und Leistung Probleme umgebenden MSDTC erleichtert ein Thema vielmehr spezialisierten und erweiterte und Gegenstand mit diesen Lernprogrammen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-150">The configuration, implementation, and performance issues surrounding MSDTC makes it a rather specialized and advanced topic and beyond the scope of these tutorials.</span></span>


<span data-ttu-id="baa1d-151">Bei der Arbeit mit dem SqlClient-Anbieter in ADO.NET werden Transaktionen gestartet, durch einen Aufruf der [ `SqlConnection` Klasse](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [ `BeginTransaction` Methode](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), welche gibt eine [ `SqlTransaction` Objekt](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span><span class="sxs-lookup"><span data-stu-id="baa1d-151">When working with the SqlClient provider in ADO.NET, transactions are initiated through a call to the [`SqlConnection` class](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [`BeginTransaction` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), which returns a [`SqlTransaction` object](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span></span> <span data-ttu-id="baa1d-152">Die datenänderungsanweisungen, die Zusammensetzung der Transaktion befinden sich innerhalb einer `try...catch` Block.</span><span class="sxs-lookup"><span data-stu-id="baa1d-152">The data modification statements that makeup the transaction are placed within a `try...catch` block.</span></span> <span data-ttu-id="baa1d-153">In einer Anweisung im Falle ein Fehlers die `try` blockieren, Ausführung übertragungsflusses, um die `catch` Block, in dem Rollback der Transaktion kann werden über, die `SqlTransaction` s-Objekt [ `Rollback` Methode](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span><span class="sxs-lookup"><span data-stu-id="baa1d-153">If an error occurs in a statement in the `try` block, execution transfers to the `catch` block where the transaction can be rolled back via the `SqlTransaction` object s [`Rollback` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span></span> <span data-ttu-id="baa1d-154">Wenn alle Anweisungen erfolgreich einen Aufruf abgeschlossen der `SqlTransaction` s-Objekt [ `Commit` Methode](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) am Ende der `try` Block ein Commit die Transaktion.</span><span class="sxs-lookup"><span data-stu-id="baa1d-154">If all of the statements complete successfully, a call to the `SqlTransaction` object s [`Commit` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) at the end of the `try` block commits the transaction.</span></span> <span data-ttu-id="baa1d-155">Der folgende Codeausschnitt veranschaulicht dieses Muster.</span><span class="sxs-lookup"><span data-stu-id="baa1d-155">The following code snippet illustrates this pattern.</span></span> <span data-ttu-id="baa1d-156">Finden Sie unter [Datenbankkonsistenz mit Transaktionen warten](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) für zusätzliche Syntax und Beispiele für die Verwendung von Transaktionen in ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="baa1d-156">See [Maintaining Database Consistency with Transactions](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) for additional syntax and examples of using transactions with ADO.NET.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample1.cs)]

<span data-ttu-id="baa1d-157">Standardmäßig verwenden die TableAdapters in einem typisierten DataSet Transaktionen nicht.</span><span class="sxs-lookup"><span data-stu-id="baa1d-157">By default, the TableAdapters in a Typed DataSet do not use transactions.</span></span> <span data-ttu-id="baa1d-158">Zur Unterstützung für Transaktionen erweitern, die TableAdapter-Klassen, um zusätzliche Methoden enthalten, die die oben genannten Muster zu verwenden, um eine Reihe von Anweisungen zur Datenänderung innerhalb des Bereichs einer Transaktion ausführen müssen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-158">To provide support for transactions we need to augment the TableAdapter classes to include additional methods that use the above pattern to perform a series of data modification statements within the scope of a transaction.</span></span> <span data-ttu-id="baa1d-159">In Schritt2 sehen wir, wie partielle Klassen zu verwenden, um diese Methoden hinzufügen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-159">In Step 2 we'll see how to use partial classes to add these methods.</span></span>

## <a name="step-1-creating-the-working-with-batched-data-web-pages"></a><span data-ttu-id="baa1d-160">Schritt 1: Erstellen der Arbeit mit Webseiten als Batch erstellten Daten</span><span class="sxs-lookup"><span data-stu-id="baa1d-160">Step 1: Creating the Working with Batched Data Web Pages</span></span>

<span data-ttu-id="baa1d-161">Bevor wir beginnen, wie erweitern, die DAL zur Unterstützung von Datenbanktransaktionen untersuchen, können Sie s, schalten Sie zuerst einen Moment Zeit, um ASP.NET Web Pages, die wir für dieses Lernprogramm benötigen und die drei, die folgen zu erstellen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-161">Before we start exploring how to augment the DAL to support database transactions, let s first take a moment to create the ASP.NET web pages that we will need for this tutorial and the three that follow.</span></span> <span data-ttu-id="baa1d-162">Starten, indem Sie einen neuen Ordner namens `BatchData` und fügen Sie dann die folgenden ASP.NET-Seiten, verknüpfen jede Seite mit den `Site.master` Masterseite.</span><span class="sxs-lookup"><span data-stu-id="baa1d-162">Start by adding a new folder named `BatchData` and then add the following ASP.NET pages, associating each page with the `Site.master` master page.</span></span>

- `Default.aspx`
- `Transactions.aspx`
- `BatchUpdate.aspx`
- `BatchDelete.aspx`
- `BatchInsert.aspx`


![Fügen Sie die ASP.NET-Seiten für die Lernprogramme SqlDataSource-bezogene hinzu.](wrapping-database-modifications-within-a-transaction-cs/_static/image1.gif)

<span data-ttu-id="baa1d-164">**Abbildung 1**: Fügen Sie die ASP.NET-Seiten für die Lernprogramme SqlDataSource-bezogene hinzu</span><span class="sxs-lookup"><span data-stu-id="baa1d-164">**Figure 1**: Add the ASP.NET Pages for the SqlDataSource-Related Tutorials</span></span>


<span data-ttu-id="baa1d-165">Wie bei den anderen Ordnern `Default.aspx` verwendet die `SectionLevelTutorialListing.ascx` Benutzersteuerelement, um die Lernprogramme in einem Abschnitt aufzulisten.</span><span class="sxs-lookup"><span data-stu-id="baa1d-165">As with the other folders, `Default.aspx` will use the `SectionLevelTutorialListing.ascx` User Control to list the tutorials within its section.</span></span> <span data-ttu-id="baa1d-166">Aus diesem Grund Hinzufügen dieses Benutzersteuerelement zu `Default.aspx` durch Ziehen aus dem Projektmappen-Explorer auf die Seite s Entwurfsansicht.</span><span class="sxs-lookup"><span data-stu-id="baa1d-166">Therefore, add this User Control to `Default.aspx` by dragging it from the Solution Explorer onto the page s Design view.</span></span>


<span data-ttu-id="baa1d-167">[![Das Benutzersteuerelement SectionLevelTutorialListing.ascx "default.aspx" hinzufügen](wrapping-database-modifications-within-a-transaction-cs/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="baa1d-167">[![Add the SectionLevelTutorialListing.ascx User Control to Default.aspx](wrapping-database-modifications-within-a-transaction-cs/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image1.png)</span></span>

<span data-ttu-id="baa1d-168">**Abbildung 2**: Hinzufügen der `SectionLevelTutorialListing.ascx` Benutzersteuerelement `Default.aspx` ([klicken Sie hier, um das Bild in voller Größe angezeigt](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="baa1d-168">**Figure 2**: Add the `SectionLevelTutorialListing.ascx` User Control to `Default.aspx` ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png))</span></span>


<span data-ttu-id="baa1d-169">Abschließend fügen Sie diese vier Seiten als Einträge an die `Web.sitemap` Datei.</span><span class="sxs-lookup"><span data-stu-id="baa1d-169">Lastly, add these four pages as entries to the `Web.sitemap` file.</span></span> <span data-ttu-id="baa1d-170">Fügen Sie das folgende Markup insbesondere nach dem Anpassen der Siteübersicht `<siteMapNode>`:</span><span class="sxs-lookup"><span data-stu-id="baa1d-170">Specifically, add the following markup after the Customizing the Site Map `<siteMapNode>`:</span></span>


[!code-xml[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample2.xml)]

<span data-ttu-id="baa1d-171">Nach der Aktualisierung `Web.sitemap`, nehmen einen Moment Zeit, um die Lernprogramme-Website über einen Browser anzuzeigen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-171">After updating `Web.sitemap`, take a moment to view the tutorials website through a browser.</span></span> <span data-ttu-id="baa1d-172">Klicken Sie im Menü auf der linken Seite enthält nun Elemente für das Arbeiten mit Daten als Batch erstellten Lernprogramme.</span><span class="sxs-lookup"><span data-stu-id="baa1d-172">The menu on the left now includes items for the working with batched data tutorials.</span></span>


![Die Siteübersicht enthält nun die Einträge für die Arbeit mit Daten als Batch erstellten Lernprogramme](wrapping-database-modifications-within-a-transaction-cs/_static/image3.gif)

<span data-ttu-id="baa1d-174">**Abbildung 3**: die Siteübersicht enthält jetzt die Einträge für die Arbeit mit Daten als Batch erstellten Lernprogramme</span><span class="sxs-lookup"><span data-stu-id="baa1d-174">**Figure 3**: The Site Map Now Includes Entries for the Working with Batched Data Tutorials</span></span>


## <a name="step-2-updating-the-data-access-layer-to-support-database-transactions"></a><span data-ttu-id="baa1d-175">Schritt 2: Aktualisieren der Datenzugriffsebene zur Unterstützung von Datenbanktransaktionen</span><span class="sxs-lookup"><span data-stu-id="baa1d-175">Step 2: Updating the Data Access Layer to Support Database Transactions</span></span>

<span data-ttu-id="baa1d-176">Wie im ersten Lernprogramm erläutert [erstellen eine Datenzugriffsschicht](../introduction/creating-a-data-access-layer-cs.md), die typisierte DataSet in unserer DAL besteht DataTables und TableAdapters.</span><span class="sxs-lookup"><span data-stu-id="baa1d-176">As we discussed back in the first tutorial, [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md), the Typed DataSet in our DAL is composed of DataTables and TableAdapters.</span></span> <span data-ttu-id="baa1d-177">Die Datentabellen enthalten Daten, während die TableAdapters, die Funktionalität zum Lesen von Daten aus der Datenbank in die DataTables, zum Aktualisieren der Datenbank mit Änderungen an der DataTables usw. bereitstellen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-177">The DataTables hold data while the TableAdapters provide the functionality to read data from the database into the DataTables, to update the database with changes made to the DataTables, and so forth.</span></span> <span data-ttu-id="baa1d-178">Beachten Sie, dass die TableAdapters bieten zwei Muster zum Aktualisieren von Daten, die ich als BatchUpdate "und" DB-Direct "bezeichnet.</span><span class="sxs-lookup"><span data-stu-id="baa1d-178">Recall that the TableAdapters provide two patterns for updating data, which I referred to as Batch Update and DB-Direct.</span></span> <span data-ttu-id="baa1d-179">Mit dem BatchUpdate-Muster wird der TableAdapter Datasets, einer Datentabelle oder einer Auflistung von DataRows übergeben.</span><span class="sxs-lookup"><span data-stu-id="baa1d-179">With the Batch Update pattern, the TableAdapter is passed a DataSet, DataTable, or collection of DataRows.</span></span> <span data-ttu-id="baa1d-180">Diese Daten aufgelistet und für jeden eingefügt, geändert oder gelöschte Zeile, die `InsertCommand`, `UpdateCommand`, oder `DeleteCommand` ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="baa1d-180">This data is enumerated and for each inserted, modified, or deleted row, the `InsertCommand`, `UpdateCommand`, or `DeleteCommand` is executed.</span></span> <span data-ttu-id="baa1d-181">Mit dem DB-Direct-Muster wird der TableAdapter stattdessen die Werte der Spalten für das Einfügen, aktualisieren oder Löschen eines einzelnen Datensatzes erforderlich übergeben.</span><span class="sxs-lookup"><span data-stu-id="baa1d-181">With the DB-Direct pattern, the TableAdapter is instead passed the values of the columns necessary for inserting, updating, or deleting a single record.</span></span> <span data-ttu-id="baa1d-182">Die DB-direkten Muster-Methode verwendet dann diese übergebene Werte zum Ausführen der entsprechenden `InsertCommand`, `UpdateCommand`, oder `DeleteCommand` Anweisung.</span><span class="sxs-lookup"><span data-stu-id="baa1d-182">The DB Direct pattern method then uses those passed-in values to execute the appropriate `InsertCommand`, `UpdateCommand`, or `DeleteCommand` statement.</span></span>

<span data-ttu-id="baa1d-183">Unabhängig von der updatemuster verwendet verwenden Sie die TableAdapters automatisch generierte Methoden nicht Transaktionen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-183">Regardless of the update pattern used, the TableAdapters auto-generated methods do not use transactions.</span></span> <span data-ttu-id="baa1d-184">Standardmäßig wird jede INSERT-, Update- oder Delete des TableAdapter ausgeführt als einzelner Vorgang diskret behandelt.</span><span class="sxs-lookup"><span data-stu-id="baa1d-184">By default each insert, update, or delete performed by the TableAdapter is treated as a single discrete operation.</span></span> <span data-ttu-id="baa1d-185">Stellen Sie sich z. B. vor, dass die DB-Direct-Muster von Code in die BLL, zum Einfügen von zehn Datensätze in der Datenbank verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="baa1d-185">For instance, imagine that the DB-Direct pattern is used by some code in the BLL to insert ten records into the database.</span></span> <span data-ttu-id="baa1d-186">Dieser Code würde die TableAdapter aufrufen `Insert` zehnmal-Methode.</span><span class="sxs-lookup"><span data-stu-id="baa1d-186">This code would call the TableAdapter s `Insert` method ten times.</span></span> <span data-ttu-id="baa1d-187">Wenn die ersten fünf einfügungen erfolgreich, aber das sechste Element zu einer Ausnahme geführt hat, bleibt die ersten fünf eingefügte Datensätze in der Datenbank.</span><span class="sxs-lookup"><span data-stu-id="baa1d-187">If the first five inserts succeed, but the sixth one resulted in an exception, the first five inserted records would remain in the database.</span></span> <span data-ttu-id="baa1d-188">Auf ähnliche Weise, wenn das BatchUpdate Muster auf Einfügevorgänge verwendet wird, Updates und löschungen an der eingefügten, geändert und Zeilen in einer "DataTable" gelöscht, wenn die erste einige Änderungen erfolgreich war, aber eine höhere Version ist ein Fehler, die diese früheren Änderungen aufgetreten, abgeschlossen, die in der Datenbank bleiben würden.</span><span class="sxs-lookup"><span data-stu-id="baa1d-188">Similarly, if the Batch Update pattern is used to perform inserts, updates, and deletes to the inserted, modified, and deleted rows in a DataTable, if the first several modifications succeeded but a later one encountered an error, those earlier modifications that completed would remain in the database.</span></span>

<span data-ttu-id="baa1d-189">In bestimmten Szenarien möchten wir Unteilbarkeit über eine Reihe von Änderungen sicherzustellen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-189">In certain scenarios we want to ensure atomicity across a series of modifications.</span></span> <span data-ttu-id="baa1d-190">Wir die TableAdapter manuell erweitern müssen, indem Hinzufügen von neuen Methoden, die ausgeführt werden hierzu die `InsertCommand`, `UpdateCommand`, und `DeleteCommand` s des wirkungsfelds einer Transaktion.</span><span class="sxs-lookup"><span data-stu-id="baa1d-190">To accomplish this we must manually extend the TableAdapter by adding new methods that execute the `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s under the umbrella of a transaction.</span></span> <span data-ttu-id="baa1d-191">In [erstellen eine Datenzugriffsschicht](../introduction/creating-a-data-access-layer-cs.md) erläutert, mit [Teilklassen](http://en.wikipedia.org/wiki/Partial_type) zum Erweitern der Funktionalität der DataTables innerhalb des typisierten Datasets.</span><span class="sxs-lookup"><span data-stu-id="baa1d-191">In [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md) we looked at using [partial classes](http://en.wikipedia.org/wiki/Partial_type) to extend the functionality of the DataTables within the Typed DataSet.</span></span> <span data-ttu-id="baa1d-192">Diese Technik kann auch mit TableAdapters verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="baa1d-192">This technique can also be used with TableAdapters.</span></span>

<span data-ttu-id="baa1d-193">Das typisierte DataSet `Northwind.xsd` befindet sich der `App_Code` Ordner s `DAL` Unterordner.</span><span class="sxs-lookup"><span data-stu-id="baa1d-193">The Typed DataSet `Northwind.xsd` is located in the `App_Code` folder s `DAL` subfolder.</span></span> <span data-ttu-id="baa1d-194">Erstellen Sie einen Unterordner in der `DAL` Ordner mit dem Namen `TransactionSupport` und fügen Sie eine neue Klassendatei mit dem Namen `ProductsTableAdapter.TransactionSupport.cs` (siehe Abbildung 4).</span><span class="sxs-lookup"><span data-stu-id="baa1d-194">Create a subfolder in the `DAL` folder named `TransactionSupport` and add a new class file named `ProductsTableAdapter.TransactionSupport.cs` (see Figure 4).</span></span> <span data-ttu-id="baa1d-195">Diese Datei wird die partielle Implementierung des halten die `ProductsTableAdapter` , die Methoden zum Ausführen von datenänderungen, die unter Verwendung einer Transaktion enthält.</span><span class="sxs-lookup"><span data-stu-id="baa1d-195">This file will hold the partial implementation of the `ProductsTableAdapter` that includes methods for performing data modifications using a transaction.</span></span>


![Fügen Sie einen Ordner namens TransactionSupport und eine Klassendatei mit dem Namen ProductsTableAdapter.TransactionSupport.cs hinzu](wrapping-database-modifications-within-a-transaction-cs/_static/image4.gif)

<span data-ttu-id="baa1d-197">**Abbildung 4**: Fügen Sie einen Ordner mit dem Namen `TransactionSupport` und eine Klassendatei mit dem Namen `ProductsTableAdapter.TransactionSupport.cs`</span><span class="sxs-lookup"><span data-stu-id="baa1d-197">**Figure 4**: Add a Folder Named `TransactionSupport` and a Class File Named `ProductsTableAdapter.TransactionSupport.cs`</span></span>


<span data-ttu-id="baa1d-198">Geben Sie den folgenden Code in die `ProductsTableAdapter.TransactionSupport.cs` Datei:</span><span class="sxs-lookup"><span data-stu-id="baa1d-198">Enter the following code into the `ProductsTableAdapter.TransactionSupport.cs` file:</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample3.cs)]

<span data-ttu-id="baa1d-199">Die `partial` -Schlüsselwort in der Klassendeklaration hier gibt an, an den Compiler, die innerhalb von hinzugefügten Member hinzugefügt werden, die `ProductsTableAdapter` -Klasse in der `NorthwindTableAdapters` Namespace.</span><span class="sxs-lookup"><span data-stu-id="baa1d-199">The `partial` keyword in the class declaration here indicates to the compiler that the members added within are to be added to the `ProductsTableAdapter` class in the `NorthwindTableAdapters` namespace.</span></span> <span data-ttu-id="baa1d-200">Beachten Sie die `using System.Data.SqlClient` -Anweisung am Anfang der Datei.</span><span class="sxs-lookup"><span data-stu-id="baa1d-200">Note the `using System.Data.SqlClient` statement at the top of the file.</span></span> <span data-ttu-id="baa1d-201">Seit der TableAdapter für die Verwendung des SqlClient-Anbieters konfiguriert wurde, er verwendet intern eine [ `SqlDataAdapter` ](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) -Objekt, dessen Befehle an die Datenbank ausgeben.</span><span class="sxs-lookup"><span data-stu-id="baa1d-201">Since the TableAdapter was configured to use the SqlClient provider, internally it uses a [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) object to issue its commands to the database.</span></span> <span data-ttu-id="baa1d-202">Folglich müssen wir verwenden die `SqlTransaction` Klasse, um die Transaktion zu beginnen und dann einen commit oder Rollback für sie.</span><span class="sxs-lookup"><span data-stu-id="baa1d-202">Consequently, we need to use the `SqlTransaction` class to begin the transaction and then to commit it or roll it back.</span></span> <span data-ttu-id="baa1d-203">Wenn Sie einen anderen Datenspeicher als Microsoft SQL Server verwenden, müssen Sie den entsprechenden Anbieter verwenden.</span><span class="sxs-lookup"><span data-stu-id="baa1d-203">If you are using a data store other than Microsoft SQL Server, you'll need to use the appropriate provider.</span></span>

<span data-ttu-id="baa1d-204">Diese Methoden geben Sie die Bausteine, die erforderlich sind, Rollback- und commit einer Transaktion.</span><span class="sxs-lookup"><span data-stu-id="baa1d-204">These methods provide the building blocks needed to start, rollback, and commit a transaction.</span></span> <span data-ttu-id="baa1d-205">Markiert sind `public`, aktivieren sie innerhalb von verwendet werden die `ProductsTableAdapter`, von einer anderen Klasse in der DAL oder aus einer anderen Ebene in der Architektur, z. B. die BLL.</span><span class="sxs-lookup"><span data-stu-id="baa1d-205">They are marked `public`, enabling them to be used from within the `ProductsTableAdapter`, from another class in the DAL, or from another layer in the architecture, such as the BLL.</span></span> <span data-ttu-id="baa1d-206">`BeginTransaction` Öffnet die internen TableAdapter `SqlConnection` (falls erforderlich), startet die Transaktion und weist sie der `Transaction` -Eigenschaft, und fügt die Transaktion an den internen `SqlDataAdapter` s `SqlCommand` Objekte.</span><span class="sxs-lookup"><span data-stu-id="baa1d-206">`BeginTransaction` opens the TableAdapter s internal `SqlConnection` (if needed), begins the transaction and assigns it to the `Transaction` property, and attaches the transaction to the internal `SqlDataAdapter` s `SqlCommand` objects.</span></span> <span data-ttu-id="baa1d-207">`CommitTransaction` und `RollbackTransaction` rufen die `Transaction` s-Objekt `Commit` und `Rollback` Methoden, bzw. vor dem Schließen der internen `Connection` Objekt.</span><span class="sxs-lookup"><span data-stu-id="baa1d-207">`CommitTransaction` and `RollbackTransaction` call the `Transaction` object s `Commit` and `Rollback` methods, respectively, before closing the internal `Connection` object.</span></span>

## <a name="step-3-adding-methods-to-update-and-delete-data-under-the-umbrella-of-a-transaction"></a><span data-ttu-id="baa1d-208">Schritt 3: Hinzufügen von Methoden zum Aktualisieren und Löschen von Daten des Wirkungsfelds einer Transaktion</span><span class="sxs-lookup"><span data-stu-id="baa1d-208">Step 3: Adding Methods to Update and Delete Data Under the Umbrella of a Transaction</span></span>

<span data-ttu-id="baa1d-209">Mit diesen Methoden abgeschlossen ist, wir re Methoden hinzufügen Installationsbereit `ProductsDataTable` oder die BLL, die eine Reihe von Befehlen des wirkungsfelds einer Transaktion ausführen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-209">With these methods complete, we re ready to add methods to `ProductsDataTable` or the BLL that perform a series of commands under the umbrella of a transaction.</span></span> <span data-ttu-id="baa1d-210">Die folgende Methode mithilfe des Musters Batchaktualisierung Aktualisieren einer `ProductsDataTable` -Instanz unter Verwendung einer Transaktion.</span><span class="sxs-lookup"><span data-stu-id="baa1d-210">The following method uses the Batch Update pattern to update a `ProductsDataTable` instance using a transaction.</span></span> <span data-ttu-id="baa1d-211">Es startet eine Transaktion durch Aufrufen der `BeginTransaction` -Methode und dann verwendet, eine `try...catch` Block, um die Anweisungen zur Datenänderung ausgeben.</span><span class="sxs-lookup"><span data-stu-id="baa1d-211">It starts a transaction by calling the `BeginTransaction` method and then uses a `try...catch` block to issue the data modification statements.</span></span> <span data-ttu-id="baa1d-212">Wenn der Aufruf der `Adapter` s-Objekt `Update` Methode zu einer Ausnahme, die Ausführung überträgt an die `catch` Block, in dem die Transaktion wird ein Rollback, und die Ausnahme erneut ausgelöst.</span><span class="sxs-lookup"><span data-stu-id="baa1d-212">If the call to the `Adapter` object s `Update` method results in an exception, execution will transfer to the `catch` block where the transaction will be rolled back and the exception re-thrown.</span></span> <span data-ttu-id="baa1d-213">Bedenken Sie, dass die `Update` Methode implementiert das Muster BatchUpdate durch das Auflisten der Zeilen des angegebenen `ProductsDataTable` und Ausführen der erforderlichen `InsertCommand`, `UpdateCommand`, und `DeleteCommand` s.</span><span class="sxs-lookup"><span data-stu-id="baa1d-213">Recall that the `Update` method implements the Batch Update pattern by enumerating the rows of the supplied `ProductsDataTable` and performing the necessary `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s.</span></span> <span data-ttu-id="baa1d-214">Wenn eines dieser Befehle führt zu einem Fehler, wird die Transaktion zurückgesetzt der vorherigen während der Lebensdauer von Transaktionen s vorgenommenen Änderungen rückgängig zu machen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-214">If any one of these commands results in an error, the transaction is rolled back, undoing the previous modifications made during the transaction s lifetime.</span></span> <span data-ttu-id="baa1d-215">Sollte die `Update` Anweisung ohne Fehler abgeschlossen ist, wird die Transaktion ein Commit in seiner Gesamtheit ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="baa1d-215">Should the `Update` statement complete without error, the transaction is committed in its entirety.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample4.cs)]

<span data-ttu-id="baa1d-216">Hinzufügen der `UpdateWithTransaction` Methode, um die `ProductsTableAdapter` Klasse über die partielle Klasse im `ProductsTableAdapter.TransactionSupport.cs`.</span><span class="sxs-lookup"><span data-stu-id="baa1d-216">Add the `UpdateWithTransaction` method to the `ProductsTableAdapter` class through the partial class in `ProductsTableAdapter.TransactionSupport.cs`.</span></span> <span data-ttu-id="baa1d-217">Alternativ können Sie diese Methode mit dem Business Logic Layer s hinzugefügt werden konnte `ProductsBLL` Klasse mit einigen geringfügigen syntaktische Änderungen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-217">Alternatively, this method could be added to the Business Logic Layer s `ProductsBLL` class with a few minor syntactical changes.</span></span> <span data-ttu-id="baa1d-218">Nämlich das Schlüsselwort hierzu finden Sie unter `this.BeginTransaction()`, `this.CommitTransaction()`, und `this.RollbackTransaction()` durch ersetzt werden müssten `Adapter` (Erinnerung `Adapter` ist der Name einer Eigenschaft in `ProductsBLL` des Typs `ProductsTableAdapter`).</span><span class="sxs-lookup"><span data-stu-id="baa1d-218">Namely, the keyword this in `this.BeginTransaction()`, `this.CommitTransaction()`, and `this.RollbackTransaction()` would need to be replaced with `Adapter` (recall that `Adapter` is the name of a property in `ProductsBLL` of type `ProductsTableAdapter`).</span></span>

<span data-ttu-id="baa1d-219">Die `UpdateWithTransaction` Methode verwendet die Batch-updatemuster, aber eine Reihe von DB-Direct-Aufrufe kann auch im Rahmen einer Transaktion, wie die folgende Methode zeigt verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="baa1d-219">The `UpdateWithTransaction` method uses the Batch Update pattern, but a series of DB-Direct calls can also be used within the scope of a transaction, as the following method shows.</span></span> <span data-ttu-id="baa1d-220">Die `DeleteProductsWithTransaction` Methode akzeptiert als Eingabe eine `List<T>` vom Typ `int`, wobei es sich um die `ProductID` s löschen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-220">The `DeleteProductsWithTransaction` method accepts as input a `List<T>` of type `int`, which are the `ProductID` s to delete.</span></span> <span data-ttu-id="baa1d-221">Die Methode startet die Transaktion über einen Aufruf an `BeginTransaction` und dann auf die `try` blockieren, iteriert durch die bereitgestellte Liste der DB-Direct-Muster aufrufen `Delete` Methode für die einzelnen `ProductID` Wert.</span><span class="sxs-lookup"><span data-stu-id="baa1d-221">The method initiates the transaction via a call to `BeginTransaction` and then, in the `try` block, iterates through the supplied list calling the DB-Direct pattern `Delete` method for each `ProductID` value.</span></span> <span data-ttu-id="baa1d-222">Wenn alle Aufrufe des `Delete` ein Fehler auftritt, wird die Steuerung an die `catch` Block, in dem die Transaktion zurückgesetzt wird, und die Ausnahme erneut ausgelöst.</span><span class="sxs-lookup"><span data-stu-id="baa1d-222">If any of the calls to `Delete` fails, control is transferred to the `catch` block where the transaction is rolled back and the exception re-thrown.</span></span> <span data-ttu-id="baa1d-223">Wenn alle Aufrufe `Delete` erfolgreich ausgeführt werden, und klicken Sie dann die Transaktion ein Commit ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="baa1d-223">If all calls to `Delete` succeed, then transaction is committed.</span></span> <span data-ttu-id="baa1d-224">Fügen Sie diese Methode, um die `ProductsBLL` Klasse.</span><span class="sxs-lookup"><span data-stu-id="baa1d-224">Add this method to the `ProductsBLL` class.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample5.cs)]

## <a name="applying-transactions-across-multiple-tableadapters"></a><span data-ttu-id="baa1d-225">Anwenden von Transaktionen über mehrere TableAdapters</span><span class="sxs-lookup"><span data-stu-id="baa1d-225">Applying Transactions Across Multiple TableAdapters</span></span>

<span data-ttu-id="baa1d-226">Die transaktionsbezogenen Code untersucht, die in diesem Lernprogramm kann für mehrere Anweisungen für die `ProductsTableAdapter` als atomarer Vorgang behandelt werden soll.</span><span class="sxs-lookup"><span data-stu-id="baa1d-226">The transaction-related code examined in this tutorial allows for multiple statements against the `ProductsTableAdapter` to be treated as an atomic operation.</span></span> <span data-ttu-id="baa1d-227">Aber was geschieht, wenn mehrere Änderungen an anderen Datenbanktabellen atomar ausgeführt werden müssen?</span><span class="sxs-lookup"><span data-stu-id="baa1d-227">But what if multiple modifications to different database tables need to be performed atomically?</span></span> <span data-ttu-id="baa1d-228">Beispielsweise kann beim Löschen einer Kategorie wir zunächst seine aktuelle Produkte einige andere Kategorie neu zuweisen möchten.</span><span class="sxs-lookup"><span data-stu-id="baa1d-228">For instance, when deleting a category, we might first want to reassign its current products to some other category.</span></span> <span data-ttu-id="baa1d-229">Diese beiden Schritte aus, die Produkte Neuzuweisen und löschen die Kategorie sollte als atomarer Vorgang ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="baa1d-229">These two steps reassigning the products and deleting the category should be executed as an atomic operation.</span></span> <span data-ttu-id="baa1d-230">Aber die `ProductsTableAdapter` enthält nur die Methoden zum Ändern von der `Products` Tabelle und die `CategoriesTableAdapter` enthält nur die Methoden zum Ändern der `Categories` Tabelle.</span><span class="sxs-lookup"><span data-stu-id="baa1d-230">But the `ProductsTableAdapter` includes only methods for modifying the `Products` table and the `CategoriesTableAdapter` includes only methods for modifying the `Categories` table.</span></span> <span data-ttu-id="baa1d-231">Umfassen eine Transaktion kann wie beide TableAdapters?</span><span class="sxs-lookup"><span data-stu-id="baa1d-231">So how can a transaction encompass both TableAdapters?</span></span>

<span data-ttu-id="baa1d-232">Eine Möglichkeit besteht darin, eine Methode zum Hinzufügen der `CategoriesTableAdapter` mit dem Namen `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` und diese Methode eine gespeicherte Prozedur aufrufen, die sowohl die Produkte weist und die Kategorie innerhalb des Bereichs einer Transaktion, die in der gespeicherten Prozedur definiert löscht haben.</span><span class="sxs-lookup"><span data-stu-id="baa1d-232">One option is to add a method to the `CategoriesTableAdapter` named `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` and have that method call a stored procedure that both reassigns the products and deletes the category within the scope of a transaction defined within the stored procedure.</span></span> <span data-ttu-id="baa1d-233">Betrachten wir zum begin, commit und Rollback-Transaktionen in gespeicherten Prozeduren in einem späteren Lernprogramm.</span><span class="sxs-lookup"><span data-stu-id="baa1d-233">We'll look at how to begin, commit, and rollback transactions in stored procedures in a future tutorial.</span></span>

<span data-ttu-id="baa1d-234">Eine weitere Option ist eine Hilfsklasse in der DAL erstellen, enthält die `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` Methode.</span><span class="sxs-lookup"><span data-stu-id="baa1d-234">Another option is to create a helper class in the DAL that contains the `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` method.</span></span> <span data-ttu-id="baa1d-235">Diese Methode würde erstellen Sie eine Instanz von der `CategoriesTableAdapter` und `ProductsTableAdapter` und legen Sie diese in zwei TableAdapters `Connection` Eigenschaften auf den gleichen `SqlConnection` Instanz.</span><span class="sxs-lookup"><span data-stu-id="baa1d-235">This method would create an instance of the `CategoriesTableAdapter` and the `ProductsTableAdapter` and then set these two TableAdapters `Connection` properties to the same `SqlConnection` instance.</span></span> <span data-ttu-id="baa1d-236">AT starten diesen Punkt, entweder eine der beiden TableAdapters würden die Transaktion mit einem Aufruf von `BeginTransaction`.</span><span class="sxs-lookup"><span data-stu-id="baa1d-236">At that point, either one of the two TableAdapters would initiate the transaction with a call to `BeginTransaction`.</span></span> <span data-ttu-id="baa1d-237">Die TableAdapter-Methoden zum Neuzuweisen die Produkte und löschen die Kategorie würde aufgerufen, einem `try...catch` Block mit der Transaktion einen Commit oder Rollback Bedarf zurück.</span><span class="sxs-lookup"><span data-stu-id="baa1d-237">The TableAdapters methods for reassigning the products and deleting the category would be invoked in a `try...catch` block with the transaction committed or rolled back as needed.</span></span>

## <a name="step-4-adding-theupdatewithtransactionmethod-to-the-business-logic-layer"></a><span data-ttu-id="baa1d-238">Schritt 4: Hinzufügen der`UpdateWithTransaction`Methode, um die Geschäftslogikschicht</span><span class="sxs-lookup"><span data-stu-id="baa1d-238">Step 4: Adding the`UpdateWithTransaction`Method to the Business Logic Layer</span></span>

<span data-ttu-id="baa1d-239">In Schritt 3 hinzugefügt wir ein `UpdateWithTransaction` Methode, um die `ProductsTableAdapter` in der DAL.</span><span class="sxs-lookup"><span data-stu-id="baa1d-239">In Step 3 we added an `UpdateWithTransaction` method to the `ProductsTableAdapter` in the DAL.</span></span> <span data-ttu-id="baa1d-240">Es sollte eine entsprechende Methode der BLL hinzugefügt werden.</span><span class="sxs-lookup"><span data-stu-id="baa1d-240">We should add a corresponding method to the BLL.</span></span> <span data-ttu-id="baa1d-241">Während die Darstellungsschicht direkt auf die DAL aufzurufenden aufrufen können die `UpdateWithTransaction` -Methode, wird eine mehrstufige Architektur zu definieren, die die DAL aus der Darstellungsschicht isoliert haben diese Lernprogramme strived.</span><span class="sxs-lookup"><span data-stu-id="baa1d-241">While the Presentation Layer could call directly down to the DAL to invoke the `UpdateWithTransaction` method, these tutorials have strived to define a layered architecture that insulates the DAL from the Presentation Layer.</span></span> <span data-ttu-id="baa1d-242">Aus diesem Grund behooves uns dieser Ansatz zu fortfahren.</span><span class="sxs-lookup"><span data-stu-id="baa1d-242">Therefore, it behooves us to continue this approach.</span></span>

<span data-ttu-id="baa1d-243">Öffnen der `ProductsBLL` Klassendatei, und fügen Sie eine Methode mit dem Namen `UpdateWithTransaction` , einfach Aufrufe an die entsprechende DAL-Methode.</span><span class="sxs-lookup"><span data-stu-id="baa1d-243">Open the `ProductsBLL` class file and add a method named `UpdateWithTransaction` that simply calls down to the corresponding DAL method.</span></span> <span data-ttu-id="baa1d-244">Es sollte jetzt zwei neue Methoden in sein `ProductsBLL`: `UpdateWithTransaction`, die Sie gerade hinzugefügt haben, und `DeleteProductsWithTransaction`, der in Schritt 3 hinzugefügt wurde.</span><span class="sxs-lookup"><span data-stu-id="baa1d-244">There should now be two new methods in `ProductsBLL`: `UpdateWithTransaction`, which you just added, and `DeleteProductsWithTransaction`, which was added in Step 3.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample6.cs)]

> [!NOTE]
> <span data-ttu-id="baa1d-245">Diese Methoden schließen Sie nicht die `DataObjectMethodAttribute` Attribut zugewiesen werden, um die meisten Methoden in der `ProductsBLL` Klasse, da wir diese Methoden direkt von den Code-Behind-Klassen von ASP.NET Seiten aufgerufen werden müssen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-245">These methods do not include the `DataObjectMethodAttribute` attribute assigned to most other methods in the `ProductsBLL` class because we'll be invoking these methods directly from the ASP.NET pages code-behind classes.</span></span> <span data-ttu-id="baa1d-246">Bedenken Sie, dass `DataObjectMethodAttribute` wird verwendet, um zu kennzeichnen, welche Methoden in der ObjectDataSource s Konfigurieren von Datenquellen, Assistenten und auf welche Registerkarte (SELECT, UPDATE, INSERT oder DELETE) angezeigt werden soll.</span><span class="sxs-lookup"><span data-stu-id="baa1d-246">Recall that `DataObjectMethodAttribute` is used to flag what methods should appear in the ObjectDataSource s Configure Data Source wizard and under what tab (SELECT, UPDATE, INSERT, or DELETE).</span></span> <span data-ttu-id="baa1d-247">Da die GridView verfügt nicht über integrierte Unterstützung für den Batch bearbeiten oder löschen, müssen wir diese Methoden programmgesteuert aufgerufen, sondern verwenden Sie deklarativen Code frei Ansatz.</span><span class="sxs-lookup"><span data-stu-id="baa1d-247">Since the GridView lacks any built-in support for batch editing or deleting, we'll have to invoke these methods programmatically rather than use the code-free declarative approach.</span></span>


## <a name="step-5-atomically-updating-database-data-from-the-presentation-layer"></a><span data-ttu-id="baa1d-248">Schritt 5: Aktualisieren von Datenbankdaten aus der Darstellungsschicht atomar</span><span class="sxs-lookup"><span data-stu-id="baa1d-248">Step 5: Atomically Updating Database Data from the Presentation Layer</span></span>

<span data-ttu-id="baa1d-249">Um die Auswirkung zu veranschaulichen, die die Transaktion wurde beim Aktualisieren eines Batches von Datensätzen, Let s erstellen eine Benutzeroberfläche, listet alle Produkte in einer GridView und enthält eine Schaltfläche Web, steuern, die beim Klicken auf die Produkte weist `CategoryID` Werte.</span><span class="sxs-lookup"><span data-stu-id="baa1d-249">To illustrate the effect that the transaction has when updating a batch of records, let s create a user interface that lists all products in a GridView and includes a Button Web control that, when clicked, reassigns the products `CategoryID` values.</span></span> <span data-ttu-id="baa1d-250">Insbesondere wird die Kategorie neuzuweisung verstreichen, damit die erste mehrere Produkte eine gültige zugewiesen sind `CategoryID` Wert, während andere absichtlich sind zugewiesen, eine nicht existierende `CategoryID` Wert.</span><span class="sxs-lookup"><span data-stu-id="baa1d-250">In particular, the category reassignment will progress so that the first several products are assigned a valid `CategoryID` value while others are purposefully assigned a non-existent `CategoryID` value.</span></span> <span data-ttu-id="baa1d-251">Wenn Sie versuchen, die Datenbank mit einem Produkt zu aktualisieren, deren `CategoryID` passt sich nicht auf eine vorhandene Kategorie s `CategoryID`, eine foreign Key-einschränkungsverletzung auftreten wird und eine Ausnahme ausgelöst.</span><span class="sxs-lookup"><span data-stu-id="baa1d-251">If we attempt to update the database with a product whose `CategoryID` does not match an existing category s `CategoryID`, a foreign key constraint violation will occur and an exception will be raised.</span></span> <span data-ttu-id="baa1d-252">Was wir in diesem Beispiel sehen sich ergibt, wenn mithilfe einer Transaktion die Ausnahme, die ausgelöst wird, aus der foreign Key-Einschränkung-Verletzung der vorherigen bewirkt gültige `CategoryID` Änderungen rückgängig gemacht werden.</span><span class="sxs-lookup"><span data-stu-id="baa1d-252">What we'll see in this example is that when using a transaction the exception raised from the foreign key constraint violation will cause the previous valid `CategoryID` changes to be rolled back.</span></span> <span data-ttu-id="baa1d-253">Wenn eine Transaktion nicht verwendet werden soll, bleibt jedoch die Änderungen an der anfänglichen Kategorien.</span><span class="sxs-lookup"><span data-stu-id="baa1d-253">When not using a transaction, however, the modifications to the initial categories will remain.</span></span>

<span data-ttu-id="baa1d-254">Öffnen Sie zunächst die `Transactions.aspx` auf der Seite der `BatchData` Ordner, und ziehen Sie eine GridView aus der Toolbox in den Designer.</span><span class="sxs-lookup"><span data-stu-id="baa1d-254">Start by opening the `Transactions.aspx` page in the `BatchData` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="baa1d-255">Legen Sie dessen `ID` auf `Products` und aus seinem Smarttag binden Sie es an eine neue ObjectDataSource mit dem Namen `ProductsDataSource`.</span><span class="sxs-lookup"><span data-stu-id="baa1d-255">Set its `ID` to `Products` and, from its smart tag, bind it to a new ObjectDataSource named `ProductsDataSource`.</span></span> <span data-ttu-id="baa1d-256">Konfigurieren der ObjectDataSource zum Abrufen der zugehörigen Daten aus der `ProductsBLL` Klasse s `GetProducts` Methode.</span><span class="sxs-lookup"><span data-stu-id="baa1d-256">Configure the ObjectDataSource to pull its data from the `ProductsBLL` class s `GetProducts` method.</span></span> <span data-ttu-id="baa1d-257">Eine GridView schreibgeschützt sein wird, so legen Sie die Dropdownlisten in der Update-, INSERT- und Löschen von Registerkarten (keine) und klicken Sie auf ' Fertig stellen '.</span><span class="sxs-lookup"><span data-stu-id="baa1d-257">This will be a read-only GridView, so set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and click Finish.</span></span>


<span data-ttu-id="baa1d-258">[![Abbildung 5: Konfigurieren der ObjectDataSource zur Verwendung der ProductsBLL Klasse s GetProducts-Methode](wrapping-database-modifications-within-a-transaction-cs/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="baa1d-258">[![Figure 5: Configure the ObjectDataSource to Use the ProductsBLL Class s GetProducts Method](wrapping-database-modifications-within-a-transaction-cs/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image3.png)</span></span>

<span data-ttu-id="baa1d-259">**Abbildung 5**: Abbildung 5: Konfigurieren der ObjectDataSource verwenden die `ProductsBLL` Klasse s `GetProducts` Methode ([klicken Sie hier, um das Bild in voller Größe angezeigt](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="baa1d-259">**Figure 5**: Figure 5: Configure the ObjectDataSource to Use the `ProductsBLL` Class s `GetProducts` Method ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span></span>


<span data-ttu-id="baa1d-260">[![Legen Sie die Dropdownlisten in der Update-, INSERT- und Löschen von Registerkarten auf (keine)](wrapping-database-modifications-within-a-transaction-cs/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="baa1d-260">[![Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)](wrapping-database-modifications-within-a-transaction-cs/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image5.png)</span></span>

<span data-ttu-id="baa1d-261">**Abbildung 6**: Legen Sie das Dropdown-Listen in aktualisieren, einfügen und Löschen von Registerkarten auf (keine) ([klicken Sie hier, um das Bild in voller Größe angezeigt](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="baa1d-261">**Figure 6**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span></span>


<span data-ttu-id="baa1d-262">Nach Abschluss des Konfigurieren von Datenquellen-Assistenten, erstellt Visual Studio BoundFields und eine CheckBoxField für das Produkt von Datenfeldern.</span><span class="sxs-lookup"><span data-stu-id="baa1d-262">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and a CheckBoxField for the product data fields.</span></span> <span data-ttu-id="baa1d-263">Entfernen Sie alle diese Felder mit Ausnahme von `ProductID`, `ProductName`, `CategoryID`, und `CategoryName` , und benennen Sie die `ProductName` und `CategoryName` BoundFields `HeaderText` Eigenschaften Produkt und Kategorie bzw.</span><span class="sxs-lookup"><span data-stu-id="baa1d-263">Remove all of these fields except for `ProductID`, `ProductName`, `CategoryID`, and `CategoryName` and rename the `ProductName` and `CategoryName` BoundFields `HeaderText` properties to Product and Category, respectively.</span></span> <span data-ttu-id="baa1d-264">Überprüfen Sie aus dem Smarttag die Option Paging aktivieren.</span><span class="sxs-lookup"><span data-stu-id="baa1d-264">From the smart tag, check the Enable Paging option.</span></span> <span data-ttu-id="baa1d-265">Nachdem Sie diese Änderungen vornehmen, sollten die GridView und ObjectDataSource s deklarative Markup wie folgt aussehen:</span><span class="sxs-lookup"><span data-stu-id="baa1d-265">After making these modifications, the GridView and ObjectDataSource s declarative markup should look like the following:</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample7.aspx)]

<span data-ttu-id="baa1d-266">Als Nächstes fügen Sie oberhalb der GridView drei Schaltfläche Websteuerelemente.</span><span class="sxs-lookup"><span data-stu-id="baa1d-266">Next, add three Button Web controls above the GridView.</span></span> <span data-ttu-id="baa1d-267">Legen Sie die erste Schaltfläche s Texteigenschaft auf Raster aktualisieren, die zweite s Kategorien ändern (mit Transaktion) und die dritte s zu ändern, Kategorien (ohne Transaktion).</span><span class="sxs-lookup"><span data-stu-id="baa1d-267">Set the first Button s Text property to Refresh Grid, the second s to Modify Categories (WITH TRANSACTION), and the third one s to Modify Categories (WITHOUT TRANSACTION) .</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample8.aspx)]

<span data-ttu-id="baa1d-268">An diesem Punkt sollte die Entwurfsansicht in Visual Studio Siehe Abbildung 7 Screenshot ähneln.</span><span class="sxs-lookup"><span data-stu-id="baa1d-268">At this point the Design view in Visual Studio should look similar to the screen shot shown in Figure 7.</span></span>


<span data-ttu-id="baa1d-269">[![Diese Seite enthält eine GridView und drei Schaltflächensteuerelemente Web](wrapping-database-modifications-within-a-transaction-cs/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="baa1d-269">[![The Page Contains a GridView and Three Button Web Controls](wrapping-database-modifications-within-a-transaction-cs/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image7.png)</span></span>

<span data-ttu-id="baa1d-270">**Abbildung 7**: die Seite enthält eine GridView und drei Schaltfläche Web Controls ([klicken Sie hier, um das Bild in voller Größe angezeigt](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="baa1d-270">**Figure 7**: The Page Contains a GridView and Three Button Web Controls ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span></span>


<span data-ttu-id="baa1d-271">Erstellen von Ereignishandlern für jede der drei Schaltfläche s `Click` Ereignisse und verwenden Sie folgenden Code:</span><span class="sxs-lookup"><span data-stu-id="baa1d-271">Create event handlers for each of the three Button s `Click` events and use the following code:</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample9.cs)]

<span data-ttu-id="baa1d-272">Die Aktualisierung Schaltfläche s `Click` Ereignishandler bindet die Daten an die GridView einfach durch Aufrufen der `Products` GridView s `DataBind` Methode.</span><span class="sxs-lookup"><span data-stu-id="baa1d-272">The refresh Button s `Click` event handler simply rebinds the data to the GridView by calling the `Products` GridView s `DataBind` method.</span></span>

<span data-ttu-id="baa1d-273">Der zweite Ereignishandler weist die Produkte `CategoryID` s und verwendet die neue Transaktion-Methode der BLL zum Ausführen der Datenbank des wirkungsfelds einer Transaktion aktualisiert.</span><span class="sxs-lookup"><span data-stu-id="baa1d-273">The second event handler reassigns the products `CategoryID` s and uses the new transaction method from the BLL to perform the database updates under the umbrella of a transaction.</span></span> <span data-ttu-id="baa1d-274">Beachten Sie, dass jedes Produkt s `CategoryID` nach dem Zufallsprinzip festgelegt ist, auf den gleichen Wert wie die `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="baa1d-274">Note that each product s `CategoryID` is arbitrarily set to the same value as its `ProductID`.</span></span> <span data-ttu-id="baa1d-275">Dies funktioniert hervorragend für das erste einige Produkte seit dieser Produkte haben `ProductID` Werte, die durchgeführt werden, um gültige zuzuordnen `CategoryID` s.</span><span class="sxs-lookup"><span data-stu-id="baa1d-275">This will work fine for the first few products, since those products have `ProductID` values that happen to map to valid `CategoryID` s.</span></span> <span data-ttu-id="baa1d-276">Doch einmal die `ProductID` s-Start zu groß, diese Zufall Überschneidung von `ProductID` s und `CategoryID` s nicht mehr gültig.</span><span class="sxs-lookup"><span data-stu-id="baa1d-276">But once the `ProductID` s start getting too large, this coincidental overlap of `ProductID` s and `CategoryID` s no longer applies.</span></span>

<span data-ttu-id="baa1d-277">Das dritte `Click` Ereignishandler aktualisiert die Produkte `CategoryID` s auf die gleiche Weise sendet das Update jedoch mit der Datenbank mithilfe der `ProductsTableAdapter` s-Standard `Update` Methode.</span><span class="sxs-lookup"><span data-stu-id="baa1d-277">The third `Click` event handler updates the products `CategoryID` s in the same manner, but sends the update to the database using the `ProductsTableAdapter` s default `Update` method.</span></span> <span data-ttu-id="baa1d-278">Dies `Update` Methode die Reihe von Befehlen in einer Transaktion wird nicht umbrochen, bleiben, damit diese Änderungen vor dem ersten Fehler beim foreign Key-Einschränkung Verletzung vorgenommen werden.</span><span class="sxs-lookup"><span data-stu-id="baa1d-278">This `Update` method does not wrap the series of commands within a transaction, so those changes are made prior to the first encountered foreign key constraint violation error will persist.</span></span>

<span data-ttu-id="baa1d-279">Um dieses Verhalten zu demonstrieren, finden Sie auf dieser Seite über einen Browser.</span><span class="sxs-lookup"><span data-stu-id="baa1d-279">To demonstrate this behavior, visit this page through a browser.</span></span> <span data-ttu-id="baa1d-280">Zunächst sollte die erste Seite der Daten angezeigt werden, wie in Abbildung 8 gezeigt.</span><span class="sxs-lookup"><span data-stu-id="baa1d-280">Initially you should see the first page of data as shown in Figure 8.</span></span> <span data-ttu-id="baa1d-281">Klicken Sie als Nächstes auf die Schaltfläche mit den Kategorien ändern (mit TRANSACTION).</span><span class="sxs-lookup"><span data-stu-id="baa1d-281">Next, click the Modify Categories (WITH TRANSACTION) button.</span></span> <span data-ttu-id="baa1d-282">Dadurch wird einen Postback und versucht, alle Produkte aktualisieren `CategoryID` Werte aber führt zu einer Verletzung der foreign Key-Einschränkung (siehe Abbildung 9).</span><span class="sxs-lookup"><span data-stu-id="baa1d-282">This will cause a postback and attempt to update all of the products `CategoryID` values, but will result in a foreign key constraint violation (see Figure 9).</span></span>


<span data-ttu-id="baa1d-283">[![Die Produkte werden in einem auslagerungsfähigen GridView angezeigt.](wrapping-database-modifications-within-a-transaction-cs/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="baa1d-283">[![The Products are Displayed in a Pageable GridView](wrapping-database-modifications-within-a-transaction-cs/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image9.png)</span></span>

<span data-ttu-id="baa1d-284">**Abbildung 8**: die Produkte werden in einem auslagerungsfähigen GridView angezeigt ([klicken Sie hier, um das Bild in voller Größe angezeigt](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="baa1d-284">**Figure 8**: The Products are Displayed in a Pageable GridView ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png))</span></span>


<span data-ttu-id="baa1d-285">[![Erneutes Zuweisen von den Ergebnissen Kategorien zu einer Verletzung der Foreign Key-Einschränkung](wrapping-database-modifications-within-a-transaction-cs/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="baa1d-285">[![Reassigning the Categories Results in a Foreign Key Constraint Violation](wrapping-database-modifications-within-a-transaction-cs/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image11.png)</span></span>

<span data-ttu-id="baa1d-286">**Abbildung 9**: Erneutes Zuweisen von den Ergebnissen Kategorien zu einer Verletzung der Foreign Key-Einschränkung ([klicken Sie hier, um das Bild in voller Größe angezeigt](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="baa1d-286">**Figure 9**: Reassigning the Categories Results in a Foreign Key Constraint Violation ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png))</span></span>


<span data-ttu-id="baa1d-287">Drücken Sie jetzt Ihr Browser s-Schaltfläche "zurück", und klicken Sie dann auf die Schaltfläche "Raster aktualisieren".</span><span class="sxs-lookup"><span data-stu-id="baa1d-287">Now hit your browser s Back button and then click the Refresh Grid button.</span></span> <span data-ttu-id="baa1d-288">Beim Aktualisieren der Daten sehen Sie genaue dieselbe Ausgabe wie in Abbildung 8 gezeigt.</span><span class="sxs-lookup"><span data-stu-id="baa1d-288">Upon refreshing the data you should see the exact same output as shown in Figure 8.</span></span> <span data-ttu-id="baa1d-289">D. h. auch jedoch für einige der Produkte `CategoryID` s wurden um rechtliche geänderten Werte und in der Datenbank aktualisiert, sie wurden zurückgesetzt, wenn die foreign Key-Einschränkung verletzt.</span><span class="sxs-lookup"><span data-stu-id="baa1d-289">That is, even though some of the products `CategoryID` s were changed to legal values and updated in the database, they were rolled back when the foreign key constraint violation occurred.</span></span>

<span data-ttu-id="baa1d-290">Probieren Sie Sie auf die Schaltfläche ändern Kategorien (ohne Transaktion).</span><span class="sxs-lookup"><span data-stu-id="baa1d-290">Now try clicking the Modify Categories (WITHOUT TRANSACTION) button.</span></span> <span data-ttu-id="baa1d-291">Dies führt zu dem Fehler aufgrund einer einschränkungsverletzung gleichen foreign Key-Einschränkung (siehe Abbildung 9), aber dieses Mal die Produkte, deren `CategoryID` Werte wurden geändert, um eine gültige Wert wird nicht zurückgesetzt werden.</span><span class="sxs-lookup"><span data-stu-id="baa1d-291">This will result in the same foreign key constraint violation error (see Figure 9), but this time those products whose `CategoryID` values were changed to a legal value will not be rolled back.</span></span> <span data-ttu-id="baa1d-292">Drücken Sie Ihr Browser s-Schaltfläche "zurück", und klicken Sie dann die Schaltfläche "Raster aktualisieren".</span><span class="sxs-lookup"><span data-stu-id="baa1d-292">Hit your browser s Back button and then the Refresh Grid button.</span></span> <span data-ttu-id="baa1d-293">Wie in Abbildung 10 gezeigt, die `CategoryID` s der ersten acht Produkte wurden neu zugewiesen wurde.</span><span class="sxs-lookup"><span data-stu-id="baa1d-293">As Figure 10 shows, the `CategoryID` s of the first eight products have been reassigned.</span></span> <span data-ttu-id="baa1d-294">In Abbildung 8 mussten ändern z. B. eine `CategoryID` 1, aber in Abbildung 10 It s 2 zugewiesen wurde.</span><span class="sxs-lookup"><span data-stu-id="baa1d-294">For example, in Figure 8, Chang had a `CategoryID` of 1, but in Figure 10 it s been reassigned to 2.</span></span>


<span data-ttu-id="baa1d-295">[![Einige Produkte CategoryID Werte wurden aktualisiert, während andere wurden nicht](wrapping-database-modifications-within-a-transaction-cs/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="baa1d-295">[![Some Products CategoryID Values were Updated While Others Were Not](wrapping-database-modifications-within-a-transaction-cs/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image13.png)</span></span>

<span data-ttu-id="baa1d-296">**Abbildung 10**: Einige Produkte `CategoryID` Werte wurden aktualisiert, während andere wurden nicht ([klicken Sie hier, um das Bild in voller Größe angezeigt](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="baa1d-296">**Figure 10**: Some Products `CategoryID` Values were Updated While Others Were Not ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span></span>


## <a name="summary"></a><span data-ttu-id="baa1d-297">Zusammenfassung</span><span class="sxs-lookup"><span data-stu-id="baa1d-297">Summary</span></span>

<span data-ttu-id="baa1d-298">Standardmäßig die TableAdapter-s-Methoden nicht die Datenbank ausgeführten Anweisungen innerhalb des Bereichs einer Transaktion umbrechen, jedoch mit ein wenig Aufwand können wir die Methoden, die erstellt werden, Commit- und Rollback einer Transaktion hinzufügen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-298">By default, the TableAdapter s methods do not wrap the executed database statements within the scope of a transaction, but with a little work we can add methods that will create, commit, and rollback a transaction.</span></span> <span data-ttu-id="baa1d-299">In diesem Lernprogramm erstellt es drei Methoden in der `ProductsTableAdapter` Klasse: `BeginTransaction`, `CommitTransaction`, und `RollbackTransaction`.</span><span class="sxs-lookup"><span data-stu-id="baa1d-299">In this tutorial we created three such methods in the `ProductsTableAdapter` class: `BeginTransaction`, `CommitTransaction`, and `RollbackTransaction`.</span></span> <span data-ttu-id="baa1d-300">Wurde erläutert, wie diese Methoden zusammen mit einem `try...catch` Block, um eine Reihe von Anweisungen zur Datenänderung atomic.</span><span class="sxs-lookup"><span data-stu-id="baa1d-300">We saw how to use these methods along with a `try...catch` block to make a series of data modification statements atomic.</span></span> <span data-ttu-id="baa1d-301">Insbesondere haben wir erstellt die `UpdateWithTransaction` Methode in der `ProductsTableAdapter`, die mithilfe des Musters BatchUpdate führen Sie die notwendigen Änderungen an den Zeilen der einen bereitgestellten `ProductsDataTable`.</span><span class="sxs-lookup"><span data-stu-id="baa1d-301">In particular, we created the `UpdateWithTransaction` method in the `ProductsTableAdapter`, which uses the Batch Update pattern to perform the necessary modifications to the rows of a supplied `ProductsDataTable`.</span></span> <span data-ttu-id="baa1d-302">Wir auch hinzugefügt der `DeleteProductsWithTransaction` Methode, um die `ProductsBLL` Klasse in der BLL akzeptiert eine `List` von `ProductID` -Werte als Eingabe und ruft die Methode der DB-Direct-Muster `Delete` für jede `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="baa1d-302">We also added the `DeleteProductsWithTransaction` method to the `ProductsBLL` class in the BLL, which accepts a `List` of `ProductID` values as its input and calls the DB-Direct pattern method `Delete` for each `ProductID`.</span></span> <span data-ttu-id="baa1d-303">Beide Methoden zu starten, indem Sie eine Transaktion erstellen und ausführen klicken Sie dann die Anweisungen zur Datenänderung in einer `try...catch` Block.</span><span class="sxs-lookup"><span data-stu-id="baa1d-303">Both methods start by creating a transaction and then executing the data modification statements within a `try...catch` block.</span></span> <span data-ttu-id="baa1d-304">Wenn eine Ausnahme auftritt, wird ein Rollback für die Transaktion, andernfalls ist es ein Commit ausgeführt wurde.</span><span class="sxs-lookup"><span data-stu-id="baa1d-304">If an exception occurs, the transaction is rolled back, otherwise it is committed.</span></span>

<span data-ttu-id="baa1d-305">Schritt 5 veranschaulicht den Effekt der transaktionalen BatchUpdates im Vergleich zu BatchUpdates, für die Verwendung eine Transaktion versäumt.</span><span class="sxs-lookup"><span data-stu-id="baa1d-305">Step 5 illustrated the effect of transactional batch updates versus batch updates that neglected to use a transaction.</span></span> <span data-ttu-id="baa1d-306">In den nächsten drei Lernprogrammen wir bauen auf die in diesem Lernprogramm genannten Foundation und Erstellen von Benutzeroberflächen für BatchUpdates, löschungen und einfügungen ausführen.</span><span class="sxs-lookup"><span data-stu-id="baa1d-306">In the next three tutorials we will build upon the foundation laid in this tutorial and create user interfaces for performing batch updates, deletes, and inserts.</span></span>

<span data-ttu-id="baa1d-307">Viel Spaß beim Programmieren!</span><span class="sxs-lookup"><span data-stu-id="baa1d-307">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="baa1d-308">Weiterführende Themen</span><span class="sxs-lookup"><span data-stu-id="baa1d-308">Further Reading</span></span>

<span data-ttu-id="baa1d-309">Weitere Informationen zu den Themen in diesem Lernprogramm erläutert finden Sie in den folgenden Ressourcen:</span><span class="sxs-lookup"><span data-stu-id="baa1d-309">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="baa1d-310">Wahrung der Datenbankkonsistenz mit Transaktionen</span><span class="sxs-lookup"><span data-stu-id="baa1d-310">Maintaining Database Consistency with Transactions</span></span>](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx)
- [<span data-ttu-id="baa1d-311">Verwalten von Transaktionen in SQLServer gespeicherte Prozeduren</span><span class="sxs-lookup"><span data-stu-id="baa1d-311">Managing Transactions in SQL Server Stored Procedures</span></span>](http://www.4guysfromrolla.com/webtech/080305-1.shtml)
- [<span data-ttu-id="baa1d-312">Transaktionen, die leicht gemacht werden: `System.Transactions`</span><span class="sxs-lookup"><span data-stu-id="baa1d-312">Transactions Made Easy: `System.Transactions`</span></span>](https://blogs.msdn.com/florinlazar/archive/2004/07/23/192239.aspx)
- [<span data-ttu-id="baa1d-313">"TransactionScope" und "DataAdapters"</span><span class="sxs-lookup"><span data-stu-id="baa1d-313">TransactionScope and DataAdapters</span></span>](http://andyclymer.blogspot.com/2007/01/transactionscope-and-dataadapters.html)
- [<span data-ttu-id="baa1d-314">Mithilfe von Oracle Database Transactions in .NET</span><span class="sxs-lookup"><span data-stu-id="baa1d-314">Using Oracle Database Transactions in .NET</span></span>](http://www.oracle.com/technology/pub/articles/price_dbtrans_dotnet.html)

## <a name="about-the-author"></a><span data-ttu-id="baa1d-315">Informationen zum Autor</span><span class="sxs-lookup"><span data-stu-id="baa1d-315">About the Author</span></span>

<span data-ttu-id="baa1d-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), Autor von sieben ASP/ASP.NET-Büchern und Gründer von [4GuysFromRolla.com](http://www.4guysfromrolla.com), Microsoft Web-Technologien seit 1998 arbeitet.</span><span class="sxs-lookup"><span data-stu-id="baa1d-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="baa1d-317">Scott fungiert als ein unabhängiger Berater, Trainer und Writer.</span><span class="sxs-lookup"><span data-stu-id="baa1d-317">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="baa1d-318">Sein neueste Buch wird [ *Sams Schulen selbst ASP.NET 2.0 in 24 Stunden*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="baa1d-318">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="baa1d-319">Er die erreicht werden kann, zur [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) oder über seinen Blog die finden Sie unter [ http://ScottOnWriting.NET ](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="baa1d-319">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="baa1d-320">Besonderen Dank an</span><span class="sxs-lookup"><span data-stu-id="baa1d-320">Special Thanks To</span></span>

<span data-ttu-id="baa1d-321">Diese Reihe von Lernprogrammen wurde durch viele nützliche Bearbeiter überprüft.</span><span class="sxs-lookup"><span data-stu-id="baa1d-321">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="baa1d-322">Lead Prüfer für dieses Lernprogramm wurden Dave Gardner Hilton Giesenow und Teresa Murphy.</span><span class="sxs-lookup"><span data-stu-id="baa1d-322">Lead reviewers for this tutorial were Dave Gardner, Hilton Giesenow, and Teresa Murphy.</span></span> <span data-ttu-id="baa1d-323">Meine bevorstehende MSDN-Artikel Überprüfen von Interesse?</span><span class="sxs-lookup"><span data-stu-id="baa1d-323">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="baa1d-324">Wenn dies der Fall ist, löschen Sie mich zeilenweise [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="baa1d-324">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="baa1d-325">Nächste</span><span class="sxs-lookup"><span data-stu-id="baa1d-325">Next</span></span>](batch-updating-cs.md)

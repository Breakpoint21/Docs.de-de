---
uid: web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
title: "Verhindern von Cross-Site Request Websiteübergreifender Anforderungsfälschung-Angriffen in ASP.NET Web-API | Microsoft Docs"
author: MikeWasson
description: "Beschreibt die siteübergreifende Anforderung Websiteübergreifender anforderungsfälschung Angriff und wie Anti-CSRF-Measures in ASP.NET Web-API implementiert."
ms.author: aspnetcontent
manager: wpickett
ms.date: 12/12/2012
ms.topic: article
ms.assetid: 81d46f14-8f48-4d8c-830d-cc8d594dc11b
ms.technology: dotnet-webapi
ms.prod: .net-framework
msc.legacyurl: /web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
msc.type: authoredcontent
ms.openlocfilehash: 1cd03f3b396cc2ece1d8dbe6820f6277c02d8e62
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 11/10/2017
---
<a name="preventing-cross-site-request-forgery-csrf-attacks-in-aspnet-web-api"></a><span data-ttu-id="08a25-103">Verhindern von Cross-Site Request Websiteübergreifender Anforderungsfälschung-Angriffen in ASP.NET Web-API</span><span class="sxs-lookup"><span data-stu-id="08a25-103">Preventing Cross-Site Request Forgery (CSRF) Attacks in ASP.NET Web API</span></span>
====================
<span data-ttu-id="08a25-104">durch [Mike Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="08a25-104">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

<span data-ttu-id="08a25-105">Cross-Site Request Fälschung Websiteübergreifender ist ein Angriff, in denen eine bösartige Website sendet eine Anforderung mit einem gefährdeten Standort, in dem der Benutzer zurzeit angemeldet ist</span><span class="sxs-lookup"><span data-stu-id="08a25-105">Cross-Site Request Forgery (CSRF) is an attack where a malicious site sends a request to a vulnerable site where the user is currently logged in</span></span>

<span data-ttu-id="08a25-106">Hier ist ein Beispiel von CSRF-Angriffen:</span><span class="sxs-lookup"><span data-stu-id="08a25-106">Here is an example of a CSRF attack:</span></span>

1. <span data-ttu-id="08a25-107">Ein Benutzer sich anmeldet www.example.com, Formularauthentifizierung verwenden.</span><span class="sxs-lookup"><span data-stu-id="08a25-107">A user logs into www.example.com, using forms authentication.</span></span>
2. <span data-ttu-id="08a25-108">Der Server authentifiziert den Benutzer.</span><span class="sxs-lookup"><span data-stu-id="08a25-108">The server authenticates the user.</span></span> <span data-ttu-id="08a25-109">Die Antwort vom Server enthält ein Authentifizierungscookie.</span><span class="sxs-lookup"><span data-stu-id="08a25-109">The response from the server includes an authentication cookie.</span></span>
3. <span data-ttu-id="08a25-110">Ohne Abmelden, wechselt der Benutzer eine bösartige Website.</span><span class="sxs-lookup"><span data-stu-id="08a25-110">Without logging out, the user visits a malicious web site.</span></span> <span data-ttu-id="08a25-111">Diese bösartige Website enthält die folgenden HTML-Formular:</span><span class="sxs-lookup"><span data-stu-id="08a25-111">This malicious site contains the following HTML form:</span></span> 

    [!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample1.html)]

    <span data-ttu-id="08a25-112">Beachten Sie, dass die formaktion an den Standort anfällig für nicht auf die bösartige Website sendet.</span><span class="sxs-lookup"><span data-stu-id="08a25-112">Notice that the form action posts to the vulnerable site, not to the malicious site.</span></span> <span data-ttu-id="08a25-113">Dies ist der "Cross-Site" Teil CSRF.</span><span class="sxs-lookup"><span data-stu-id="08a25-113">This is the "cross-site" part of CSRF.</span></span>
4. <span data-ttu-id="08a25-114">Der Benutzer klickt auf die Schaltfläche "Absenden".</span><span class="sxs-lookup"><span data-stu-id="08a25-114">The user clicks the submit button.</span></span> <span data-ttu-id="08a25-115">Der Browser umfasst das Authentifizierungscookie mit der Anforderung.</span><span class="sxs-lookup"><span data-stu-id="08a25-115">The browser includes the authentication cookie with the request.</span></span>
5. <span data-ttu-id="08a25-116">Die Anforderung auf dem Server mit dem Kontext des Benutzers Authentifizierung ausgeführt und Aktionen möglich, die ein authentifizierter Benutzer tun darf.</span><span class="sxs-lookup"><span data-stu-id="08a25-116">The request runs on the server with the user's authentication context, and can do anything that an authenticated user is allowed to do.</span></span>

<span data-ttu-id="08a25-117">Obwohl in diesem Beispiel wird den Benutzer auf die Formularschaltfläche erforderlich sind, konnte die böswillige Seite so fest, wie Sie problemlos ein Skript ausführen, das das Formular automatisch sendet.</span><span class="sxs-lookup"><span data-stu-id="08a25-117">Although this example requires the user to click the form button, the malicious page could just as easily run a script that submits the form automatically.</span></span> <span data-ttu-id="08a25-118">Darüber hinaus verhindert mit SSL eine CSRF-Angriffen nicht, da die bösartige Website "https://"-Anforderung senden kann.</span><span class="sxs-lookup"><span data-stu-id="08a25-118">Moreover, using SSL does not prevent a CSRF attack, because the malicious site can send an "https://" request.</span></span>

<span data-ttu-id="08a25-119">In der Regel sind CSRF-Angriffen möglich für Websites, die Cookies für die Authentifizierung verwenden, da Browser alle relevanten Cookies an die Ziel-Website senden.</span><span class="sxs-lookup"><span data-stu-id="08a25-119">Typically, CSRF attacks are possible against web sites that use cookies for authentication, because browsers send all relevant cookies to the destination web site.</span></span> <span data-ttu-id="08a25-120">CSRF-Angriffen sind jedoch nicht beschränkt auf Cookies ausnutzen.</span><span class="sxs-lookup"><span data-stu-id="08a25-120">However, CSRF attacks are not limited to exploiting cookies.</span></span> <span data-ttu-id="08a25-121">Beispielsweise Basis-und Digestauthentifizierung sind auch anfällig.</span><span class="sxs-lookup"><span data-stu-id="08a25-121">For example, Basic and Digest authentication are also vulnerable.</span></span> <span data-ttu-id="08a25-122">Nach der Anmeldung eines Benutzers mit Standard-oder Digestauthentifizierung.</span><span class="sxs-lookup"><span data-stu-id="08a25-122">After a user logs in with Basic or Digest authentication.</span></span> <span data-ttu-id="08a25-123">der Browser sendet automatisch die Anmeldeinformationen an, bis die Sitzung beendet.</span><span class="sxs-lookup"><span data-stu-id="08a25-123">the browser automatically sends the credentials until the session ends.</span></span>

## <a name="anti-forgery-tokens"></a><span data-ttu-id="08a25-124">Fälschungssicherheitstoken</span><span class="sxs-lookup"><span data-stu-id="08a25-124">Anti-Forgery Tokens</span></span>

<span data-ttu-id="08a25-125">Zum Vermeiden von CSRF-Angriffen verwendet ASP.NET MVC fälschungssicherheitstoken, so genannte *Überprüfung Token anfordern*.</span><span class="sxs-lookup"><span data-stu-id="08a25-125">To help prevent CSRF attacks, ASP.NET MVC uses anti-forgery tokens, also called *request verification tokens*.</span></span>

1. <span data-ttu-id="08a25-126">Der Client fordert eine HTML-Seite, die ein Formular enthält.</span><span class="sxs-lookup"><span data-stu-id="08a25-126">The client requests an HTML page that contains a form.</span></span>
2. <span data-ttu-id="08a25-127">Der Server enthält zwei Token in der Antwort.</span><span class="sxs-lookup"><span data-stu-id="08a25-127">The server includes two tokens in the response.</span></span> <span data-ttu-id="08a25-128">Ein Token wird als Cookie gesendet.</span><span class="sxs-lookup"><span data-stu-id="08a25-128">One token is sent as a cookie.</span></span> <span data-ttu-id="08a25-129">Der andere wird in ein ausgeblendetes Formularfeld eingefügt.</span><span class="sxs-lookup"><span data-stu-id="08a25-129">The other is placed in a hidden form field.</span></span> <span data-ttu-id="08a25-130">Die Token werden nach dem Zufallsprinzip generiert, so, dass Angreifer die Werte ermittelt werden kann.</span><span class="sxs-lookup"><span data-stu-id="08a25-130">The tokens are generated randomly so that an adversary cannot guess the values.</span></span>
3. <span data-ttu-id="08a25-131">Wenn der Client das Formular sendet, muss er beide Token an den Server senden.</span><span class="sxs-lookup"><span data-stu-id="08a25-131">When the client submits the form, it must send both tokens back to the server.</span></span> <span data-ttu-id="08a25-132">Der Client sendet das cookietoken als Cookie, und er sendet das Token Form innerhalb der Formulardaten.</span><span class="sxs-lookup"><span data-stu-id="08a25-132">The client sends the cookie token as a cookie, and it sends the form token inside the form data.</span></span> <span data-ttu-id="08a25-133">(Ein Browserclient geschieht automatisch, wenn der Benutzer das Formular sendet.)</span><span class="sxs-lookup"><span data-stu-id="08a25-133">(A browser client automatically does this when the user submits the form.)</span></span>
4. <span data-ttu-id="08a25-134">Wenn eine Anforderung nicht beide Token enthält, lässt der Server die Anforderung an.</span><span class="sxs-lookup"><span data-stu-id="08a25-134">If a request does not include both tokens, the server disallows the request.</span></span>

<span data-ttu-id="08a25-135">Hier ist ein Beispiel eines HTML-Formulars mit einem ausgeblendeten Formular-Token:</span><span class="sxs-lookup"><span data-stu-id="08a25-135">Here is an example of an HTML form with a hidden form token:</span></span>

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample2.html)]

<span data-ttu-id="08a25-136">Fälschungssicherheitstoken verwendet werden, da die böswillige Seite das Benutzertoken aufgrund von Richtlinien für denselben Ursprung nicht lesen kann.</span><span class="sxs-lookup"><span data-stu-id="08a25-136">Anti-forgery tokens work because the malicious page cannot read the user's tokens, due to same-origin policies.</span></span> <span data-ttu-id="08a25-137">([Same-Origin-Richtlinien](http://www.w3.org/Security/wiki/Same_Origin_Policy) verhindern, dass Dokumente auf zwei verschiedenen Standorten aus zugreifen auf Inhalte des jeweils anderen gehostet.</span><span class="sxs-lookup"><span data-stu-id="08a25-137">([Same-origin policies](http://www.w3.org/Security/wiki/Same_Origin_Policy) prevent documents hosted on two different sites from accessing each other's content.</span></span> <span data-ttu-id="08a25-138">Damit der oben aufgeführten Beispiel kann die bösartige Seite Anforderungen an example.com senden, aber die Antwort nicht gelesen.)</span><span class="sxs-lookup"><span data-stu-id="08a25-138">So in the earlier example, the malicious page can send requests to example.com, but it cannot read the response.)</span></span>

<span data-ttu-id="08a25-139">Zum Verhindern von CSRF-Angriffen fälschungssicherheitstoken mit Beliebiges Authentifizierungsprotokoll verwenden, in dem im Hintergrund sendet der Browser die Anmeldeinformationen nach der Anmeldung des Benutzers aus.</span><span class="sxs-lookup"><span data-stu-id="08a25-139">To prevent CSRF attacks, use anti-forgery tokens with any authentication protocol where the browser silently sends credentials after the user logs in.</span></span> <span data-ttu-id="08a25-140">Dies umfasst Cookie-basierte Authentifizierung-Protokolle, z. B. Formularauthentifizierung, als auch Protokolle wie z. B. die Standard- und Digest-Authentifizierung.</span><span class="sxs-lookup"><span data-stu-id="08a25-140">This includes cookie-based authentication protocols, such as forms authentication, as well as protocols such as Basic and Digest authentication.</span></span>

<span data-ttu-id="08a25-141">Sie müssen das fälschungssicherheitstoken nonsafe Methoden (POST, PUT, DELETE).</span><span class="sxs-lookup"><span data-stu-id="08a25-141">You should require anti-forgery tokens for any nonsafe methods (POST, PUT, DELETE).</span></span> <span data-ttu-id="08a25-142">Stellen Sie außerdem sicher, dass die sichere Methoden (GET, HEAD) nicht keine Nebeneffekte haben.</span><span class="sxs-lookup"><span data-stu-id="08a25-142">Also, make sure that safe methods (GET, HEAD) do not have any side effects.</span></span> <span data-ttu-id="08a25-143">Darüber hinaus, wenn Sie die domänenübergreifende-Unterstützung, z. B. CORS oder JSONP, aktivieren sind sogar sichere Methoden wie z. B. GET potenziell anfällig für CSRF-Angriffen der Angreifer sensible Daten zu lesen.</span><span class="sxs-lookup"><span data-stu-id="08a25-143">Moreover, if you enable cross-domain support, such as CORS or JSONP, then even safe methods like GET are potentially vulnerable to CSRF attacks, allowing the attacker to read potentially sensitive data.</span></span>

## <a name="anti-forgery-tokens-in-aspnet-mvc"></a><span data-ttu-id="08a25-144">Fälschungssicherheitstoken in ASP.NET MVC</span><span class="sxs-lookup"><span data-stu-id="08a25-144">Anti-Forgery Tokens in ASP.NET MVC</span></span>

<span data-ttu-id="08a25-145">Verwenden Sie zum Hinzufügen der fälschungssicherheitstoken zu einer Razor-Seite der **HtmlHelper.AntiForgeryToken** Hilfsmethode:</span><span class="sxs-lookup"><span data-stu-id="08a25-145">To add the anti-forgery tokens to a Razor page, use the **HtmlHelper.AntiForgeryToken** helper method:</span></span>

[!code-cshtml[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample3.cshtml)]

<span data-ttu-id="08a25-146">Diese Methode fügt die ausgeblendetes Formularfeld und zudem wird das cookietoken.</span><span class="sxs-lookup"><span data-stu-id="08a25-146">This method adds the hidden form field and also sets the cookie token.</span></span>

## <a name="anti-csrf-and-ajax"></a><span data-ttu-id="08a25-147">Anti-CSRF und AJAX</span><span class="sxs-lookup"><span data-stu-id="08a25-147">Anti-CSRF and AJAX</span></span>

<span data-ttu-id="08a25-148">Des formulartokens kann ein Problem für AJAX-Anforderungen, da eine AJAX-Anforderung, JSON-Daten nicht HTML-Formulardaten senden kann.</span><span class="sxs-lookup"><span data-stu-id="08a25-148">The form token can be a problem for AJAX requests, because an AJAX request might send JSON data, not HTML form data.</span></span> <span data-ttu-id="08a25-149">Eine Lösung besteht darin, die Token in einem benutzerdefinierten HTTP-Header zu senden.</span><span class="sxs-lookup"><span data-stu-id="08a25-149">One solution is to send the tokens in a custom HTTP header.</span></span> <span data-ttu-id="08a25-150">Der folgende Code Razor-Syntax verwendet, um die Token zu generieren und fügt dann die Token eine AJAX-Anforderung hinzu.</span><span class="sxs-lookup"><span data-stu-id="08a25-150">The following code uses Razor syntax to generate the tokens, and then adds the tokens to an AJAX request.</span></span> <span data-ttu-id="08a25-151">Die Token werden durch den Aufruf auf dem Server generierte **AntiForgery.GetTokens**.</span><span class="sxs-lookup"><span data-stu-id="08a25-151">The tokens are generated at the server by calling **AntiForgery.GetTokens**.</span></span>

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample4.html)]

<span data-ttu-id="08a25-152">Beim Verarbeiten der Anforderung extrahieren Sie das Token aus dem Anforderungsheader.</span><span class="sxs-lookup"><span data-stu-id="08a25-152">When you process the request, extract the tokens from the request header.</span></span> <span data-ttu-id="08a25-153">Rufen Sie anschließend die **AntiForgery.Validate** Methode zum Überprüfen der Token.</span><span class="sxs-lookup"><span data-stu-id="08a25-153">Then call the **AntiForgery.Validate** method to validate the tokens.</span></span> <span data-ttu-id="08a25-154">Die **Validate** Methode löst eine Ausnahme aus, wenn das Token nicht gültig sind.</span><span class="sxs-lookup"><span data-stu-id="08a25-154">The **Validate** method throws an exception if the tokens are not valid.</span></span>

[!code-csharp[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample5.cs)]

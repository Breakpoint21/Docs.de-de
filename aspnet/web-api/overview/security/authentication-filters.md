---
uid: web-api/overview/security/authentication-filters
title: Authentifizierungsfilter in der ASP.NET Web API 2 | Microsoft Docs
author: MikeWasson
description: "Ein Authentifizierungsfilter ist eine Komponente, die eine HTTP-Anforderung authentifiziert. Web-API 2 und MVC 5 unterstützen sowohl Authentifizierungsfilter, aber sie unterscheiden sich geringfügig..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 09/25/2014
ms.topic: article
ms.assetid: b9882e53-b3ca-4def-89b0-322846973ccb
ms.technology: dotnet-webapi
ms.prod: .net-framework
msc.legacyurl: /web-api/overview/security/authentication-filters
msc.type: authoredcontent
ms.openlocfilehash: 7c704cc351876b49ec143a49b25cc0ca83876e06
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 01/24/2018
---
<a name="authentication-filters-in-aspnet-web-api-2"></a><span data-ttu-id="6baa3-104">Authentifizierungsfilter in der ASP.NET Web API 2</span><span class="sxs-lookup"><span data-stu-id="6baa3-104">Authentication Filters in ASP.NET Web API 2</span></span>
====================
<span data-ttu-id="6baa3-105">durch [Mike Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="6baa3-105">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

> <span data-ttu-id="6baa3-106">Ein Authentifizierungsfilter ist eine Komponente, die eine HTTP-Anforderung authentifiziert.</span><span class="sxs-lookup"><span data-stu-id="6baa3-106">An authentication filter is a component that authenticates an HTTP request.</span></span> <span data-ttu-id="6baa3-107">Web-API 2 und MVC 5 unterstützen sowohl Authentifizierungsfilter, aber sie unterscheiden sich geringfügig, meist in den Benennungskonventionen für die Filter-Schnittstelle.</span><span class="sxs-lookup"><span data-stu-id="6baa3-107">Web API 2 and MVC 5 both support authentication filters, but they differ slightly, mostly in the naming conventions for the filter interface.</span></span> <span data-ttu-id="6baa3-108">Dieses Thema beschreibt die Web-API-Authentifizierungsfilter.</span><span class="sxs-lookup"><span data-stu-id="6baa3-108">This topic describes Web API authentication filters.</span></span>


<span data-ttu-id="6baa3-109">Authentifizierungsfilter können Sie ein anderes Authentifizierungsschema für einzelne Controllern oder Aktionen festlegen.</span><span class="sxs-lookup"><span data-stu-id="6baa3-109">Authentication filters let you set an authentication scheme for individual controllers or actions.</span></span> <span data-ttu-id="6baa3-110">Auf diese Weise kann Ihre app unterschiedliche Authentifizierungsmechanismen für verschiedene HTTP-Ressourcen unterstützen.</span><span class="sxs-lookup"><span data-stu-id="6baa3-110">That way, your app can support different authentication mechanisms for different HTTP resources.</span></span>

<span data-ttu-id="6baa3-111">In diesem Artikel zeige ich Code aus der [Standardauthentifizierung](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) -Beispiel unter [http://aspnet.codeplex.com](http://aspnet.codeplex.com). Das Beispiel zeigt einen Authentifizierungsfilter, der dem HTTP-Zugriff standardauthentifizierungsschema (RFC 2617) implementiert.</span><span class="sxs-lookup"><span data-stu-id="6baa3-111">In this article, I'll show code from the [Basic Authentication](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) sample on [http://aspnet.codeplex.com](http://aspnet.codeplex.com). The sample shows an authentication filter that implements the HTTP Basic Access Authentication scheme (RFC 2617).</span></span> <span data-ttu-id="6baa3-112">Der Filter wird in einer Klasse mit dem Namen implementiert `IdentityBasicAuthenticationAttribute`.</span><span class="sxs-lookup"><span data-stu-id="6baa3-112">The filter is implemented in a class named `IdentityBasicAuthenticationAttribute`.</span></span> <span data-ttu-id="6baa3-113">Ich zeigen nicht der gesamte Code aus dem Beispiel nur die Teile an, die veranschaulichen, einen Authentifizierungsfilter zu schreiben.</span><span class="sxs-lookup"><span data-stu-id="6baa3-113">I won't show all of the code from the sample, just the parts that illustrate how to write an authentication filter.</span></span>

## <a name="setting-an-authentication-filter"></a><span data-ttu-id="6baa3-114">Das Festlegen eines Filters für die Authentifizierung</span><span class="sxs-lookup"><span data-stu-id="6baa3-114">Setting an Authentication Filter</span></span>

<span data-ttu-id="6baa3-115">Wie andere Filter auch kann Authentifizierungsfilter pro Controller angewendet, die pro-Aktion oder die Global auf alle Web-API-Controller.</span><span class="sxs-lookup"><span data-stu-id="6baa3-115">Like other filters, authentication filters can be applied per-controller, per-action, or globally to all Web API controllers.</span></span>

<span data-ttu-id="6baa3-116">Um einen Authentifizierungsfilter mit einem Controller anzuwenden, ergänzen Sie die Controllerklasse mit dem Filterattribut.</span><span class="sxs-lookup"><span data-stu-id="6baa3-116">To apply an authentication filter to a controller, decorate the controller class with the filter attribute.</span></span> <span data-ttu-id="6baa3-117">Im folgenden code wird die `[IdentityBasicAuthentication]` Filter für eine Controllerklasse, die Standardauthentifizierung für alle Aktionen für den Controller ermöglicht.</span><span class="sxs-lookup"><span data-stu-id="6baa3-117">The following code sets the `[IdentityBasicAuthentication]` filter on a controller class, which enables Basic Authentication for all of the controller's actions.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample1.cs)]

<span data-ttu-id="6baa3-118">Um den Filter auf eine Aktion anwenden, ergänzen Sie die Aktion mit dem Filter aus.</span><span class="sxs-lookup"><span data-stu-id="6baa3-118">To apply the filter to one action, decorate the action with the filter.</span></span> <span data-ttu-id="6baa3-119">Im folgenden code wird die `[IdentityBasicAuthentication]` Filter auf des Controllers `Post` Methode.</span><span class="sxs-lookup"><span data-stu-id="6baa3-119">The following code sets the `[IdentityBasicAuthentication]` filter on the controller's `Post` method.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample2.cs)]

<span data-ttu-id="6baa3-120">Um den Filter auf alle Web-API-Controller anzuwenden, fügen sie **GlobalConfiguration.Filters**.</span><span class="sxs-lookup"><span data-stu-id="6baa3-120">To apply the filter to all Web API controllers, add it to **GlobalConfiguration.Filters**.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample3.cs)]

## <a name="implementing-a-web-api-authentication-filter"></a><span data-ttu-id="6baa3-121">Implementieren eine Web-API-Authentifizierungsfilter</span><span class="sxs-lookup"><span data-stu-id="6baa3-121">Implementing a Web API Authentication Filter</span></span>

<span data-ttu-id="6baa3-122">In der Web-API, Authentifizierungsfilter implementieren die [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) Schnittstelle.</span><span class="sxs-lookup"><span data-stu-id="6baa3-122">In Web API, authentication filters implement the [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) interface.</span></span> <span data-ttu-id="6baa3-123">Sie sollten auch erben von **System.Attribute**, um als Attribute angewendet werden.</span><span class="sxs-lookup"><span data-stu-id="6baa3-123">They should also inherit from **System.Attribute**, in order to be applied as attributes.</span></span>

<span data-ttu-id="6baa3-124">Die **IAuthenticationFilter** Schnittstelle verfügt über zwei Methoden:</span><span class="sxs-lookup"><span data-stu-id="6baa3-124">The **IAuthenticationFilter** interface has two methods:</span></span>

- <span data-ttu-id="6baa3-125">**AuthenticateAsync** authentifiziert die Anforderung von Anmeldeinformationen in der Anforderung überprüft, falls vorhanden.</span><span class="sxs-lookup"><span data-stu-id="6baa3-125">**AuthenticateAsync** authenticates the request by validating credentials in the request, if present.</span></span>
- <span data-ttu-id="6baa3-126">**ChallengeAsync** der HTTP-Antwort, bei Bedarf eine authentifizierungsaufforderung hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="6baa3-126">**ChallengeAsync** adds an authentication challenge to the HTTP response, if needed.</span></span>

<span data-ttu-id="6baa3-127">Diese Methoden entsprechen den Authentifizierungsablauf in definierten [RFC 2612](http://tools.ietf.org/html/rfc2616) und [RFC 2617](http://tools.ietf.org/html/rfc2617):</span><span class="sxs-lookup"><span data-stu-id="6baa3-127">These methods correspond to the authentication flow defined in [RFC 2612](http://tools.ietf.org/html/rfc2616) and [RFC 2617](http://tools.ietf.org/html/rfc2617):</span></span>

1. <span data-ttu-id="6baa3-128">Der Client sendet die Anmeldeinformationen in der Authorization-Header.</span><span class="sxs-lookup"><span data-stu-id="6baa3-128">The client sends credentials in the Authorization header.</span></span> <span data-ttu-id="6baa3-129">Dies geschieht normalerweise, nachdem der Client eine 401 (nicht autorisiert)-Antwort vom Server empfangen.</span><span class="sxs-lookup"><span data-stu-id="6baa3-129">This typically happens after the client receives a 401 (Unauthorized) response from the server.</span></span> <span data-ttu-id="6baa3-130">Allerdings kann ein Client Anmeldeinformationen mit keiner Anforderung senden, nicht nur nach 401 abrufen.</span><span class="sxs-lookup"><span data-stu-id="6baa3-130">However, a client can send credentials with any request, not just after getting a 401.</span></span>
2. <span data-ttu-id="6baa3-131">Wenn der Server die Anmeldeinformationen nicht akzeptiert, wird die Antwort ein 401 (nicht autorisiert) zurückgegeben.</span><span class="sxs-lookup"><span data-stu-id="6baa3-131">If the server does not accept the credentials, it returns a 401 (Unauthorized) response.</span></span> <span data-ttu-id="6baa3-132">Die Antwort enthält einen Www-Authenticate-Header, der eine oder mehrere Herausforderungen enthält.</span><span class="sxs-lookup"><span data-stu-id="6baa3-132">The response includes a Www-Authenticate header that contains one or more challenges.</span></span> <span data-ttu-id="6baa3-133">Jede Abfrage gibt ein anderes Authentifizierungsschema vom Server erkannt.</span><span class="sxs-lookup"><span data-stu-id="6baa3-133">Each challenge specifies an authentication scheme recognized by the server.</span></span>

<span data-ttu-id="6baa3-134">Der Server kann auch eine anonyme Anforderung 401 zurückgeben.</span><span class="sxs-lookup"><span data-stu-id="6baa3-134">The server can also return 401 from an anonymous request.</span></span> <span data-ttu-id="6baa3-135">Tatsächlich ist, die in der Regel wie der Authentifizierungsprozess initiiert wird:</span><span class="sxs-lookup"><span data-stu-id="6baa3-135">In fact, that's typically how the authentication process is initiated:</span></span>

1. <span data-ttu-id="6baa3-136">Der Client sendet eine anonyme Anforderung an.</span><span class="sxs-lookup"><span data-stu-id="6baa3-136">The client sends an anonymous request.</span></span>
2. <span data-ttu-id="6baa3-137">Der Server gibt 401.</span><span class="sxs-lookup"><span data-stu-id="6baa3-137">The server returns 401.</span></span>
3. <span data-ttu-id="6baa3-138">Die Clients sendet die Anforderung mit Anmeldeinformationen erneut.</span><span class="sxs-lookup"><span data-stu-id="6baa3-138">The clients resends the request with credentials.</span></span>

<span data-ttu-id="6baa3-139">Dieser Datenfluss enthält sowohl *Authentifizierung* und *Autorisierung* Schritte.</span><span class="sxs-lookup"><span data-stu-id="6baa3-139">This flow includes both *authentication* and *authorization* steps.</span></span>

- <span data-ttu-id="6baa3-140">Authentifizierung garantiert die Identität des Clients.</span><span class="sxs-lookup"><span data-stu-id="6baa3-140">Authentication proves the identity of the client.</span></span>
- <span data-ttu-id="6baa3-141">Bestimmt die Autorisierung, ob der Client eine bestimmte Ressource zugreifen kann.</span><span class="sxs-lookup"><span data-stu-id="6baa3-141">Authorization determines whether the client can access a particular resource.</span></span>

<span data-ttu-id="6baa3-142">Behandeln Sie Authentifizierungsfilter in Web-API Authentifizierung, aber keine Autorisierung.</span><span class="sxs-lookup"><span data-stu-id="6baa3-142">In Web API, authentication filters handle authentication, but not authorization.</span></span> <span data-ttu-id="6baa3-143">Autorisierung sollte durch einen Autorisierungsfilter oder innerhalb der Controlleraktion erfolgen.</span><span class="sxs-lookup"><span data-stu-id="6baa3-143">Authorization should be done by an authorization filter or inside the controller action.</span></span>

<span data-ttu-id="6baa3-144">So sieht der Ablauf in der Web-API 2-Pipeline:</span><span class="sxs-lookup"><span data-stu-id="6baa3-144">Here is the flow in the Web API 2 pipeline:</span></span>

1. <span data-ttu-id="6baa3-145">Vor dem Aufrufen einer Aktion, wird die Web-API eine Liste der Authentifizierungsfilter für diese Aktion erstellt.</span><span class="sxs-lookup"><span data-stu-id="6baa3-145">Before invoking an action, Web API creates a list of the authentication filters for that action.</span></span> <span data-ttu-id="6baa3-146">Dies schließt die Filter mit der Aktion Bereich, den Controller Bereich und globalen Bereich.</span><span class="sxs-lookup"><span data-stu-id="6baa3-146">This includes filters with action scope, controller scope, and global scope.</span></span>
2. <span data-ttu-id="6baa3-147">Web-API-Aufrufe **AuthenticateAsync** auf jedem Filter in der Liste.</span><span class="sxs-lookup"><span data-stu-id="6baa3-147">Web API calls **AuthenticateAsync** on every filter in the list.</span></span> <span data-ttu-id="6baa3-148">Jeder Filter kann die Anmeldeinformationen in der Anforderung überprüfen.</span><span class="sxs-lookup"><span data-stu-id="6baa3-148">Each filter can validate credentials in the request.</span></span> <span data-ttu-id="6baa3-149">Wenn ein beliebiger anzuwendender Filter Anmeldeinformationen erfolgreich überprüft hat, erstellt der Filter eine **IPrincipal** und fügt ihn der Anforderung.</span><span class="sxs-lookup"><span data-stu-id="6baa3-149">If any filter successfully validates credentials, the filter creates an **IPrincipal** and attaches it to the request.</span></span> <span data-ttu-id="6baa3-150">Ein Filter kann auch zu diesem Zeitpunkt einen Fehler ausgelöst werden.</span><span class="sxs-lookup"><span data-stu-id="6baa3-150">A filter can also trigger an error at this point.</span></span> <span data-ttu-id="6baa3-151">Wenn dies der Fall ist, wird der Rest der Pipeline nicht ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="6baa3-151">If so, the rest of the pipeline does not run.</span></span>
3. <span data-ttu-id="6baa3-152">Vorausgesetzt, dass kein Fehler vorliegt, fließt die Anforderung durch den Rest der Pipeline.</span><span class="sxs-lookup"><span data-stu-id="6baa3-152">Assuming there is no error, the request flows through the rest of the pipeline.</span></span>
4. <span data-ttu-id="6baa3-153">Zum Schluss Web-API ruft alle Authentifizierungsfilter **ChallengeAsync** Methode.</span><span class="sxs-lookup"><span data-stu-id="6baa3-153">Finally, Web API calls every authentication filter's **ChallengeAsync** method.</span></span> <span data-ttu-id="6baa3-154">Filter mit dieser Methode können Sie die Antwort eine Aufforderung hinzuzufügen, bei Bedarf.</span><span class="sxs-lookup"><span data-stu-id="6baa3-154">Filters use this method to add a challenge to the response, if needed.</span></span> <span data-ttu-id="6baa3-155">In der Regel (aber nicht immer) würde, die als Antwort auf Fehler 401 geschehen.</span><span class="sxs-lookup"><span data-stu-id="6baa3-155">Typically (but not always) that would happen in response to a 401 error.</span></span>

<span data-ttu-id="6baa3-156">Die folgenden Diagramme enthalten zwei möglichen Fälle.</span><span class="sxs-lookup"><span data-stu-id="6baa3-156">The following diagrams show two possible cases.</span></span> <span data-ttu-id="6baa3-157">In der ersten der Authentifizierungsfilter erfolgreich die Anforderung authentifiziert, Autorisierungsfilter wird die Anforderung autorisiert und Controlleraktion gibt 200 (OK) zurück.</span><span class="sxs-lookup"><span data-stu-id="6baa3-157">In the first, the authentication filter successfully authenticates the request, an authorization filter authorizes the request, and the controller action returns 200 (OK).</span></span>

![](authentication-filters/_static/image1.png)

<span data-ttu-id="6baa3-158">Im zweiten Beispiel wird der Authentifizierungsfilter authentifiziert die Anforderung, der Autorisierungsfilter gibt jedoch 401 (nicht autorisiert).</span><span class="sxs-lookup"><span data-stu-id="6baa3-158">In the second example, the authentication filter authenticates the request, but the authorization filter returns 401 (Unauthorized).</span></span> <span data-ttu-id="6baa3-159">In diesem Fall wird der Controlleraktion nicht aufgerufen.</span><span class="sxs-lookup"><span data-stu-id="6baa3-159">In this case, the controller action is not invoked.</span></span> <span data-ttu-id="6baa3-160">Der Authentifizierungsfilter hinzugefügt der Antwort einen Www-Authenticate-Header.</span><span class="sxs-lookup"><span data-stu-id="6baa3-160">The authentication filter adds a Www-Authenticate header to the response.</span></span>

![](authentication-filters/_static/image2.png)

<span data-ttu-id="6baa3-161">Andere Kombinationen sind mögliche&mdash;z. B. wenn Controlleraktion anonyme Anforderungen zulässt, müssen Sie möglicherweise einen Authentifizierungsfilter, aber es liegt keine Autorisierung.</span><span class="sxs-lookup"><span data-stu-id="6baa3-161">Other combinations are possible&mdash;for example, if the controller action allows anonymous requests, you might have an authentication filter but no authorization.</span></span>

## <a name="implementing-the-authenticateasync-method"></a><span data-ttu-id="6baa3-162">Implementieren der AuthenticateAsync-Methode</span><span class="sxs-lookup"><span data-stu-id="6baa3-162">Implementing the AuthenticateAsync Method</span></span>

<span data-ttu-id="6baa3-163">Die **AuthenticateAsync** Methode versucht, die Anforderung zu authentifizieren.</span><span class="sxs-lookup"><span data-stu-id="6baa3-163">The **AuthenticateAsync** method tries to authenticate the request.</span></span> <span data-ttu-id="6baa3-164">Hier wird die Signatur der Methode:</span><span class="sxs-lookup"><span data-stu-id="6baa3-164">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample4.cs)]

<span data-ttu-id="6baa3-165">Die **AuthenticateAsync** Methode muss einen der folgenden Schritte ausführen:</span><span class="sxs-lookup"><span data-stu-id="6baa3-165">The **AuthenticateAsync** method must do one of the following:</span></span>

1. <span data-ttu-id="6baa3-166">Nothing (ohne-Op).</span><span class="sxs-lookup"><span data-stu-id="6baa3-166">Nothing (no-op).</span></span>
2. <span data-ttu-id="6baa3-167">Erstellen einer **IPrincipal** und legen Sie es in der Anforderung.</span><span class="sxs-lookup"><span data-stu-id="6baa3-167">Create an **IPrincipal** and set it on the request.</span></span>
3. <span data-ttu-id="6baa3-168">Legen Sie ein Fehlerergebnis.</span><span class="sxs-lookup"><span data-stu-id="6baa3-168">Set an error result.</span></span>

<span data-ttu-id="6baa3-169">Option (1) bedeutet, dass die Anforderung, sind keine Anmeldeinformationen, die der Filter versteht.</span><span class="sxs-lookup"><span data-stu-id="6baa3-169">Option (1) means the request did not have any credentials that the filter understands.</span></span> <span data-ttu-id="6baa3-170">Option (2) bedeutet, dass der Filter wird die Anforderung erfolgreich authentifiziert.</span><span class="sxs-lookup"><span data-stu-id="6baa3-170">Option (2) means the filter successfully authenticated the request.</span></span> <span data-ttu-id="6baa3-171">Option (3) bedeutet, dass die Anforderung wies ungültige Anmeldeinformationen (z. B. das falsche Kennwort), die eine Fehlerantwort auslöst.</span><span class="sxs-lookup"><span data-stu-id="6baa3-171">Option (3) means the request had invalid credentials (like the wrong password), which triggers an error response.</span></span>

<span data-ttu-id="6baa3-172">Hier ist eine allgemeine Gliederung für die Implementierung **AuthenticateAsync**.</span><span class="sxs-lookup"><span data-stu-id="6baa3-172">Here is a general outline for implementing **AuthenticateAsync**.</span></span>

1. <span data-ttu-id="6baa3-173">Suchen Sie nach Anmeldeinformationen in der Anforderung.</span><span class="sxs-lookup"><span data-stu-id="6baa3-173">Look for credentials in the request.</span></span>
2. <span data-ttu-id="6baa3-174">Wenn keine Anmeldeinformationen vorhanden sind, werden Sie keine Aktionen ausgeführt und zurückgegeben Sie (ohne-Op).</span><span class="sxs-lookup"><span data-stu-id="6baa3-174">If there are no credentials, do nothing and return (no-op).</span></span>
3. <span data-ttu-id="6baa3-175">Wenn Anmeldeinformationen vorhanden sind, aber das Authentifizierungsschema der Filter nicht erkennt, wird nichts Unternehmen, und geben Sie (ohne-Op) zurück.</span><span class="sxs-lookup"><span data-stu-id="6baa3-175">If there are credentials but the filter does not recognize the authentication scheme, do nothing and return (no-op).</span></span> <span data-ttu-id="6baa3-176">Ein weiterer Filter in der Pipeline kann das Schema verstehen.</span><span class="sxs-lookup"><span data-stu-id="6baa3-176">Another filter in the pipeline might understand the scheme.</span></span>
4. <span data-ttu-id="6baa3-177">Wenn Anmeldeinformationen, die der Filter versteht vorhanden sind, versucht, diese zu authentifizieren.</span><span class="sxs-lookup"><span data-stu-id="6baa3-177">If there are credentials that the filter understands, try to authenticate them.</span></span>
5. <span data-ttu-id="6baa3-178">Wenn die Anmeldeinformationen gefälscht sind, durch Festlegen 401 zurückgegeben `context.ErrorResult`.</span><span class="sxs-lookup"><span data-stu-id="6baa3-178">If the credentials are bad, return 401 by setting `context.ErrorResult`.</span></span>
6. <span data-ttu-id="6baa3-179">Wenn die Anmeldeinformationen gültig sind, erstellen Sie eine **IPrincipal** und `context.Principal`.</span><span class="sxs-lookup"><span data-stu-id="6baa3-179">If the credentials are valid, create an **IPrincipal** and set `context.Principal`.</span></span>

<span data-ttu-id="6baa3-180">Der folgende Code zeigt die **AuthenticateAsync** Methode aus der [Standardauthentifizierung](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) Beispiel.</span><span class="sxs-lookup"><span data-stu-id="6baa3-180">The follow code shows the **AuthenticateAsync** method from the [Basic Authentication](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) sample.</span></span> <span data-ttu-id="6baa3-181">Jeder Schritt geben Sie die Kommentare an.</span><span class="sxs-lookup"><span data-stu-id="6baa3-181">The comments indicate each step.</span></span> <span data-ttu-id="6baa3-182">Der Code zeigt mehrere Typen von Fehler: ein Autorisierungsheader mit keine Anmeldeinformationen, die ungültige Anmeldeinformationen und die ungültige Benutzername/Kennwort.</span><span class="sxs-lookup"><span data-stu-id="6baa3-182">The code shows several types of error: An Authorization header with no credentials, malformed credentials, and bad username/password.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample5.cs)]

## <a name="setting-an-error-result"></a><span data-ttu-id="6baa3-183">Ein Fehlerergebnis festlegen</span><span class="sxs-lookup"><span data-stu-id="6baa3-183">Setting an Error Result</span></span>

<span data-ttu-id="6baa3-184">Wenn die Anmeldeinformationen ungültig sind, muss der Filter festgelegt `context.ErrorResult` auf eine **IHttpActionResult** , erstellt eine Fehlerantwort.</span><span class="sxs-lookup"><span data-stu-id="6baa3-184">If the credentials are invalid, the filter must set `context.ErrorResult` to an **IHttpActionResult** that creates an error response.</span></span> <span data-ttu-id="6baa3-185">Weitere Informationen zu **IHttpActionResult**, finden Sie unter [Aktionsergebnisse in Web-API 2](../getting-started-with-aspnet-web-api/action-results.md).</span><span class="sxs-lookup"><span data-stu-id="6baa3-185">For more information about **IHttpActionResult**, see [Action Results in Web API 2](../getting-started-with-aspnet-web-api/action-results.md).</span></span>

<span data-ttu-id="6baa3-186">Die Standardauthentifizierung-Beispiel enthält eine `AuthenticationFailureResult` -Klasse, die für diesen Zweck geeignet ist.</span><span class="sxs-lookup"><span data-stu-id="6baa3-186">The Basic Authentication sample includes an `AuthenticationFailureResult` class that is suitable for this purpose.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample6.cs)]

## <a name="implementing-challengeasync"></a><span data-ttu-id="6baa3-187">Implementieren von ChallengeAsync</span><span class="sxs-lookup"><span data-stu-id="6baa3-187">Implementing ChallengeAsync</span></span>

<span data-ttu-id="6baa3-188">Der Zweck der **ChallengeAsync** Methode ist die Antwort authentifizierungsaufforderungen hinzu, bei Bedarf.</span><span class="sxs-lookup"><span data-stu-id="6baa3-188">The purpose of the **ChallengeAsync** method is to add authentication challenges to the response, if needed.</span></span> <span data-ttu-id="6baa3-189">Hier wird die Signatur der Methode:</span><span class="sxs-lookup"><span data-stu-id="6baa3-189">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample7.cs)]

<span data-ttu-id="6baa3-190">Die Methode ist für alle Authentifizierungsfilter in der Anforderungspipeline aufgerufen.</span><span class="sxs-lookup"><span data-stu-id="6baa3-190">The method is called on every authentication filter in the request pipeline.</span></span>

<span data-ttu-id="6baa3-191">Es ist wichtig zu wissen, dass **ChallengeAsync** heißt *vor* die HTTP-Antwort wird erstellt, und möglicherweise sogar, bevor Sie die Controller-Aktion ausgeführt wird.</span><span class="sxs-lookup"><span data-stu-id="6baa3-191">It's important to understand that **ChallengeAsync** is called *before* the HTTP response is created, and possibly even before the controller action runs.</span></span> <span data-ttu-id="6baa3-192">Wenn **ChallengeAsync** aufgerufen wird, `context.Result` enthält ein **IHttpActionResult**, der später zum Erstellen der HTTP-Antwort verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="6baa3-192">When **ChallengeAsync** is called, `context.Result` contains an **IHttpActionResult**, which is used later to create the HTTP response.</span></span> <span data-ttu-id="6baa3-193">Daher **ChallengeAsync** wird aufgerufen, Sie wissen nicht, Informationen über die HTTP-Antwort noch.</span><span class="sxs-lookup"><span data-stu-id="6baa3-193">So when **ChallengeAsync** is called, you don't know anything about the HTTP response yet.</span></span> <span data-ttu-id="6baa3-194">Die **ChallengeAsync** Methode sollte ersetzt den ursprünglichen Wert des `context.Result` mit einem neuen **IHttpActionResult**.</span><span class="sxs-lookup"><span data-stu-id="6baa3-194">The **ChallengeAsync** method should replace the original value of `context.Result` with a new **IHttpActionResult**.</span></span> <span data-ttu-id="6baa3-195">Dies **IHttpActionResult** müssen die ursprüngliche umschließen `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="6baa3-195">This **IHttpActionResult** must wrap the original `context.Result`.</span></span>

![](authentication-filters/_static/image3.png)

<span data-ttu-id="6baa3-196">Die ursprüngliche rufen **IHttpActionResult** der *innere Ergebnis*, und der neuen **IHttpActionResult** der *äußeren Ergebnis*.</span><span class="sxs-lookup"><span data-stu-id="6baa3-196">I'll call the original **IHttpActionResult** the *inner result*, and the new **IHttpActionResult** the *outer result*.</span></span> <span data-ttu-id="6baa3-197">Das äußere Ergebnis muss folgende Anforderungen erfüllen:</span><span class="sxs-lookup"><span data-stu-id="6baa3-197">The outer result must do the following:</span></span>

1. <span data-ttu-id="6baa3-198">Rufen Sie die innere Ergebnis um die HTTP-Antwort zu erstellen.</span><span class="sxs-lookup"><span data-stu-id="6baa3-198">Invoke the inner result to create the HTTP response.</span></span>
2. <span data-ttu-id="6baa3-199">Überprüfen Sie die Antwort ein.</span><span class="sxs-lookup"><span data-stu-id="6baa3-199">Examine the response.</span></span>
3. <span data-ttu-id="6baa3-200">Fügen Sie bei Bedarf in die Antwort eine authentifizierungsaufforderung hinzu.</span><span class="sxs-lookup"><span data-stu-id="6baa3-200">Add an authentication challenge to the response, if needed.</span></span>

<span data-ttu-id="6baa3-201">Das folgende Beispiel stammt aus dem Beispiel die Standardauthentifizierung.</span><span class="sxs-lookup"><span data-stu-id="6baa3-201">The following example is taken from the Basic Authentication sample.</span></span> <span data-ttu-id="6baa3-202">Definiert eine **IHttpActionResult** für das äußere Ergebnis.</span><span class="sxs-lookup"><span data-stu-id="6baa3-202">It defines an **IHttpActionResult** for the outer result.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample8.cs)]

<span data-ttu-id="6baa3-203">Die `InnerResult` Eigenschaft enthält die innere **IHttpActionResult**.</span><span class="sxs-lookup"><span data-stu-id="6baa3-203">The `InnerResult` property holds the inner **IHttpActionResult**.</span></span> <span data-ttu-id="6baa3-204">Die `Challenge` Eigenschaft stellt einen Www-Authentifizierungsheader.</span><span class="sxs-lookup"><span data-stu-id="6baa3-204">The `Challenge` property represents a Www-Authentication header.</span></span> <span data-ttu-id="6baa3-205">Beachten Sie, dass **ExecuteAsync** ruft zuerst `InnerResult.ExecuteAsync` zum Erstellen der HTTP-Antwort und fügt dann die Abfrage bei Bedarf.</span><span class="sxs-lookup"><span data-stu-id="6baa3-205">Notice that **ExecuteAsync** first calls `InnerResult.ExecuteAsync` to create the HTTP response, and then adds the challenge if needed.</span></span>

<span data-ttu-id="6baa3-206">Überprüfen Sie den Antwortcode vor dem Hinzufügen der Aufforderung an.</span><span class="sxs-lookup"><span data-stu-id="6baa3-206">Check the response code before adding the challenge.</span></span> <span data-ttu-id="6baa3-207">Die meisten Authentifizierungsschemen nur hinzufügen, eine neue Herausforderung dar, wenn die Antwort 401, ist, wie hier gezeigt.</span><span class="sxs-lookup"><span data-stu-id="6baa3-207">Most authentication schemes only add a challenge if the response is 401, as shown here.</span></span> <span data-ttu-id="6baa3-208">Allerdings einige Authentifizierungsschemas eine Aufforderung eine erfolgreiche Antwort hinzufügen.</span><span class="sxs-lookup"><span data-stu-id="6baa3-208">However, some authentication schemes do add a challenge to a success response.</span></span> <span data-ttu-id="6baa3-209">Beispielsweise finden Sie unter [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span><span class="sxs-lookup"><span data-stu-id="6baa3-209">For example, see [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span></span>

<span data-ttu-id="6baa3-210">Erhält die `AddChallengeOnUnauthorizedResult` Klasse, den tatsächlichen Code in **ChallengeAsync** ist einfach.</span><span class="sxs-lookup"><span data-stu-id="6baa3-210">Given the `AddChallengeOnUnauthorizedResult` class, the actual code in **ChallengeAsync** is simple.</span></span> <span data-ttu-id="6baa3-211">Nur das Ergebnis zu erstellen und fügen Sie es auf `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="6baa3-211">You just create the result and attach it to `context.Result`.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample9.cs)]

<span data-ttu-id="6baa3-212">Hinweis: Das Beispiel die Standardauthentifizierung abstrahiert diese Logik etwas, indem Sie es auf eine Erweiterungsmethode.</span><span class="sxs-lookup"><span data-stu-id="6baa3-212">Note: The Basic Authentication sample abstracts this logic a bit, by placing it in an extension method.</span></span>

## <a name="combining-authentication-filters-with-host-level-authentication"></a><span data-ttu-id="6baa3-213">Kombinieren von Authentifizierungsfilter mit Authentifizierung auf Hostebene</span><span class="sxs-lookup"><span data-stu-id="6baa3-213">Combining Authentication Filters with Host-Level Authentication</span></span>

<span data-ttu-id="6baa3-214">"Hostebene Authentifizierung" ist die Authentifizierung, die vom Host (z. B. IIS) ausgeführt wird vor der Anforderung erreicht der Web-API-Framework.</span><span class="sxs-lookup"><span data-stu-id="6baa3-214">"Host-level authentication" is authentication performed by the host (such as IIS), before the request reaches the Web API framework.</span></span>

<span data-ttu-id="6baa3-215">Häufig, sollten Sie auf Hostebene-Authentifizierung für den Rest der Anwendung aktivieren, aber für die Web-API-Controller zu deaktivieren.</span><span class="sxs-lookup"><span data-stu-id="6baa3-215">Often, you may want to to enable host-level authentication for the rest of your application, but disable it for your Web API controllers.</span></span> <span data-ttu-id="6baa3-216">Beispielsweise ist ein typisches Szenario Formularauthentifizierung auf der Hostebene aktivieren, aber tokenbasierter Authentifizierung für die Web-API verwenden.</span><span class="sxs-lookup"><span data-stu-id="6baa3-216">For example, a typical scenario is to enable Forms Authentication at the host level, but use token-based authentication for Web API.</span></span>

<span data-ttu-id="6baa3-217">Rufen Sie zum Deaktivieren der Hostebene Authentifizierung innerhalb der Web-API-Pipeline `config.SuppressHostPrincipal()` in Ihrer Konfiguration.</span><span class="sxs-lookup"><span data-stu-id="6baa3-217">To disable host-level authentication inside the Web API pipeline, call `config.SuppressHostPrincipal()` in your configuration.</span></span> <span data-ttu-id="6baa3-218">Dies bewirkt, dass Web-API zum Entfernen der **IPrincipal** über jede Anforderung, die die Web-API-Pipeline eingibt.</span><span class="sxs-lookup"><span data-stu-id="6baa3-218">This causes Web API to remove the **IPrincipal** from any request that enters the Web API pipeline.</span></span> <span data-ttu-id="6baa3-219">Effektiv, es &quot;un-authentifiziert&quot; der Anforderung.</span><span class="sxs-lookup"><span data-stu-id="6baa3-219">Effectively, it &quot;un-authenticates&quot; the request.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample10.cs)]

## <a name="additional-resources"></a><span data-ttu-id="6baa3-220">Zusätzliche Ressourcen</span><span class="sxs-lookup"><span data-stu-id="6baa3-220">Additional Resources</span></span>

<span data-ttu-id="6baa3-221">[ASP.NET Web API-Sicherheitsfilter](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN Magazine)</span><span class="sxs-lookup"><span data-stu-id="6baa3-221">[ASP.NET Web API Security Filters](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN Magazine)</span></span>

---
title: "Schlüsselverwaltung"
author: rick-anderson
description: 
keywords: ASP.NET Core
ms.author: riande
manager: wpickett
ms.date: 10/14/2016
ms.topic: article
ms.assetid: fb9b807a-d143-4861-9ddb-005d8796afa3
ms.technology: aspnet
ms.prod: asp.net-core
uid: security/data-protection/implementation/key-management
ms.openlocfilehash: 507c00edc5bade2427151ecadfed581817e4d088
ms.sourcegitcommit: 0b6c8e6d81d2b3c161cd375036eecbace46a9707
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 08/11/2017
---
# <a name="key-management"></a><span data-ttu-id="286dd-103">Schlüsselverwaltung</span><span class="sxs-lookup"><span data-stu-id="286dd-103">Key Management</span></span>

<a name=data-protection-implementation-key-management></a>

<span data-ttu-id="286dd-104">Die Datenschutzsystem verwaltet automatisch die Lebensdauer der Master-Schlüssel zum Schützen und Aufheben des Schutzes von Nutzlasten.</span><span class="sxs-lookup"><span data-stu-id="286dd-104">The data protection system automatically manages the lifetime of master keys used to protect and unprotect payloads.</span></span> <span data-ttu-id="286dd-105">Jeder Schlüssel kann in einer der vier Phasen vorhanden sein.</span><span class="sxs-lookup"><span data-stu-id="286dd-105">Each key can exist in one of four stages.</span></span>

* <span data-ttu-id="286dd-106">Erstellt: der Schlüssel im Ring Schlüssel vorhanden ist, jedoch noch nicht aktiviert.</span><span class="sxs-lookup"><span data-stu-id="286dd-106">Created - the key exists in the key ring but has not yet been activated.</span></span> <span data-ttu-id="286dd-107">Der Schlüssel darf nicht für neue Protect-Vorgänge verwendet werden, bis ausreichend Zeit verstrichen ist, dass der Schlüssel wurde eine Möglichkeit, auf alle Computer weitergegeben werden, die diesen Schlüssel Ring in Anspruch genommen.</span><span class="sxs-lookup"><span data-stu-id="286dd-107">The key shouldn't be used for new Protect operations until sufficient time has elapsed that the key has had a chance to propagate to all machines that are consuming this key ring.</span></span>

* <span data-ttu-id="286dd-108">Aktiv – der Schlüssel im Ring Schlüssel vorhanden ist und für alle neuen Protect-Vorgänge verwendet werden soll.</span><span class="sxs-lookup"><span data-stu-id="286dd-108">Active - the key exists in the key ring and should be used for all new Protect operations.</span></span>

* <span data-ttu-id="286dd-109">Abgelaufen - der Schlüssel Lebensdauer natürliche ausgeführt wurde und nicht mehr für neue Protect-Vorgänge verwendet werden soll.</span><span class="sxs-lookup"><span data-stu-id="286dd-109">Expired - the key has run its natural lifetime and should no longer be used for new Protect operations.</span></span>

* <span data-ttu-id="286dd-110">Widerrufen - der Schlüssel gefährdet sein und dürfen nicht für neue Protect-Vorgänge verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="286dd-110">Revoked - the key is compromised and must not be used for new Protect operations.</span></span>

<span data-ttu-id="286dd-111">Erstellte, aktiven und abgelaufene Schlüssel möglicherweise alle zum Aufheben des Schutzes von eingehenden Nutzlasten verwendet.</span><span class="sxs-lookup"><span data-stu-id="286dd-111">Created, active, and expired keys may all be used to unprotect incoming payloads.</span></span> <span data-ttu-id="286dd-112">Gesperrte Schlüssel standardmäßig dürfen nicht zum Aufheben des Schutzes von Nutzlasten verwendet werden, aber der Anwendungsentwickler kann [dieses Verhalten überschreiben](../consumer-apis/dangerous-unprotect.md#data-protection-consumer-apis-dangerous-unprotect) bei Bedarf.</span><span class="sxs-lookup"><span data-stu-id="286dd-112">Revoked keys by default may not be used to unprotect payloads, but the application developer can [override this behavior](../consumer-apis/dangerous-unprotect.md#data-protection-consumer-apis-dangerous-unprotect) if necessary.</span></span>

>[!WARNING]
> <span data-ttu-id="286dd-113">Der Entwickler möglicherweise versucht, einen Schlüssel aus dem Schlüssel Ring zu löschen, (z. B. durch die entsprechende Datei aus dem Dateisystem gelöscht).</span><span class="sxs-lookup"><span data-stu-id="286dd-113">The developer might be tempted to delete a key from the key ring (e.g., by deleting the corresponding file from the file system).</span></span> <span data-ttu-id="286dd-114">An diesem Punkt alle Daten, die durch den Schlüssel geschützt wird dauerhaft, und es gibt keine Notfall Überschreibung mit gesperrten Schlüssel vorhanden ist.</span><span class="sxs-lookup"><span data-stu-id="286dd-114">At that point, all data protected by the key is permanently undecipherable, and there is no emergency override like there is with revoked keys.</span></span> <span data-ttu-id="286dd-115">Löschen einen Schlüssel wirklich destruktiven Verhalten ist und daher macht die Datenschutzsystem keine erstrangige-API zum Ausführen des Vorgangs.</span><span class="sxs-lookup"><span data-stu-id="286dd-115">Deleting a key is truly destructive behavior, and consequently the data protection system exposes no first-class API for performing this operation.</span></span>

## <a name="default-key-selection"></a><span data-ttu-id="286dd-116">Wichtige Standardauswahl</span><span class="sxs-lookup"><span data-stu-id="286dd-116">Default key selection</span></span>

<span data-ttu-id="286dd-117">Wenn die Datenschutzsystem des Rings Schlüssel aus dem Repository dahinter liegende liest, wird versucht, einen Schlüssel "Default" aus dem Schlüssel Ring zu suchen.</span><span class="sxs-lookup"><span data-stu-id="286dd-117">When the data protection system reads the key ring from the backing repository, it will attempt to locate a "default" key from the key ring.</span></span> <span data-ttu-id="286dd-118">Der Standardschlüssel wird für neue Protect-Vorgänge verwendet.</span><span class="sxs-lookup"><span data-stu-id="286dd-118">The default key is used for new Protect operations.</span></span>

<span data-ttu-id="286dd-119">Die allgemeine Heuristik ist, dass die Datenschutzsystem die Taste mit dem letzten Aktivierungsdatum als den Standardschlüssel auswählt.</span><span class="sxs-lookup"><span data-stu-id="286dd-119">The general heuristic is that the data protection system chooses the key with the most recent activation date as the default key.</span></span> <span data-ttu-id="286dd-120">(Es ist eine kleine Mogelfaktor um Server Serveruhr Zeitversatz zu ermöglichen.) Wenn der Schlüssel ist abgelaufen oder gesperrt, und wenn die Anwendung nicht automatisch deaktiviert wurden generieren Schlüssel und dann ein neuer Schlüssel mit sofortigem Aktivierung pro generiert werden die [Schlüssel Ablauf- und parallelen](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) Richtlinie weiter unten.</span><span class="sxs-lookup"><span data-stu-id="286dd-120">(There's a small fudge factor to allow for server-to-server clock skew.) If the key is expired or revoked, and if the application has not disabled automatic key generation, then a new key will be generated with immediate activation per the [key expiration and rolling](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) policy below.</span></span>

<span data-ttu-id="286dd-121">Der Grund der Datenschutzsystem generiert einen neuen Schlüssel sofort anstatt Fallback auf einen anderen Schlüssel besteht darin, dass neue schlüsselgenerierung als eine implizite Ablaufzeit aller Schlüssel behandelt werden sollen, die vor der neue Schlüssel aktiviert wurden.</span><span class="sxs-lookup"><span data-stu-id="286dd-121">The reason the data protection system generates a new key immediately rather than falling back to a different key is that new key generation should be treated as an implicit expiration of all keys that were activated prior to the new key.</span></span> <span data-ttu-id="286dd-122">Die Idee ist, dass neue Schlüssel mit verschiedenen Algorithmen oder Verschlüsselung ruhender Mechanismen als die alten Schlüssel konfiguriert wurden können, und das System sollte vorziehen, dass die aktuelle Konfiguration zurückgreifen.</span><span class="sxs-lookup"><span data-stu-id="286dd-122">The general idea is that new keys may have been configured with different algorithms or encryption-at-rest mechanisms than old keys, and the system should prefer the current configuration over falling back.</span></span>

<span data-ttu-id="286dd-123">Eine Ausnahme ist aufgetreten.</span><span class="sxs-lookup"><span data-stu-id="286dd-123">There is an exception.</span></span> <span data-ttu-id="286dd-124">Verfügt der Anwendungsentwickler [deaktiviert die automatische Generierung](../configuration/overview.md#data-protection-configuring-disable-automatic-key-generation), und klicken Sie dann die Datenschutzsystem etwas als den standardmäßigen Schlüssel auswählen muss.</span><span class="sxs-lookup"><span data-stu-id="286dd-124">If the application developer has [disabled automatic key generation](../configuration/overview.md#data-protection-configuring-disable-automatic-key-generation), then the data protection system must choose something as the default key.</span></span> <span data-ttu-id="286dd-125">In diesem Szenario fallback werden das System, wählen Sie den Schlüssel nicht widerrufen, mit dem letzten Aktivierungsdatum eingeräumt an Schlüsseln, die Zeit an andere Computer im Cluster weitergegeben wurden.</span><span class="sxs-lookup"><span data-stu-id="286dd-125">In this fallback scenario, the system will choose the non-revoked key with the most recent activation date, with preference given to keys that have had time to propagate to other machines in the cluster.</span></span> <span data-ttu-id="286dd-126">Die Fallbacksystem annehmen kann eine abgelaufene Standardschlüssel daher auswählen.</span><span class="sxs-lookup"><span data-stu-id="286dd-126">The fallback system may end up choosing an expired default key as a result.</span></span> <span data-ttu-id="286dd-127">Die Fallbacksystem wird nie einen gesperrten Schlüssel als den standardmäßigen Schlüssel auswählen und wenn der Schlüssel Ring leer ist oder jeden Schlüssel wurde gesperrt klicken Sie dann das System erzeugt einen Fehler bei der Initialisierung.</span><span class="sxs-lookup"><span data-stu-id="286dd-127">The fallback system will never choose a revoked key as the default key, and if the key ring is empty or every key has been revoked then the system will produce an error upon initialization.</span></span>

<a name=data-protection-implementation-key-management-expiration></a>

## <a name="key-expiration-and-rolling"></a><span data-ttu-id="286dd-128">Schlüsselablauf und Rollen</span><span class="sxs-lookup"><span data-stu-id="286dd-128">Key expiration and rolling</span></span>

<span data-ttu-id="286dd-129">Wenn ein Schlüssel erstellt wird, erhält er automatisch ein Datum der Aktivierung von {Now + 2 Tage} und {Now + 90 Tage} Ablaufdatum.</span><span class="sxs-lookup"><span data-stu-id="286dd-129">When a key is created, it is automatically given an activation date of { now + 2 days } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="286dd-130">Die Verzögerung 2 Tagen vor der Aktivierung erhalten die Schlüsselzeit durch das System weitergegeben.</span><span class="sxs-lookup"><span data-stu-id="286dd-130">The 2-day delay before activation gives the key time to propagate through the system.</span></span> <span data-ttu-id="286dd-131">Somit ermöglicht es anderen Anwendungen, die auf den in den Sicherungsspeicher beobachten den Schlüssel bei ihrer nächsten Zeitraum für die automatische Aktualisierung daher maximieren die Gefahr, dass bei der Schlüssel ring geworden ist aktiv, die es verteilt wurde für alle Anwendungen, die möglicherweise zum müssen diese verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="286dd-131">That is, it allows other applications pointing at the backing store to observe the key at their next auto-refresh period, thus maximizing the chances that when the key ring does become active it has propagated to all applications that might need to use it.</span></span>

<span data-ttu-id="286dd-132">Wenn die Standardschlüssel innerhalb von 2 Tagen abläuft und der Schlüssel Ring nicht bereits einen Schlüssel aufweist, der nach Ablauf der Standardschlüssel aktiv sind, bleiben die Datenschutzsystem automatisch einen neuen Schlüssel für den Schlüssel Ring.</span><span class="sxs-lookup"><span data-stu-id="286dd-132">If the default key will expire within 2 days and if the key ring does not already have a key that will be active upon expiration of the default key, then the data protection system will automatically persist a new key to the key ring.</span></span> <span data-ttu-id="286dd-133">Dieses neuen Schlüssels verfügt über ein Datum der Aktivierung von {Ablaufdatum des Standardschlüssel} und {Now + 90 Tage} Ablaufdatum.</span><span class="sxs-lookup"><span data-stu-id="286dd-133">This new key has an activation date of { default key's expiration date } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="286dd-134">Dadurch wird das System die Schlüssel automatisch in regelmäßigen Abständen ohne Unterbrechung des Diensts zurückzusetzen.</span><span class="sxs-lookup"><span data-stu-id="286dd-134">This allows the system to automatically roll keys on a regular basis with no interruption of service.</span></span>

<span data-ttu-id="286dd-135">Es gibt möglicherweise Situationen, in denen ein Schlüssel mit sofortige Aktivierung erstellt wird.</span><span class="sxs-lookup"><span data-stu-id="286dd-135">There might be circumstances where a key will be created with immediate activation.</span></span> <span data-ttu-id="286dd-136">Ein Beispiel wäre, wenn die Anwendung noch nicht für eine Zeit ausgeführt und sämtliche Schlüssel in den Schlüssel Ring ist abgelaufen.</span><span class="sxs-lookup"><span data-stu-id="286dd-136">One example would be when the application hasn't run for a time and all keys in the key ring are expired.</span></span> <span data-ttu-id="286dd-137">In diesem Fall wird der Schlüssel ein Datum der Aktivierung von {jetzt} ohne die normalen aktivierungsverzögerung von 2 Tagen angegeben.</span><span class="sxs-lookup"><span data-stu-id="286dd-137">When this happens, the key is given an activation date of { now } without the normal 2-day activation delay.</span></span>

<span data-ttu-id="286dd-138">Die wichtigsten Standardlebensdauer ist 90 Tage, obwohl dies konfigurierbar, wie im folgenden Beispiel ist.</span><span class="sxs-lookup"><span data-stu-id="286dd-138">The default key lifetime is 90 days, though this is configurable as in the following example.</span></span>

```csharp
services.AddDataProtection()
       // use 14-day lifetime instead of 90-day lifetime
       .SetDefaultKeyLifetime(TimeSpan.FromDays(14));
   ```

<span data-ttu-id="286dd-139">Ein Administrator kann auch die systemweite Standardeinstellung ändern, wenn ein expliziter Aufruf von SetDefaultKeyLifetime systemweite Richtlinie außer Kraft setzt.</span><span class="sxs-lookup"><span data-stu-id="286dd-139">An administrator can also change the default system-wide, though an explicit call to SetDefaultKeyLifetime will override any system-wide policy.</span></span> <span data-ttu-id="286dd-140">Die Standardlebensdauer für den Schlüssel darf nicht kürzer als 7 Tage sein.</span><span class="sxs-lookup"><span data-stu-id="286dd-140">The default key lifetime cannot be shorter than 7 days.</span></span>

## <a name="automatic-keyring-refresh"></a><span data-ttu-id="286dd-141">Automatische Schlüsselsammlung aktualisieren</span><span class="sxs-lookup"><span data-stu-id="286dd-141">Automatic keyring refresh</span></span>

<span data-ttu-id="286dd-142">Wenn die Datenschutzsystem initialisiert wird, liest der Ring Schlüssel aus dem zugrunde liegenden Repository und im Arbeitsspeicher zwischengespeichert.</span><span class="sxs-lookup"><span data-stu-id="286dd-142">When the data protection system initializes, it reads the key ring from the underlying repository and caches it in memory.</span></span> <span data-ttu-id="286dd-143">Dieser Cache ermöglicht das schützen und Unprotect-Vorgängen um den Vorgang fortzusetzen, ohne dafür das Sicherungsspeicher.</span><span class="sxs-lookup"><span data-stu-id="286dd-143">This cache allows Protect and Unprotect operations to proceed without hitting the backing store.</span></span> <span data-ttu-id="286dd-144">Vom System wird den Sicherungsspeicher für Änderungen automatisch geprüft, ungefähr alle 24 Stunden oder wenn der aktuelle Standardschlüssel abläuft, je nachdem, was zuerst eintritt.</span><span class="sxs-lookup"><span data-stu-id="286dd-144">The system will automatically check the backing store for changes approximately every 24 hours or when the current default key expires, whichever comes first.</span></span>

>[!WARNING]
> <span data-ttu-id="286dd-145">Entwickler sollten nur sehr selten (wenn überhaupt) müssen die Schlüssel-APIs direkt verwenden.</span><span class="sxs-lookup"><span data-stu-id="286dd-145">Developers should very rarely (if ever) need to use the key management APIs directly.</span></span> <span data-ttu-id="286dd-146">Die Datenschutzsystem führt automatischen schlüsselverwaltung, wie oben beschrieben.</span><span class="sxs-lookup"><span data-stu-id="286dd-146">The data protection system will perform automatic key management as described above.</span></span>

<span data-ttu-id="286dd-147">Die Datenschutzsystem stellt eine Schnittstelle, die verwendet werden kann, um zu überprüfen, und nehmen Sie Änderungen an der Schlüssel Ring IKeyManager.</span><span class="sxs-lookup"><span data-stu-id="286dd-147">The data protection system exposes an interface IKeyManager that can be used to inspect and make changes to the key ring.</span></span> <span data-ttu-id="286dd-148">Das DI-System, das die Instanz IDataProtectionProvider bereitgestellt kann auch eine Instanz des IKeyManager für Ihre Nutzung bereitstellen.</span><span class="sxs-lookup"><span data-stu-id="286dd-148">The DI system that provided the instance of IDataProtectionProvider can also provide an instance of IKeyManager for your consumption.</span></span> <span data-ttu-id="286dd-149">Alternativ können Sie die IKeyManager gerade aus der IServiceProvider wie im folgenden Beispiel per Pull beziehen.</span><span class="sxs-lookup"><span data-stu-id="286dd-149">Alternatively, you can pull the IKeyManager straight from the IServiceProvider as in the example below.</span></span>

<span data-ttu-id="286dd-150">Jeder Vorgang, der bestimmt, der Schlüssel Ring (einen neuen Schlüssel explizit erstellen oder Ausführen einer Sperrung) wird der in-Memory-Cache ungültig.</span><span class="sxs-lookup"><span data-stu-id="286dd-150">Any operation which modifies the key ring (creating a new key explicitly or performing a revocation) will invalidate the in-memory cache.</span></span> <span data-ttu-id="286dd-151">Beim nächste Aufruf von Protect oder Unprotect bewirkt, dass die Datenschutzsystem liest die Schlüsselbund und erneut erstellen des Caches.</span><span class="sxs-lookup"><span data-stu-id="286dd-151">The next call to Protect or Unprotect will cause the data protection system to reread the key ring and recreate the cache.</span></span>

<span data-ttu-id="286dd-152">Im Beispiel unten zeigt mithilfe der IKeyManager-Benutzeroberfläche der Schlüssel Ring, einschließlich entziehen vorhandenen Schlüssel und generieren manuell einen neuen Schlüssel zu überprüfen.</span><span class="sxs-lookup"><span data-stu-id="286dd-152">The sample below demonstrates using the IKeyManager interface to inspect and manipulate the key ring, including revoking existing keys and generating a new key manually.</span></span>

<span data-ttu-id="286dd-153">[!code-none[Main](key-management/samples/key-management.cs)]</span><span class="sxs-lookup"><span data-stu-id="286dd-153">[!code-none[Main](key-management/samples/key-management.cs)]</span></span>

## <a name="key-storage"></a><span data-ttu-id="286dd-154">Schlüsselspeicher</span><span class="sxs-lookup"><span data-stu-id="286dd-154">Key storage</span></span>

<span data-ttu-id="286dd-155">Die Datenschutzsystem hat eine heuristische, bei dem Versuch, einen geeigneten Schlüssel Speicherort und die Verschlüsselung auf Rest-Mechanismus automatisch hergeleitet werden.</span><span class="sxs-lookup"><span data-stu-id="286dd-155">The data protection system has a heuristic whereby it tries to deduce an appropriate key storage location and encryption at rest mechanism automatically.</span></span> <span data-ttu-id="286dd-156">Dies kann auch durch den app-Entwickler.</span><span class="sxs-lookup"><span data-stu-id="286dd-156">This is also configurable by the app developer.</span></span> <span data-ttu-id="286dd-157">In den folgenden Dokumenten erläutert die integrierten Implementierungen der folgenden Mechanismen:</span><span class="sxs-lookup"><span data-stu-id="286dd-157">The following documents discuss the in-box implementations of these mechanisms:</span></span>

* [<span data-ttu-id="286dd-158">In-Box-Schlüsselspeicher-Anbieter</span><span class="sxs-lookup"><span data-stu-id="286dd-158">In-box key storage providers</span></span>](key-storage-providers.md#data-protection-implementation-key-storage-providers)

* [<span data-ttu-id="286dd-159">Integrierte Schlüsselverschlüsselung zur Rest-Anbieter</span><span class="sxs-lookup"><span data-stu-id="286dd-159">In-box key encryption at rest providers</span></span>](key-encryption-at-rest.md#data-protection-implementation-key-encryption-at-rest-providers)

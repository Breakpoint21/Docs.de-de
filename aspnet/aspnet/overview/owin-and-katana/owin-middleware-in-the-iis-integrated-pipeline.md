---
uid: aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
title: OWIN-Middleware in der IIS-integrierten Pipeline | Microsoft Docs
author: Praburaj
description: "Dieser Artikel zeigt, wie zum Ausführen von owin-Middleware-Komponenten (OMCs) in der integrierten IIS-Pipeline und zum Festlegen von der Pipeline-Ereignis ein OMC auf ausgeführt. Sie sollten..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 11/07/2013
ms.topic: article
ms.assetid: d031c021-33c2-45a5-bf9f-98f8fa78c2ab
ms.technology: 
ms.prod: .net-framework
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
msc.type: authoredcontent
ms.openlocfilehash: 4e1270f9fb58032d22380117f4ec18b00bd725fc
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 01/24/2018
---
<a name="owin-middleware-in-the-iis-integrated-pipeline"></a><span data-ttu-id="b6373-104">OWIN-Middleware in der integrierten IIS-pipeline</span><span class="sxs-lookup"><span data-stu-id="b6373-104">OWIN Middleware in the IIS integrated pipeline</span></span>
====================
<span data-ttu-id="b6373-105">durch [Praburaj Thiagarajan](https://github.com/Praburaj), [Rick Anderson](https://github.com/Rick-Anderson)</span><span class="sxs-lookup"><span data-stu-id="b6373-105">by [Praburaj Thiagarajan](https://github.com/Praburaj), [Rick Anderson](https://github.com/Rick-Anderson)</span></span>

> <span data-ttu-id="b6373-106">Dieser Artikel zeigt, wie zum Ausführen von owin-Middleware-Komponenten (OMCs) in der integrierten IIS-Pipeline und zum Festlegen von der Pipeline-Ereignis ein OMC auf ausgeführt.</span><span class="sxs-lookup"><span data-stu-id="b6373-106">This article shows how to run OWIN middleware Components (OMCs) in the IIS integrated pipeline, and how to set the pipeline event an OMC runs on.</span></span> <span data-ttu-id="b6373-107">Lesen Sie [eine Übersicht über Project Katana](an-overview-of-project-katana.md) und [OWIN Start Klasse Erkennung](owin-startup-class-detection.md) vor dem Lesen dieses Lernprogramms.</span><span class="sxs-lookup"><span data-stu-id="b6373-107">You should review [An Overview of Project Katana](an-overview-of-project-katana.md) and [OWIN Startup Class Detection](owin-startup-class-detection.md) before reading this tutorial.</span></span> <span data-ttu-id="b6373-108">Dieses Lernprogramm wurde von Rick Anderson geschrieben ( [ @RickAndMSFT ](https://twitter.com/#!/RickAndMSFT) ), Chris Ross Praburaj Thiagarajan und Howard Dierking ( [ @howard \_Dierking](https://twitter.com/howard_dierking) ).</span><span class="sxs-lookup"><span data-stu-id="b6373-108">This tutorial was written by Rick Anderson ( [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT) ), Chris Ross, Praburaj Thiagarajan, and Howard Dierking ( [@howard\_dierking](https://twitter.com/howard_dierking) ).</span></span>


<span data-ttu-id="b6373-109">Obwohl [OWIN](an-overview-of-project-katana.md) Middleware-Komponenten (OMCs) dienen in erster Linie in einer Pipeline Unabhängigkeit von der Server ausgeführt, es ist möglich, eine OMC in der integrierten IIS-Pipeline ebenfalls ausgeführt (**im klassischer Modus ist *nicht* unterstützt**).</span><span class="sxs-lookup"><span data-stu-id="b6373-109">Although [OWIN](an-overview-of-project-katana.md) middleware components (OMCs) are primarily designed to run in a server-agnostic pipeline, it is possible to run an OMC in the IIS integrated pipeline as well (**classic mode is *not* supported**).</span></span> <span data-ttu-id="b6373-110">Ein OMC kann vorgenommen werden, in der integrierten IIS-Pipeline verwendet, installieren Sie das folgende Paket aus der Paket-Manager-Konsole (PMC):</span><span class="sxs-lookup"><span data-stu-id="b6373-110">An OMC can be made to work in the IIS integrated pipeline by installing the following package from the Package Manager Console (PMC):</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample1.cmd)]

<span data-ttu-id="b6373-111">Dies bedeutet, dass alle Anwendungsframeworks, auch solche, die noch nicht außerhalb von IIS und System.Web, ausgeführt werden, die von vorhandenen owin-Middleware Komponenten profitieren können.</span><span class="sxs-lookup"><span data-stu-id="b6373-111">This means that all application frameworks, even those that are not yet able to run outside of IIS and System.Web, can benefit from existing OWIN middleware components.</span></span> 

> [!NOTE]
> <span data-ttu-id="b6373-112">Alle von der `Microsoft.Owin.Security.*` Pakete Auslieferung mit der neuen Identitätssystem in Visual Studio 2013 (z. B.: Cookies, Microsoft Account, Google, Facebook, Twitter, [Trägertoken](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html), OAuth, autorisierungsserver, JWT, Azure Active Directory und Active Directory-Verbunddienste) als OMCs erstellt wurden, und in selbst gehostet und IIS-gehosteten Szenarien verwendet werden können.</span><span class="sxs-lookup"><span data-stu-id="b6373-112">All of the `Microsoft.Owin.Security.*` packages shipping with the new Identity System in Visual Studio 2013 (for example: Cookies, Microsoft Account, Google, Facebook, Twitter, [Bearer Token](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html), OAuth, Authorization server, JWT, Azure Active directory, and Active directory federation services) are authored as OMCs, and can be used in both self-hosted and IIS-hosted scenarios.</span></span>

## <a name="how-owin-middleware-executes-in-the-iis-integrated-pipeline"></a><span data-ttu-id="b6373-113">Wie der OWIN-Middleware in der integrierten IIS-Pipeline ausgeführt wird</span><span class="sxs-lookup"><span data-stu-id="b6373-113">How OWIN Middleware Executes in the IIS Integrated Pipeline</span></span>

<span data-ttu-id="b6373-114">Für die OWIN-konsolenanwendungen, mit der Pipeline der Anwendung erstellt die [Startkonfiguration](owin-startup-class-detection.md) wird festgelegt, indem die Reihenfolge der Komponenten hinzugefügt werden, mit der `IAppBuilder.Use` Methode.</span><span class="sxs-lookup"><span data-stu-id="b6373-114">For OWIN console applications, the application pipeline built using the [startup configuration](owin-startup-class-detection.md) is set by the order the components are added using the `IAppBuilder.Use` method.</span></span> <span data-ttu-id="b6373-115">D. h. die OWIN-Pipeline in der [Katana](an-overview-of-project-katana.md) Laufzeit verarbeitet OMCs in der Reihenfolge, die sie registriert wurden, mithilfe von `IAppBuilder.Use`.</span><span class="sxs-lookup"><span data-stu-id="b6373-115">That is, the OWIN pipeline in the [Katana](an-overview-of-project-katana.md) runtime will process OMCs in the order they were registered using `IAppBuilder.Use`.</span></span> <span data-ttu-id="b6373-116">In der integrierten IIS-Pipeline besteht die Anforderungspipeline [HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx) wie z. B. auf einen vordefinierten Satz von der Pipelineereignisse abonniert [BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx), [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx)usw.</span><span class="sxs-lookup"><span data-stu-id="b6373-116">In the IIS integrated pipeline the request pipeline consists of [HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx) subscribed to a pre-defined set of the pipeline events such as [BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx), [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx), etc.</span></span>

<span data-ttu-id="b6373-117">Wenn wir eine OMC mit Vergleichen einer [HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx) in der Welt ASP.NET muss ein OMC an das richtige vordefinierten Pipeline-Ereignis registriert werden.</span><span class="sxs-lookup"><span data-stu-id="b6373-117">If we compare an OMC to that of an [HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx) in the ASP.NET world, an OMC must be registered to the correct pre-defined pipeline event.</span></span> <span data-ttu-id="b6373-118">Beispielsweise HttpModule `MyModule` wird abrufen aufgerufen, wenn eine Anforderung, um eingeht die [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) Stufe der Pipeline:</span><span class="sxs-lookup"><span data-stu-id="b6373-118">For example, the HttpModule `MyModule` will get invoked when a request comes to the [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) stage in the pipeline:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample2.cs?highlight=10)]

<span data-ttu-id="b6373-119">In der Reihenfolge für eine OMC zur Teilnahme an dieser Anordnung derselben, das eine ereignisbasierte Ausführung der [Katana](an-overview-of-project-katana.md) Laufzeitcode eingeschränkten Bereichsscans mithilfe von der [Startkonfiguration](owin-startup-class-detection.md) und abonniert die Middleware-Komponenten auf eine Ereignis der integrierten Pipeline.</span><span class="sxs-lookup"><span data-stu-id="b6373-119">In order for an OMC to participate in this same, event-based execution ordering, the [Katana](an-overview-of-project-katana.md) runtime code scans through the [startup configuration](owin-startup-class-detection.md) and subscribes each of the middleware components to an integrated pipeline event.</span></span> <span data-ttu-id="b6373-120">Beispielsweise können mit der folgende Code der OMC und Registrierung für die Standard-ereignisregistrierung, Middleware-Komponenten finden Sie unter.</span><span class="sxs-lookup"><span data-stu-id="b6373-120">For example, the following OMC and registration code enables you to see the default event registration of middleware components.</span></span> <span data-ttu-id="b6373-121">(Ausführlichere Informationen zum Erstellen einer OWIN-Startklasse finden Sie unter [OWIN Start Klasse Erkennung](owin-startup-class-detection.md).)</span><span class="sxs-lookup"><span data-stu-id="b6373-121">(For more detailed instructions on creating an OWIN startup class, see [OWIN Startup Class Detection](owin-startup-class-detection.md).)</span></span>

1. <span data-ttu-id="b6373-122">Erstellen Sie ein leere Webanwendungsprojekt, und nennen Sie sie **owin2**.</span><span class="sxs-lookup"><span data-stu-id="b6373-122">Create an empty web application project and name it **owin2**.</span></span>
2. <span data-ttu-id="b6373-123">Führen Sie aus der Paket-Manager-Konsole (PMC) den folgenden Befehl:</span><span class="sxs-lookup"><span data-stu-id="b6373-123">From the Package Manager Console (PMC), run the following command:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample3.cmd)]
3. <span data-ttu-id="b6373-124">Hinzufügen einer `OWIN Startup Class` und nennen Sie sie `Startup`.</span><span class="sxs-lookup"><span data-stu-id="b6373-124">Add an `OWIN Startup Class` and name it `Startup`.</span></span> <span data-ttu-id="b6373-125">Ersetzen Sie den generierten Code mit den folgenden (die Änderungen werden hervorgehoben):</span><span class="sxs-lookup"><span data-stu-id="b6373-125">Replace the generated code with the following (the changes are highlighted):</span></span>  

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample4.cs?highlight=5-7,15-36)]
4. <span data-ttu-id="b6373-126">Drücken Sie F5, um die app auszuführen.</span><span class="sxs-lookup"><span data-stu-id="b6373-126">Hit F5 to run the app.</span></span>

<span data-ttu-id="b6373-127">Die Konfiguration für den Dienststart richtet eine Pipeline mit drei middlewarekomponenten gemeinsam sind, die ersten beiden zum Anzeigen von Diagnoseinformationen und zum letzten Blatt reagieren auf Ereignisse (und auch anzeigen von Diagnoseinformationen).</span><span class="sxs-lookup"><span data-stu-id="b6373-127">The Startup configuration sets up a pipeline with three middleware components, the first two displaying diagnostic information and the last one responding to events (and also displaying diagnostic information).</span></span> <span data-ttu-id="b6373-128">Die `PrintCurrentIntegratedPipelineStage` -Methode der integrierten Pipeline-Ereignis für diese Middleware aufgerufen wird und eine Meldung angezeigt.</span><span class="sxs-lookup"><span data-stu-id="b6373-128">The `PrintCurrentIntegratedPipelineStage` method displays the integrated pipeline event this middleware is invoked on and a message.</span></span> <span data-ttu-id="b6373-129">Das Ausgabefenster zeigt Folgendes an:</span><span class="sxs-lookup"><span data-stu-id="b6373-129">The output windows displays the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample5.cmd)]

<span data-ttu-id="b6373-130">Die Katana-Laufzeit zugeordnet aller der OWIN-Middleware zu Komponenten [PreExecuteRequestHandler](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx) standardmäßig entspricht der IIS-Ereignis-Pipeline [PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx).</span><span class="sxs-lookup"><span data-stu-id="b6373-130">The Katana runtime mapped each of the OWIN middleware components to [PreExecuteRequestHandler](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx) by default, which corresponds to the IIS pipeline event [PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx).</span></span>

## <a name="stage-markers"></a><span data-ttu-id="b6373-131">Phase-Marker</span><span class="sxs-lookup"><span data-stu-id="b6373-131">Stage Markers</span></span>

<span data-ttu-id="b6373-132">Können Sie kennzeichnen, OMCs auszuführende in bestimmten Phasen der Pipeline mithilfe der `IAppBuilder UseStageMarker()` -Erweiterungsmethode.</span><span class="sxs-lookup"><span data-stu-id="b6373-132">You can mark OMCs to execute at specific stages of the pipeline by using the `IAppBuilder UseStageMarker()` extension method.</span></span> <span data-ttu-id="b6373-133">Um eine Reihe von Komponenten der Middleware während einer bestimmten Stufe ausgeführt wurde, fügen eine phasenmarkierung direkt nach der letzten Komponente ist ein Satz während der Registrierung.</span><span class="sxs-lookup"><span data-stu-id="b6373-133">To run a set of middleware components during a particular stage, insert a stage marker right after the last component is the set during registration.</span></span> <span data-ttu-id="b6373-134">Es sind Regeln, in welcher Phase der Pipeline können Sie die Middleware ausführen, und die Order-Komponenten ausgeführt werden müssen (später in diesem Lernprogramm werden die Regeln erläutert).</span><span class="sxs-lookup"><span data-stu-id="b6373-134">There are rules on which stage of the pipeline you can execute middleware and the order components must run (The rules are explained later in the tutorial).</span></span> <span data-ttu-id="b6373-135">Hinzufügen der `UseStageMarker` Methode, um die `Configuration` code wie unten dargestellt:</span><span class="sxs-lookup"><span data-stu-id="b6373-135">Add the `UseStageMarker` method to the `Configuration` code as shown below:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample6.cs?highlight=13,19)]

<span data-ttu-id="b6373-136">Die `app.UseStageMarker(PipelineStage.Authenticate)` Aufruf so konfiguriert, dass alle zuvor registrierten Middleware-Komponenten (in diesem Fall unsere zwei diagnostischen Komponenten) auf die Authentifizierungsphase der Pipeline ausgeführt werden.</span><span class="sxs-lookup"><span data-stu-id="b6373-136">The `app.UseStageMarker(PipelineStage.Authenticate)` call configures all the previously registered middleware components (in this case, our two diagnostic components) to run on the authentication stage of the pipeline.</span></span> <span data-ttu-id="b6373-137">Die letzte middlewarekomponente (der Diagnose angezeigt und auf Anforderungen antwortet) wird ausgeführt, auf die `ResolveCache` Stufe (der [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx) Ereignis).</span><span class="sxs-lookup"><span data-stu-id="b6373-137">The last middleware component (which displays diagnostics and responds to requests) will run on the `ResolveCache` stage (the [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx) event).</span></span>

<span data-ttu-id="b6373-138">Drücken Sie F5, um die app auszuführen. Das Fenster "Ausgabe" zeigt Folgendes:</span><span class="sxs-lookup"><span data-stu-id="b6373-138">Hit F5 to run the app.The output window shows the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample7.cmd)]

## <a name="stage-marker-rules"></a><span data-ttu-id="b6373-139">Phase Marker Regeln</span><span class="sxs-lookup"><span data-stu-id="b6373-139">Stage Marker Rules</span></span>

<span data-ttu-id="b6373-140">Owin-Middleware-Komponenten (OMC) können zum Ausführen von auf owin-Pipeline-Phase Folgendes konfiguriert werden:</span><span class="sxs-lookup"><span data-stu-id="b6373-140">Owin middleware components (OMC) can be configured to run at the following OWIN pipeline stage events:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample8.cs)]

1. <span data-ttu-id="b6373-141">Standardmäßig OMCs, führen Sie an das letzte Ereignis (`PreHandlerExecute`).</span><span class="sxs-lookup"><span data-stu-id="b6373-141">By default, OMCs run at the last event (`PreHandlerExecute`).</span></span> <span data-ttu-id="b6373-142">Deshalb ist unsere erste Beispielcode angezeigt "PreExecuteRequestHandler".</span><span class="sxs-lookup"><span data-stu-id="b6373-142">That's why our first example code displayed "PreExecuteRequestHandler".</span></span>
2. <span data-ttu-id="b6373-143">Können Sie die einer `pp.UseStageMarker` Methode, um eine OMC früher in keiner Phase der OWIN-Pipeline ausgeführt registrieren aufgeführt, der `PipelineStage` Enum.</span><span class="sxs-lookup"><span data-stu-id="b6373-143">You can use the a `pp.UseStageMarker` method to register a OMC to run earlier, at any stage of the OWIN pipeline listed in the `PipelineStage` enum.</span></span>
3. <span data-ttu-id="b6373-144">Die OWIN-Pipeline und die IIS-Pipeline ist sortiert, daher Aufrufe `app.UseStageMarker` muss in der Reihenfolge.</span><span class="sxs-lookup"><span data-stu-id="b6373-144">The OWIN pipeline and the IIS pipeline is ordered, therefore calls to `app.UseStageMarker` must be in order.</span></span> <span data-ttu-id="b6373-145">Den Ereignishandler kann nicht festgelegt werden, um ein Ereignis, das vor dem letzten Ereignis registriert mit `app.UseStageMarker`.</span><span class="sxs-lookup"><span data-stu-id="b6373-145">You cannot set the event handler to an event that precedes the last event registered with to `app.UseStageMarker`.</span></span> <span data-ttu-id="b6373-146">Beispielsweise *nach* aufrufen:</span><span class="sxs-lookup"><span data-stu-id="b6373-146">For example, *after* calling:</span></span>

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample9.cmd)]

 <span data-ttu-id="b6373-147">Aufrufe von `app.UseStageMarker` übergeben `Authenticate` oder `PostAuthenticate` nicht berücksichtigt werden, und es wird keine Ausnahme ausgelöst.</span><span class="sxs-lookup"><span data-stu-id="b6373-147">calls to `app.UseStageMarker` passing `Authenticate` or `PostAuthenticate` will not be honored, and no exception will be thrown.</span></span> <span data-ttu-id="b6373-148">Führen Sie in der letzten Phase, dies ist standardmäßig OMCs `PreHandlerExecute`.</span><span class="sxs-lookup"><span data-stu-id="b6373-148">OMCs run at the latest stage, which by default is `PreHandlerExecute`.</span></span> <span data-ttu-id="b6373-149">Phase Marker werden verwendet, damit sie zuvor ausgeführt werden können.</span><span class="sxs-lookup"><span data-stu-id="b6373-149">The stage markers are used to make them to run earlier.</span></span> <span data-ttu-id="b6373-150">Wenn Sie die Phase Marker außerhalb der Reihenfolge angeben, runden wir auf den früheren Marker.</span><span class="sxs-lookup"><span data-stu-id="b6373-150">If you specify stage markers out of order, we round to the earlier marker.</span></span> <span data-ttu-id="b6373-151">Hinzufügen eine phasenmarkierung sagt also "Phase X oder höher ausführen".</span><span class="sxs-lookup"><span data-stu-id="b6373-151">In other words, adding a stage marker says "Run no later than stage X".</span></span> <span data-ttu-id="b6373-152">Bei den frühesten phasenmarkierung hinzugefügt, nachdem sie in der OWIN-Pipeline des OMC-ausführen.</span><span class="sxs-lookup"><span data-stu-id="b6373-152">OMC's run at the earliest stage marker added after them in the OWIN pipeline.</span></span>
4. <span data-ttu-id="b6373-153">Der frühesten Stufe der Aufrufe an `app.UseStageMarker` Wins.</span><span class="sxs-lookup"><span data-stu-id="b6373-153">The earliest stage of calls to `app.UseStageMarker` wins.</span></span> <span data-ttu-id="b6373-154">Angenommen, wenn Sie die Reihenfolge der wechseln `app.UseStageMarker` Aufrufe aus unserer vorherigen Beispiel:</span><span class="sxs-lookup"><span data-stu-id="b6373-154">For example, if you switch the order of `app.UseStageMarker` calls from our previous example:</span></span>

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample10.cs?highlight=13,19)]

 <span data-ttu-id="b6373-155">Das Fenster "Ausgabe" wird angezeigt:</span><span class="sxs-lookup"><span data-stu-id="b6373-155">The output window will display:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample11.cmd)]

 <span data-ttu-id="b6373-156">Die OMCs alle ausgeführt, in der `AuthenticateRequest` bereitstellen, da der letzte OMC registriert die `Authenticate` -Ereignis und die `Authenticate` Ereignis vorangeht, alle anderen Ereignisse.</span><span class="sxs-lookup"><span data-stu-id="b6373-156">The OMCs all run in the `AuthenticateRequest` stage, because the last OMC registered with the `Authenticate` event, and the `Authenticate` event precedes all other events.</span></span>
